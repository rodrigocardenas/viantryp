<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viantryp - Gesti√≥n de Viajes</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --ink: #1f2a44;
            --blue-700: #0ea5e9;
            --blue-600: #38bdf8;
            --blue-300: #93c5fd;
            --blue-100: #e0f2fe;
            --sky-50: #f0f9ff;
            --stone-100: #f5f7fa;
            --stone-300: #e2e8f0;
            --stone-400: #cbd5e1;
            --slate-600: #475569;
            --slate-500: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.06);
            --shadow-hover: 0 14px 40px rgba(0,0,0,0.08);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #e6f3fb 0%, #f7fbff 60%);
            color: var(--ink);
            letter-spacing: 0.1px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--blue-700) 0%, var(--blue-600) 60%, var(--blue-300) 100%);
            padding: 1.25rem 2rem;
            box-shadow: var(--shadow-soft);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .viantryp-logo {
            display: flex;
            align-items: center;
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            text-decoration: none;
        }

        .viantryp-logo i { margin-right: 0.6rem; }

        .new-trip-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-soft);
        }

        .new-trip-btn-search {
            background: var(--blue-700);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            box-shadow: var(--shadow-soft);
        }

        .new-trip-btn-search:hover {
            background: var(--blue-600);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* Navigation */
        .nav-container {
            background: transparent;
            padding: 0 2rem;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .nav-tabs { display: flex; gap: 0.5rem; padding: 0.75rem 0; }

        .nav-tab {
            padding: 10px 14px;
            background: white;
            border: 1px solid var(--stone-300);
            border-radius: 999px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
            color: var(--slate-600);
            box-shadow: var(--shadow-soft);
        }

        .nav-tab:hover { background: var(--sky-50); color: var(--blue-700); }

        .nav-tab.active { color: var(--blue-700); background: var(--blue-100); border-color: transparent; }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .search-section {
            background: white;
            border-radius: var(--radius);
            padding: 1.25rem 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--stone-300);
        }

        .search-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-bar {
            flex: 1;
            display: flex;
            align-items: center;
            background: var(--sky-50);
            border: 1px solid var(--stone-300);
            border-radius: 999px;
            padding: 12px 16px;
            transition: border-color 0.3s ease;
        }

        .search-bar:focus-within { border-color: var(--blue-700); box-shadow: 0 0 0 4px rgba(14,165,233,0.08); }

        .search-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 1rem;
            margin-left: 8px;
        }

        .search-icon { color: var(--slate-500); }

        /* Trips List */
        .trips-container {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--stone-300);
        }

        .trips-header {
            background: var(--sky-50);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--stone-300);
            font-weight: 600;
            color: var(--slate-600);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .select-all-label {
            font-size: 0.9rem;
            color: #64748b;
            cursor: pointer;
        }

        .bulk-actions {
            display: none;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 1.25rem 1.5rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid var(--stone-300);
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            animation: slideDown 0.3s ease-out;
            justify-content: space-between;
            align-items: center;
        }

        .bulk-actions.show {
            display: flex;
        }

        .bulk-actions-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .bulk-actions-count {
            font-weight: 600;
            color: #475569;
            font-size: 1rem;
        }

        .bulk-actions-count i {
            color: #10b981;
            margin-right: 0.5rem;
        }

        .bulk-actions-buttons {
            display: flex;
            gap: 0.5rem;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bulk-action-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-soft);
        }

        .bulk-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .bulk-delete-btn {
            background: #ef4444;
            color: white;
        }

        .bulk-delete-btn:hover {
            background: #dc2626;
        }

        .bulk-duplicate-btn {
            background: var(--blue-700);
            color: white;
        }

        .bulk-duplicate-btn:hover {
            background: #2563eb;
        }

        .bulk-clear-btn {
            background: #94a3b8;
            color: white;
        }

        .bulk-clear-btn:hover {
            background: #4b5563;
        }

        .trip-item {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--stone-300);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .trip-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 1rem;
            cursor: pointer;
        }

        .trip-item:hover { background: var(--sky-50); transform: translateX(2px); }

        .trip-item:last-child {
            border-bottom: none;
        }

        .trip-emoji {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            background: var(--sky-50);
            border-radius: 8px;
            margin-right: 1rem;
        }

        .trip-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 1rem;
            cursor: pointer;
        }

        .trip-info {
            flex: 1;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 1rem;
            align-items: center;
        }

        .trip-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--ink);
        }

        .trip-dates {
            color: var(--slate-500);
            font-size: 0.9rem;
        }

        .trip-duration { color: var(--slate-500);
            font-size: 0.9rem;
        }

        .trip-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-published { background: #e8f8ff; color: var(--blue-700); }

        .status-draft { background: #fff7e6; color: #92400e; }

        .status-sent { background: #e6f3ff; color: #1d4ed8; }

        .status-approved { background: #e8fff5; color: #065f46; }

        .status-completed { background: #eef2f6; color: #374151; }

        .trip-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-soft);
        }

        .btn-primary { background: var(--blue-700); color: white; }

        .btn-primary:hover { background: var(--blue-600); transform: translateY(-1px); box-shadow: var(--shadow-hover); }

        .btn-download-pdf {
            background: linear-gradient(135deg, var(--blue-700) 0%, var(--blue-600) 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-soft);
        }

        .btn-download-pdf:hover { background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%); transform: translateY(-2px); box-shadow: var(--shadow-hover); }

        .btn-download-pdf:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .btn-download-pdf i {
            font-size: 1.1rem;
        }

        .btn-secondary { background: #f1f5f9; color: var(--slate-600); border: 1px solid var(--stone-300); }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-modal-close {
            background: #f8fafc;
            color: var(--slate-500);
            border: 1px solid var(--stone-300);
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-modal-close:hover {
            background: #e2e8f0;
            color: #475569;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 40px;
            justify-content: center;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:active {
            transform: translateY(0);
        }

        .btn-danger i {
            font-size: 0.9rem;
        }

        .status-select {
            padding: 4px 8px;
            border: 1px solid var(--stone-300);
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 400;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 4px center;
            background-repeat: no-repeat;
            background-size: 12px;
            padding-right: 20px;
            color: var(--slate-500);
        }

        .status-select:focus {
            outline: none;
            border-color: var(--blue-700);
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.12);
        }

        .status-select:hover {
            border-color: #cbd5e1;
        }

        /* Estilos espec√≠ficos para cada estado - Dise√±o sutil */
        .status-select[data-status="draft"] {
            border-color: #fbbf24;
            color: #92400e;
        }

        .status-select[data-status="draft"]:focus {
            border-color: #f59e0b;
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.1);
        }

        .status-select[data-status="sent"] {
            border-color: #60a5fa;
            color: #1d4ed8;
        }

        .status-select[data-status="sent"]:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.1);
        }

        .status-select[data-status="approved"] {
            border-color: #34d399;
            color: #065f46;
        }

        .status-select[data-status="approved"]:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.1);
        }

        .status-select[data-status="completed"] {
            border-color: #9ca3af;
            color: #374151;
        }

        .status-select[data-status="completed"]:focus {
            border-color: #6b7280;
            box-shadow: 0 0 0 2px rgba(156, 163, 175, 0.1);
        }

        .status-select option {
            color: #374151;
            background-color: white;
            padding: 4px;
        }

        .status-select option[value="draft"] {
            color: #92400e;
        }

        .status-select option[value="sent"] {
            color: #1d4ed8;
        }

        .status-select option[value="approved"] {
            color: #065f46;
        }

        .status-select option[value="completed"] {
            color: #374151;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--slate-500);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                padding: 0 1rem;
            }

            .logo-container {
                gap: 1rem;
            }

            .viantryp-logo {
                font-size: 1.4rem;
            }

            .nav-content, .main-content {
                padding: 0 1rem;
            }

            .search-container {
                flex-direction: column;
                gap: 1rem;
            }

            .new-trip-btn-search {
                width: 100%;
                justify-content: center;
            }

            .trip-info {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .trip-actions {
                margin-top: 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .action-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .status-select {
                width: 100%;
                margin-top: 0.5rem;
                min-width: 80px;
                font-size: 0.75rem;
            }

            .btn-download-pdf {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .btn-danger {
                padding: 6px 10px;
                font-size: 0.8rem;
                min-width: 35px;
            }

            .nav-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
        }



        /* Responsive */
        @media (max-width: 768px) {
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            color: #333;
            padding: 0;
            border-radius: var(--radius);
            box-shadow: var(--shadow-hover);
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 350px;
            display: none;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-content {
            padding: 1rem;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .notification-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
            padding: 0.2rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .notification-close:hover {
            background: #f1f5f9;
            color: #333;
        }

        .notification-message {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        /* Responsive para notificaci√≥n */
        @media (max-width: 768px) {
            .notification {
                right: 1rem;
                left: 1rem;
                max-width: none;
                transform: translateY(100%);
            }
            
            .notification.show {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-container">
                <a href="viantryp_index.html" class="viantryp-logo">
                    <i class="fas fa-route"></i>
                Viantryp
                </a>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-content">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="filterTrips('all')">Todos los Viajes</button>
                <button class="nav-tab" onclick="filterTrips('draft')">Viajes en Dise√±o</button>
                <button class="nav-tab" onclick="filterTrips('sent')">Propuestas Enviadas</button>
                <button class="nav-tab" onclick="filterTrips('approved')">Viajes Aprobados</button>
                <button class="nav-tab" onclick="filterTrips('completed')">Viajes Pasados</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Search Section -->
        <div class="search-section">
            <div class="search-container">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Buscar viajes..." oninput="searchTrips(this.value)">
                </div>
                <button class="new-trip-btn-search" onclick="createNewTrip()">
                    <span>+</span>
                    Nuevo Viaje
                </button>
            </div>
        </div>

        <!-- Bulk Actions Panel -->
        <div class="bulk-actions" id="bulk-actions">
            <div class="bulk-actions-info">
                <span class="bulk-actions-count">
                    <i class="fas fa-check-circle"></i>
                    <span id="selected-count">0</span> viaje(s) seleccionado(s)
                </span>
            </div>
            <div class="bulk-actions-buttons">
                <button class="bulk-action-btn bulk-duplicate-btn" onclick="duplicateSelectedTrips()">
                    <i class="fas fa-copy"></i>
                    Duplicar
                </button>
                <button class="bulk-action-btn bulk-delete-btn" onclick="deleteSelectedTrips()">
                    <i class="fas fa-trash"></i>
                    Eliminar
                </button>
                <button class="bulk-action-btn bulk-clear-btn" onclick="clearSelection()">
                    <i class="fas fa-times"></i>
                    Limpiar
                </button>
            </div>
        </div>

        <!-- Trips List -->
        <div class="trips-container">
            <div class="trips-header" id="trips-header-title">
                <span>Todos los Viajes</span>
                <div class="select-all-container">
                    <input type="checkbox" id="select-all-checkbox" class="select-all-checkbox" onchange="toggleSelectAll()">
                    <label for="select-all-checkbox" class="select-all-label">Seleccionar todos</label>
                </div>
            </div>
            <div id="trips-list">
                <!-- Trip items will be populated by JavaScript -->
            </div>
        </div>
    </main>

    <!-- Notification System -->
    <div id="notification" class="notification">
        <div class="notification-content">
            <div class="notification-header">
                <span class="notification-title"></span>
                <button class="notification-close" onclick="hideNotification()">√ó</button>
            </div>
            <div class="notification-message" id="notificationMessage"></div>
        </div>
    </div>

    <script>
        // Initialize trips data - Load from localStorage
        let tripsData = [];

        // Load saved trips from localStorage - This function is now defined later with duplicate prevention

        // Format trip dates to DD/MM/YYYY format
        function formatTripDates(startDate, endDate) {
            if (!startDate || !endDate) return 'Sin fecha';
            
            const formatDate = (dateString) => {
                // Create date in local timezone to avoid timezone issues
                const date = new Date(dateString + 'T00:00:00');
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            };
            
            const startFormatted = formatDate(startDate);
            const endFormatted = formatDate(endDate);
            
            return `${startFormatted} - ${endFormatted}`;
        }

        let currentFilter = 'all';
        let currentSearch = '';

        function getStatusEmoji(status) {
            const emojiMap = {
                'draft': '‚úèÔ∏è',
                'sent': 'üì§',
                'approved': '‚úÖ',
                'published': 'üåü',
                'completed': 'üèÅ'
            };
            return emojiMap[status] || 'üìã';
        }

        function getStatusText(status) {
            const statusMap = {
                'draft': 'En Dise√±o',
                'sent': 'Enviada',
                'approved': 'Aprobado',
                'published': 'Publicado',
                'completed': 'Completado'
            };
            return statusMap[status] || status;
        }

        function renderTrips() {
            const tripsList = document.getElementById('trips-list');
            let filteredTrips = tripsData;

            // Apply status filter
            if (currentFilter !== 'all') {
                filteredTrips = filteredTrips.filter(trip => trip.status === currentFilter);
            }

            // Apply search filter
            if (currentSearch) {
                filteredTrips = filteredTrips.filter(trip => 
                    trip.title.toLowerCase().includes(currentSearch.toLowerCase())
                );
            }

            if (filteredTrips.length === 0) {
                tripsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <p>No se encontraron viajes</p>
                    </div>
                `;
                return;
            }

            tripsList.innerHTML = filteredTrips.map(trip => `
                <div class="trip-item" onclick="openTrip(${trip.id})">
                    <input type="checkbox" class="trip-checkbox" data-trip-id="${trip.id}" onclick="event.stopPropagation();" onchange="updateSelectAllState()">
                    <div class="trip-emoji">${getStatusEmoji(trip.status)}</div>
                    <div class="trip-info">
                        <div class="trip-title">${trip.title}</div>
                        <div class="trip-dates">${trip.dates}</div>
                        <div class="trip-duration">${trip.duration}</div>
                        <div>
                            <select class="status-select" data-status="${trip.status}" onclick="event.stopPropagation();" onchange="changeTripStatus(${trip.id}, this.value)">
                                <option value="draft" ${trip.status === 'draft' ? 'selected' : ''}>En Dise√±o</option>
                                <option value="sent" ${trip.status === 'sent' ? 'selected' : ''}>Enviada</option>
                                <option value="approved" ${trip.status === 'approved' ? 'selected' : ''}>Aprobado</option>
                                <option value="completed" ${trip.status === 'completed' ? 'selected' : ''}>Completado</option>
                            </select>
                        </div>
                    </div>
                    <div class="trip-actions">
                        <button class="action-btn btn-primary" onclick="event.stopPropagation(); previewTrip(${trip.id})">
                            Vista Previa
                        </button>
                        <button class="action-btn btn-secondary" onclick="event.stopPropagation(); editTrip(${trip.id})">
                            Editar
                        </button>
                        <button class="action-btn btn-danger" onclick="event.stopPropagation(); deleteTrip(${trip.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filterTrips(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update header title
            const headerTitles = {
                'all': 'Todos los Viajes',
                'draft': 'Viajes en Dise√±o',
                'sent': 'Propuestas Enviadas',
                'approved': 'Viajes Aprobados',
                'completed': 'Viajes Pasados'
            };
            
            const headerElement = document.getElementById('trips-header-title');
            headerElement.innerHTML = `
                <span>${headerTitles[filter]}</span>
                <div class="select-all-container">
                    <input type="checkbox" id="select-all-checkbox" class="select-all-checkbox" onchange="toggleSelectAll()">
                    <label for="select-all-checkbox" class="select-all-label">Seleccionar todos</label>
                </div>
            `;
            
            // Reset bulk actions visibility when changing filters
            updateBulkActionsVisibility();
            
            renderTrips();
        }

        function searchTrips(query) {
            currentSearch = query;
            renderTrips();
        }

        function createNewTrip() {
            // Redirigir al editor de itinerarios
            showNotification('Creando Nuevo Viaje', 'Redirigiendo al editor de itinerarios...');
            setTimeout(() => {
                // Create a new trip ID and redirect to editor
                const newTripId = Date.now();
                window.location.href = `viantryp_editor.html?trip=${newTripId}&mode=new`;
            }, 1000);
        }

        function previewTrip(tripId) {
            // Open preview in new tab
            const previewUrl = `viantryp_preview.html?trip=${tripId}&mode=preview`;
            window.open(previewUrl, '_blank');
        }

        function openTrip(tripId) {
            // Abrir el viaje en el editor
            const trip = tripsData.find(t => t.id === tripId);
            if (trip) {
                showNotification('Abriendo Viaje', `Abriendo "${trip.title}" en el editor...`);
                setTimeout(() => {
                    window.location.href = `viantryp_editor.html?trip=${tripId}&mode=edit`;
                }, 1000);
            }
        }

        function editTrip(tripId) {
            // Editar el viaje en el editor
            const trip = tripsData.find(t => t.id === tripId);
            if (trip) {
                showNotification('Editando Viaje', `Editando "${trip.title}"...`);
                setTimeout(() => {
                    window.location.href = `viantryp_editor.html?trip=${tripId}&mode=edit`;
                }, 1000);
            }
        }

        function changeTripStatus(tripId, newStatus) {
            const trip = tripsData.find(t => t.id === tripId);
            if (trip) {
                const oldStatus = trip.status;
                trip.status = newStatus;
                
                // Update localStorage if it's a saved trip
                try {
                    const savedTrips = JSON.parse(localStorage.getItem('viantryp_trips') || '[]');
                    const tripIndex = savedTrips.findIndex(t => t.id === tripId);
                    if (tripIndex !== -1) {
                        savedTrips[tripIndex].status = newStatus;
                        localStorage.setItem('viantryp_trips', JSON.stringify(savedTrips));
                    }
                } catch (error) {
                    console.error('Error updating localStorage:', error);
                }
                
                // Actualizar el atributo data-status del selector
                const selectElement = document.querySelector(`select[onchange*="${tripId}"]`);
                if (selectElement) {
                    selectElement.setAttribute('data-status', newStatus);
                }
                
                // Mostrar notificaci√≥n de cambio de estado
                const statusText = {
                    'draft': 'En Dise√±o',
                    'sent': 'Enviada',
                    'approved': 'Aprobado',
                    'completed': 'Completado'
                };
                
                showNotification('Estado Actualizado', `El viaje "${trip.title}" ha cambiado a "${statusText[newStatus]}".`);
                
                renderTrips(); // Re-render to update the select dropdown
            }
        }

        function deleteTrip(tripId) {
            const trip = tripsData.find(t => t.id === tripId);
            if (!trip) return;
            
            if (confirm(`¬øEst√°s seguro de que quieres eliminar "${trip.title}"?`)) {
                // Remove from tripsData array
                tripsData = tripsData.filter(t => t.id !== tripId);
                
                // Remove from localStorage if it's a saved trip
                try {
                    const savedTrips = JSON.parse(localStorage.getItem('viantryp_trips') || '[]');
                    const updatedSavedTrips = savedTrips.filter(t => t.id !== tripId);
                    localStorage.setItem('viantryp_trips', JSON.stringify(updatedSavedTrips));
                } catch (error) {
                    console.error('Error removing from localStorage:', error);
                }
                
                renderTrips();
                
                // Mostrar notificaci√≥n de √©xito
                showNotification('Viaje Eliminado', `El viaje "${trip.title}" ha sido eliminado exitosamente.`);
            }
        }

        // Notification functions
        function showNotification(title, message) {
            const notification = document.getElementById('notification');
            const notificationTitle = notification.querySelector('.notification-title');
            const notificationMessage = document.getElementById('notificationMessage');
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notification.style.display = 'block';
            notification.offsetHeight; // Force reflow
            notification.classList.add('show');
            setTimeout(() => {
                hideNotification();
            }, 4000);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
            setTimeout(() => {
                notification.style.display = 'none';
            }, 300);
        }

        // Selection functions
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const tripCheckboxes = document.querySelectorAll('.trip-checkbox');
            
            tripCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateBulkActionsVisibility();
        }

        function updateSelectAllState() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const tripCheckboxes = document.querySelectorAll('.trip-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.trip-checkbox:checked');
            
            if (checkedCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length === tripCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
            
            updateBulkActionsVisibility();
        }

        function updateBulkActionsVisibility() {
            const bulkActions = document.getElementById('bulk-actions');
            const selectedCountElement = document.getElementById('selected-count');
            const checkedCheckboxes = document.querySelectorAll('.trip-checkbox:checked');
            
            if (checkedCheckboxes.length > 0) {
                bulkActions.classList.add('show');
                selectedCountElement.textContent = checkedCheckboxes.length;
            } else {
                bulkActions.classList.remove('show');
                selectedCountElement.textContent = '0';
            }
        }

        function getSelectedTrips() {
            const selectedCheckboxes = document.querySelectorAll('.trip-checkbox:checked');
            return Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.dataset.tripId));
        }

        function clearSelection() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const tripCheckboxes = document.querySelectorAll('.trip-checkbox');
            
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            
            tripCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            updateBulkActionsVisibility();
        }

        function deleteSelectedTrips() {
            const selectedTripIds = getSelectedTrips();
            
            if (selectedTripIds.length === 0) {
                showNotification('Sin Selecci√≥n', 'Por favor selecciona al menos un viaje para eliminar.');
                return;
            }
            
            const tripNames = selectedTripIds.map(id => {
                const trip = tripsData.find(t => t.id === id);
                return trip ? trip.title : `Viaje ${id}`;
            }).join(', ');
            
            const message = selectedTripIds.length === 1 
                ? `¬øEst√°s seguro de que quieres eliminar "${tripNames}"?`
                : `¬øEst√°s seguro de que quieres eliminar ${selectedTripIds.length} viajes seleccionados?`;
            
            if (confirm(message)) {
                // Remove from tripsData array
                tripsData = tripsData.filter(trip => !selectedTripIds.includes(trip.id));
                
                // Remove from localStorage if they are saved trips
                try {
                    const savedTrips = JSON.parse(localStorage.getItem('viantryp_trips') || '[]');
                    const updatedSavedTrips = savedTrips.filter(trip => !selectedTripIds.includes(trip.id));
                    localStorage.setItem('viantryp_trips', JSON.stringify(updatedSavedTrips));
                } catch (error) {
                    console.error('Error removing from localStorage:', error);
                }
                
                renderTrips();
                clearSelection();
                
                const successMessage = selectedTripIds.length === 1 
                    ? `El viaje "${tripNames}" ha sido eliminado exitosamente.`
                    : `${selectedTripIds.length} viajes han sido eliminados exitosamente.`;
                
                showNotification('Viajes Eliminados', successMessage);
            }
        }

        function duplicateSelectedTrips() {
            const selectedTripIds = getSelectedTrips();
            
            if (selectedTripIds.length === 0) {
                showNotification('Sin Selecci√≥n', 'Por favor selecciona al menos un viaje para duplicar.');
                return;
            }
            
            let duplicatedCount = 0;
            
            selectedTripIds.forEach(tripId => {
                const originalTrip = tripsData.find(t => t.id === tripId);
                if (originalTrip) {
                    // Create a new trip with a unique ID
                    const newTripId = Math.max(...tripsData.map(t => t.id), 0) + 1 + duplicatedCount;
                    const duplicatedTrip = {
                        ...originalTrip,
                        id: newTripId,
                        title: `${originalTrip.title} (Copia)`,
                        status: 'draft' // Always set duplicated trips as draft
                    };
                    
                    // Add to tripsData
                    tripsData.unshift(duplicatedTrip);
                    
                    // If it's a saved trip, also save the duplicate to localStorage
                    try {
                        const savedTrips = JSON.parse(localStorage.getItem('viantryp_trips') || '[]');
                        const originalSavedTrip = savedTrips.find(t => t.id === tripId);
                        if (originalSavedTrip) {
                            const duplicatedSavedTrip = {
                                ...originalSavedTrip,
                                id: newTripId,
                                title: `${originalSavedTrip.title} (Copia)`,
                                status: 'draft'
                            };
                            savedTrips.unshift(duplicatedSavedTrip);
                            localStorage.setItem('viantryp_trips', JSON.stringify(savedTrips));
                        }
                    } catch (error) {
                        console.error('Error saving duplicate to localStorage:', error);
                    }
                    
                    duplicatedCount++;
                }
            });
            
            renderTrips();
            clearSelection();
            
            const successMessage = selectedTripIds.length === 1 
                ? 'El viaje ha sido duplicado exitosamente.'
                : `${selectedTripIds.length} viajes han sido duplicados exitosamente.`;
            
            showNotification('Viajes Duplicados', successMessage);
        }

        // Enhanced loadSavedTrips function with better error handling and data validation
        function loadSavedTrips() {
            try {
                console.log('Loading saved trips from localStorage...');
                const savedTrips = JSON.parse(localStorage.getItem('viantryp_trips') || '[]');
                console.log('Found saved trips:', savedTrips);
                
                if (savedTrips.length > 0) {
                    // Format dates for saved trips and validate data
                    const formattedSavedTrips = savedTrips
                        .filter(trip => trip && trip.id && trip.title) // Filter out invalid trips
                        .map(trip => ({
                            ...trip,
                            dates: formatTripDates(trip.startDate, trip.endDate),
                            // Ensure all required fields are present
                            title: trip.title || 'Viaje sin t√≠tulo',
                            status: trip.status || 'draft',
                            duration: trip.duration || 'Sin duraci√≥n',
                            createdAt: trip.createdAt || new Date().toISOString(),
                            updatedAt: trip.updatedAt || new Date().toISOString()
                        }));
                    
                    // Replace tripsData with saved trips (no duplicates needed since we're loading fresh)
                    tripsData = formattedSavedTrips;
                    console.log('Loaded trips:', tripsData);
                } else {
                    console.log('No saved trips found in localStorage');
                    tripsData = [];
                }
            } catch (error) {
                console.error('Error loading saved trips:', error);
                // If there's an error, try to recover from backup
                try {
                    const backupTrips = [];
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.startsWith('viantryp_trip_backup_')) {
                            try {
                                const backupData = JSON.parse(localStorage.getItem(key));
                                if (backupData && backupData.trip) {
                                    backupTrips.push(backupData.trip);
                                }
                            } catch (e) {
                                console.warn('Error parsing backup data for key:', key);
                            }
                        }
                    });
                    
                    if (backupTrips.length > 0) {
                        console.log('Recovering from backup trips:', backupTrips);
                        tripsData = backupTrips.map(trip => ({
                            ...trip,
                            dates: formatTripDates(trip.startDate, trip.endDate),
                            title: trip.title || 'Viaje recuperado',
                            status: trip.status || 'draft',
                            duration: trip.duration || 'Sin duraci√≥n'
                        }));
                    } else {
                        tripsData = [];
                    }
                } catch (backupError) {
                    console.error('Error recovering from backup:', backupError);
                    tripsData = [];
                }
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            loadSavedTrips(); // Load saved trips on page load
            renderTrips();
            
            // Add event listener for page visibility changes to refresh data
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    console.log('Page became visible, refreshing data...');
                    loadSavedTrips();
                    renderTrips();
                }
            });
            
            // Add event listener for storage changes (when data is saved from editor)
            window.addEventListener('storage', function(e) {
                if (e.key === 'viantryp_trips') {
                    console.log('Storage changed, refreshing data...');
                    loadSavedTrips();
                    renderTrips();
                }
            });
        });
    </script>
</body>
</html>