<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viantryp - Editor de Itinerarios</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-dark: #1f2a44;
            --primary-blue: #0ea5e9;
            --light-gray: #F6F9FC;
            --white: #FFFFFF;
            --coral: #FF6B6B;
            --mint: #22c55e;
            --shadow: rgba(0, 0, 0, 0.08);
            --overlay: rgba(0, 0, 0, 0.5);
            --border-gray: #e2e8f0;
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.06);
            --shadow-hover: 0 14px 40px rgba(0,0,0,0.08);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(180deg, #e6f3fb 0%, #f7fbff 60%);
            color: var(--primary-dark);
            height: 100vh;
            overflow: hidden;
            letter-spacing: 0.1px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 60%, #93c5fd 100%);
            box-shadow: var(--shadow-soft);
            z-index: 1000;
            transition: all 0.3s ease;
            color: white;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 10px;
        }

        .logo:hover { background: rgba(255,255,255,0.15); transform: translateY(-1px); }

        .logo i { color: #ffffff; }

        .btn-back {
            background: var(--light-gray);
            color: var(--primary-dark);
            border: 1px solid var(--border-gray);
            padding: 0.75rem 1.5rem;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.9rem;
            box-shadow: var(--shadow-soft);
        }

        .btn-back:hover { background: var(--primary-blue); color: white; border-color: var(--primary-blue); transform: translateY(-1px); box-shadow: var(--shadow-hover); }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-profile {
            display: none; /* Oculto temporalmente */
            align-items: center;
            gap: 1rem;
        }

        .profile-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-soft);
        }

        .profile-btn:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow-hover); }

        /* Main Content */
        .main-content {
            height: calc(100vh - 80px);
            overflow: hidden;
        }

        /* Editor Page */
        .editor-container {
            display: flex;
            height: 100%;
        }

        .sidebar { width: 300px; background: white; border-right: 1px solid var(--border-gray); padding: 1.5rem; overflow-y: auto; }

        .sidebar h3 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .elements-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .draggable-element {
            background: var(--light-gray);
            padding: 1rem;
            border-radius: 12px;
            cursor: grab;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: var(--shadow-soft);
        }

        .draggable-element:hover {
            background: rgba(74, 144, 226, 0.1);
            border-color: var(--primary-blue);
            transform: translateX(5px);
        }

        .draggable-element:active {
            cursor: grabbing;
            transform: rotate(5deg) scale(1.05);
        }

        .element-icon {
            font-size: 1.2rem;
            width: 30px;
            text-align: center;
        }

        .element-icon.flight { color: var(--primary-blue); }
        .element-icon.hotel { color: var(--coral); }
        .element-icon.activity { color: var(--mint); }
        .element-icon.transport { color: #9b59b6; }
        .element-icon.note { color: #f39c12; }
        .element-icon.summary { color: #059669; }
        .element-icon.total { color: #e74c3c; }
        
        /* Special styles for summary and total elements to indicate they're clickable */
        .draggable-element[data-type="summary"],
        .draggable-element[data-type="total"] {
            cursor: pointer;
            position: relative;
        }
        
        .draggable-element[data-type="summary"]:hover,
        .draggable-element[data-type="total"]:hover {
            background: rgba(5, 150, 105, 0.1);
            border-color: #059669;
            transform: translateX(5px);
        }
        
        .draggable-element[data-type="summary"]:active,
        .draggable-element[data-type="total"]:active {
            cursor: pointer;
            transform: scale(1.02);
        }
        
        .draggable-element[data-type="total"]:hover {
            background: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c;
        }
        


        .timeline-area { flex: 1; padding: 2rem; background: #f8fbfe; overflow-y: auto; }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .timeline-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .trip-title-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-dark);
            font-family: 'Inter', sans-serif;
            padding: 0.2rem 0;
            margin-left: 0.5rem;
            transition: all 0.3s ease;
            min-width: 300px;
        }
        
        .trip-title-input:focus {
            outline: none;
            border-bottom-color: var(--primary-blue);
            background: rgba(74, 144, 226, 0.05);
            border-radius: 4px;
            padding: 0.2rem 0.5rem;
        }
        
        .trip-title-input:hover {
            border-bottom-color: var(--primary-blue);
            background: rgba(74, 144, 226, 0.02);
        }

        .timeline-actions {
            display: flex;
            gap: 1rem;
        }

        /* Date Selector */
        .date-selector-container { background: white; border-radius: var(--radius); padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-soft); border: 1px solid var(--border-gray); }

        .date-selector-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .date-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .date-input { padding: 0.5rem 1rem; border: 1px solid var(--border-gray); border-radius: 12px; font-size: 1rem; transition: border-color 0.3s ease; }

        .date-input:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 4px rgba(14,165,233,0.12); }

        .btn { padding: 0.5rem 1rem; border: none; border-radius: 999px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; box-shadow: var(--shadow-soft); }

        .btn-primary { background: var(--primary-blue); color: white; }

        .btn-success { background: var(--mint); color: white; }



        .btn-coral { background: var(--coral); color: white; }

        .btn-secondary { background: #6c757d; color: white; }

        .btn-add-day { background: var(--mint); color: white; border: 2px dashed transparent; padding: 1rem 2rem; margin-top: 1rem; width: 100%; font-size: 1.1rem; transition: all 0.3s ease; border-radius: 999px; }

        .btn-add-day:hover {
            background: transparent;
            color: var(--mint);
            border-color: var(--mint);
            transform: translateY(-2px);
        }

        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }



        .timeline {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .day-container {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-soft);
            border: 2px dashed transparent;
            transition: all 0.3s ease;
            min-height: 150px;
            position: relative;
        }

        .day-container.drag-over {
            border-color: var(--primary-blue);
            background: rgba(74, 144, 226, 0.05);
            transform: scale(1.02);
        }

        .day-header {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-gray);
        }

        .day-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 0.3rem;
        }

        .day-date {
            color: var(--primary-blue);
            font-weight: 500;
            text-align: left;
            margin-left: 0;
            padding-left: 0;
        }

        .day-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .day-container:hover .day-actions {
            opacity: 1;
        }

        .day-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            padding: 0.3rem 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            color: #666;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .day-btn:hover {
            background: var(--coral);
            color: white;
            border-color: var(--coral);
        }

        .day-items {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 80px;
        }

        .timeline-item {
            background: var(--light-gray);
            padding: 1rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary-blue);
            animation: slideInRight 0.5s ease;
        }
        
        .timeline-item:hover {
            background: white;
            box-shadow: 0 3px 15px var(--shadow);
            transform: translateX(5px);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .timeline-item:hover {
            background: white;
            box-shadow: 0 3px 15px var(--shadow);
            transform: translateX(5px);
        }

        .timeline-item.flight { border-left-color: var(--primary-blue); }
        .timeline-item.hotel { border-left-color: var(--coral); }
        .timeline-item.activity { border-left-color: var(--mint); }
        .timeline-item.transport { border-left-color: #9b59b6; }
        .timeline-item.note { border-left-color: #f39c12; }
        .timeline-item.summary { 
            border-left-color: #059669; 
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border: 2px solid #059669;
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.15);
        }
        .timeline-item.total { 
            border-left-color: #e74c3c; 
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            border: 2px solid #e74c3c;
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.15);
        }

        /* Special styling when summary is at the top of timeline */
        #timeline > .timeline-item.summary {
            margin: 0 0 2rem 0;
            padding: 1.5rem;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #059669;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.2);
        }

        .timeline-item.summary .item-title {
            color: #059669;
            font-weight: 700;
        }

        .summary-update-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 0.5rem;
        }

        .summary-update-btn:hover {
            background: #047857;
            transform: translateY(-1px);
        }

        .item-info {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .item-description {
            font-size: 0.9rem;
            color: #666;
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .item-btn {
            background: none;
            border: none;
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            color: #666;
            transition: all 0.3s ease;
        }

        .item-btn:hover {
            background: var(--primary-blue);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--coral);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--primary-dark);
        }
        
        .form-label.error {
            color: #e74c3c;
        }
        
        .form-control.error {
            border-color: #e74c3c;
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);
        }
        
        .form-control.error:focus {
            border-color: #e74c3c;
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.3);
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
            accent-color: var(--primary-blue);
        }
        
        .form-text {
            display: block;
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
            font-style: italic;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        /* Trip Name Modal Specific Styles */
        #tripNameModal .modal-content {
            text-align: center;
        }

        #tripNameModal .modal-body {
            padding: 1rem 0;
        }

        #newTripName:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        #newTripName.error {
            border-color: var(--coral);
        }

        .trip-name-welcome {
            margin-bottom: 2rem;
        }

        .trip-name-icon {
            font-size: 3rem;
            color: var(--primary-blue);
            margin-bottom: 1rem;
            display: block;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        .image-upload-container {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .image-upload-box {
            flex: 1;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .image-upload-box:hover {
            border-color: var(--primary-blue);
            background: rgba(74, 144, 226, 0.05);
        }
        
        .image-upload-box.has-image {
            border-style: solid;
            border-color: var(--mint);
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 100px;
            border-radius: 5px;
            margin-top: 0.5rem;
        }
        
        .image-upload-text {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .image-upload-icon {
            font-size: 2rem;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--coral);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
            display: none;
        }
        
        .image-upload-box.has-image .remove-image {
            display: block;
        }
        
        /* PDF Preview Styles */
        .pdf-preview-header {
            background: #1E2A38;
            color: white;
            padding: 1rem;
            border-radius: 8px 8px 0 0;
            margin-bottom: 1rem;
        }
        
        .pdf-preview-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .pdf-preview-subtitle {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        .pdf-preview-day {
            background: #f5f7fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #4A90E2;
        }
        
        .pdf-preview-day-header {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .pdf-preview-day-title {
            font-weight: bold;
            color: #1E2A38;
            margin-bottom: 0.3rem;
        }
        
        .pdf-preview-day-date {
            color: #4A90E2;
            font-size: 0.9rem;
            text-align: left;
            margin-left: 0;
            padding-left: 0;
        }
        
        .pdf-preview-item {
            background: white;
            border-radius: 6px;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
            border-left: 3px solid #4A90E2;
        }
        
        .pdf-preview-item.flight { border-left-color: #4A90E2; }
        .pdf-preview-item.hotel { border-left-color: #FF6B6B; }
        .pdf-preview-item.activity { border-left-color: #2ECC71; }
        .pdf-preview-item.transport { border-left-color: #9b59b6; }
        .pdf-preview-item.note { border-left-color: #f39c12; }
        
        .pdf-preview-item-header {
            background: #4A90E2;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: inline-block;
        }
        
        .pdf-preview-item.flight .pdf-preview-item-header { background: #4A90E2; }
        .pdf-preview-item.hotel .pdf-preview-item-header { background: #FF6B6B; }
        .pdf-preview-item.activity .pdf-preview-item-header { background: #2ECC71; }
        .pdf-preview-item.transport .pdf-preview-item-header { background: #9b59b6; }
        .pdf-preview-item.note .pdf-preview-item-header { background: #f39c12; }
        
        .pdf-preview-item-title {
            font-weight: bold;
            color: #1E2A38;
            margin-bottom: 0.3rem;
        }
        
        .pdf-preview-item-details {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-col {
            flex: 1;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e0e0;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 100px;
            right: 2rem;
            background: var(--mint);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(46, 204, 113, 0.3);
            z-index: 3000;
            transform: translateX(100%);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 1rem;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .notification-close:hover {
            opacity: 1;
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Autocomplete styles */
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }
        
        .autocomplete-item:hover {
            background-color: #f0f8ff !important;
        }
        
        .autocomplete-item.selected {
            background-color: #e3f2fd !important;
        }
        
        .autocomplete-item {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .editor-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 200px;
            }

            .timeline-area {
                height: calc(100vh - 280px);
            }

            .form-row {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }

            .nav-container {
                padding: 0.75rem 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .logo {
                font-size: 1.5rem;
            }

            .nav-actions {
                gap: 0.5rem;
                flex-wrap: wrap;
            }

            .btn-back {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }

            .date-input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .notification {
                right: 1rem;
                left: 1rem;
                max-width: none;
                transform: translateY(100%);
            }
            
            .notification.show {
                transform: translateY(0);
            }
            
            .trip-title-input {
                min-width: 200px;
                font-size: 1.2rem;
                margin-left: 0.3rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <a href="#" class="logo" title="Volver al inicio" onclick="confirmExit(() => window.location.href = 'viantryp_index.html')">
                <i class="fas fa-route"></i>
                Viantryp
            </a>
            <div class="nav-actions">
                <a href="#" class="btn-back" onclick="confirmExit(() => window.location.href = 'viantryp_index.html')">
                    <i class="fas fa-arrow-left"></i>
                    Volver
                </a>
                <button class="btn btn-primary" onclick="manualSave()">
                    <i class="fas fa-save"></i>
                    Guardar
                </button>
                <button class="btn btn-coral" onclick="previewItinerary()">
                    <i class="fas fa-eye"></i>
                    Vista Previa
                </button>
                <button class="btn btn-success" onclick="downloadPDF()" style="cursor: pointer;">
                    <i class="fas fa-file-pdf"></i>
                    Descarga versión PDF
                </button>
                <div class="user-profile">
                    <button class="profile-btn">
                        <i class="fas fa-user"></i>
                        María García
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="editor-container">
            <aside class="sidebar">
                <h3><i class="fas fa-puzzle-piece"></i> Elementos</h3>
                <div class="elements-list">
                    <div class="draggable-element" draggable="true" data-type="flight">
                        <i class="fas fa-plane element-icon flight"></i>
                        <div>
                            <strong>Vuelo</strong>
                            <div style="font-size: 0.8rem; color: #666;">Agregar vuelo</div>
                        </div>
                    </div>
                    <div class="draggable-element" draggable="true" data-type="transport">
                        <i class="fas fa-car element-icon transport"></i>
                        <div>
                            <strong>Traslado</strong>
                            <div style="font-size: 0.8rem; color: #666;">Tren, autobús, barco, taxi, van</div>
                        </div>
                    </div>
                    <div class="draggable-element" draggable="true" data-type="hotel">
                        <i class="fas fa-bed element-icon hotel"></i>
                        <div>
                            <strong>Alojamiento</strong>
                            <div style="font-size: 0.8rem; color: #666;">Hotel o hospedaje</div>
                        </div>
                    </div>
                    <div class="draggable-element" draggable="true" data-type="activity">
                        <i class="fas fa-map-marker-alt element-icon activity"></i>
                        <div>
                            <strong>Actividad</strong>
                            <div style="font-size: 0.8rem; color: #666;">Tour o experiencia</div>
                        </div>
                    </div>
                    <div class="draggable-element" draggable="true" data-type="summary">
                        <i class="fas fa-clipboard-list element-icon summary"></i>
                        <div>
                            <strong>Resumen de Itinerario</strong>
                            <div style="font-size: 0.8rem; color: #666;">Resumen automático del viaje</div>
                        </div>
                    </div>
                    <div class="draggable-element" draggable="true" data-type="total">
                        <i class="fas fa-dollar-sign element-icon total"></i>
                        <div>
                            <strong>Valor Total</strong>
                            <div style="font-size: 0.8rem; color: #666;">Precio total del viaje</div>
                        </div>
                    </div>
                    <div class="draggable-element" draggable="true" data-type="note">
                        <i class="fas fa-sticky-note element-icon note"></i>
                        <div>
                            <strong>Nota</strong>
                            <div style="font-size: 0.8rem; color: #666;">Información adicional</div>
                        </div>
                    </div>
                </div>
            </aside>

            <div class="timeline-area">
                <div class="timeline-header">
                    <h2 class="timeline-title">
                        <i class="fas fa-plane"></i>
                        <input type="text" id="tripTitle" value="" class="trip-title-input" placeholder="Nombre o Título del Viaje">
                    </h2>
                </div>

                <!-- Date Selector -->
                <div class="date-selector-container">
                    <div class="date-selector-header">
                        <h3><i class="fas fa-calendar-plus"></i> Información de Itinerario</h3>
                    </div>
                    <div class="date-input-group">
                        <label for="startDate" class="form-label">Fecha de inicio:</label>
                        <input type="date" id="startDate" class="date-input">
                        <button class="btn btn-primary" onclick="updateItineraryDates()">
                            <i class="fas fa-refresh"></i>
                            Actualizar fechas
                        </button>
                    </div>
                </div>

                <div class="timeline" id="timeline">
                    <div class="day-container" data-day="1">
                        <div class="day-actions">
                            <button class="day-btn" onclick="deleteDay(this)">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                        <div class="day-header">
                            <div class="day-title">Día 1</div>
                            <div class="day-date" data-date="">Selecciona fecha de inicio</div>
                        </div>
                        <div class="day-items">
                            <div style="text-align: center; padding: 2rem; color: #666; font-style: italic;">
                                <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 1rem; display: block; color: var(--primary-blue);"></i>
                                Arrastra elementos aquí para personalizar este día
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Day Button -->
                <button class="btn-add-day" onclick="addNewDay()">
                    <i class="fas fa-plus"></i>
                    Agregar día al itinerario
                </button>
            </div>
        </div>
    </main>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-edit"></i>
                    <span id="modalTitle">Editar elemento</span>
                </h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveChanges()">Guardar cambios</button>
            </div>
        </div>
    </div>

    <!-- Notification - Hidden -->
    <div id="notification" class="notification" style="display: none;">
        
        <div>
            <i class="fas fa-check-circle" style="font-size: 1.5rem;"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">¡Cambios guardados!</div>
            <div id="notificationMessage">Los cambios se han aplicado correctamente</div>
        </div>
        <button class="notification-close" onclick="hideNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-pdf"></i>
                    Vista Previa del PDF
                </h3>
                <button class="modal-close" onclick="closePDFPreview()">&times;</button>
            </div>
            <div id="pdfPreviewContent" style="background: white; padding: 2rem; border-radius: 8px; max-height: 60vh; overflow-y: auto;">
                <!-- PDF preview content will be inserted here -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePDFPreview()">Cerrar</button>
                <button class="btn btn-success" onclick="downloadPDFFromPreview()">
                    <i class="fas fa-download"></i>
                    Descargar PDF
                </button>
            </div>
        </div>
    </div>

                <!-- Trip Name Modal -->
            <div id="tripNameModal" class="modal">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-map-marked-alt"></i>
                            <span>Nuevo Viaje</span>
                        </h3>
                        <button class="modal-close" onclick="closeTripNameModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div style="font-size: 3rem; color: var(--primary-blue); margin-bottom: 1rem;">
                                <i class="fas fa-plane"></i>
                            </div>
                            <h4 style="color: var(--primary-dark); margin-bottom: 0.5rem;">¡Bienvenido a tu nuevo viaje!</h4>
                            <p style="color: var(--text-gray); font-size: 0.9rem;">Dale un nombre especial a tu aventura</p>
                        </div>
                        <div class="form-group">
                            <label for="newTripName" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--primary-dark);">
                                Nombre del viaje
                            </label>
                            <input 
                                type="text" 
                                id="newTripName" 
                                placeholder="Ej: Aventura en París, Vacaciones en la playa..."
                                style="width: 100%; padding: 1rem; border: 2px solid #E0E0E0; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s ease;"
                                onkeypress="handleTripNameKeyPress(event)"
                            >
                            <div id="tripNameError" style="color: var(--coral); font-size: 0.8rem; margin-top: 0.5rem; display: none;">
                                Por favor ingresa un nombre para tu viaje
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closeTripNameModal()">Cancelar</button>
                        <button class="btn btn-primary" onclick="createTripWithName()">
                            <i class="fas fa-check"></i>
                            Crear Viaje
                        </button>
                    </div>
                </div>
            </div>

            <!-- Save Changes Modal -->
            <div id="saveChangesModal" class="modal">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-save"></i>
                            <span>Guardar Cambios</span>
                        </h3>
                        <button class="modal-close" onclick="closeSaveChangesModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div style="font-size: 3rem; color: var(--primary-blue); margin-bottom: 1rem;">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <h4 style="color: var(--primary-dark); margin-bottom: 0.5rem;">¿Deseas guardar los cambios?</h4>
                            <p style="color: var(--text-gray); font-size: 0.9rem;">Tienes cambios sin guardar. Al salir volverás al index principal.</p>
                        </div>
                        <div class="changes-summary" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h5 style="margin: 0 0 0.5rem 0; color: var(--primary-dark);">
                                <i class="fas fa-list"></i> Resumen de cambios:
                            </h5>
                            <div id="changesSummary" style="font-size: 0.9rem; color: var(--text-gray);">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="exitWithoutSaving()">
                            <i class="fas fa-times"></i>
                            Salir sin guardar
                        </button>
                        <button class="btn btn-primary" onclick="saveAndExit()">
                            <i class="fas fa-save"></i>
                            Guardar y volver al index
                        </button>
                                </div>
        </div>
    </div>

    <!-- Total Position Modal -->


    <script>
        // State management
        let draggedElement = null;
        let itemCounter = 0; // Start from 0 for new trips
        let dayCounter = 1; // Start from 1 for new trips
        let currentEditingItem = null;
        let startDate = null;
        
        let itemsData = {}; // Empty object for new trips

        // Global list of airlines for autocomplete
        const airlinesList = [
            'Aer Lingus', 'Aeroflot', 'Aerolíneas Argentinas', 'Aeroméxico', 'Air Canada', 'Air China', 'Air France', 
            'Air India', 'Air New Zealand', 'Air Serbia', 'Air Tahiti Nui', 'Air Transat', 'AirAsia', 'AirAsia X', 
            'AirBaltic', 'Airbus', 'Aircalin', 'Alaska Airlines', 'Alitalia', 'All Nippon Airways (ANA)', 
            'American Airlines', 'Asiana Airlines', 'Austrian Airlines', 'Avianca', 'Bangkok Airways', 'British Airways', 
            'Brussels Airlines', 'Cathay Pacific', 'China Airlines', 'China Eastern Airlines', 'China Southern Airlines', 
            'Copa Airlines', 'Croatia Airlines', 'Delta Air Lines', 'EasyJet', 'EgyptAir', 'El Al', 'Emirates', 
            'Ethiopian Airlines', 'Etihad Airways', 'EVA Air', 'Finnair', 'Flydubai', 'Frontier Airlines', 'Garuda Indonesia', 
            'Gulf Air', 'Hainan Airlines', 'Hawaiian Airlines', 'Iberia', 'Icelandair', 'IndiGo', 'Japan Airlines', 
            'JetBlue Airways', 'Jetstar', 'Kenya Airways', 'KLM Royal Dutch Airlines', 'Korean Air', 'LATAM Airlines', 
            'Lion Air', 'LOT Polish Airlines', 'Lufthansa', 'Malaysia Airlines', 'Mango', 'Norwegian Air Shuttle', 
            'Pakistan International Airlines', 'Pegasus Airlines', 'Philippine Airlines', 'Qantas', 'Qatar Airways', 
            'Royal Air Maroc', 'Royal Brunei Airlines', 'Royal Jordanian', 'S7 Airlines', 'SAS Scandinavian Airlines', 
            'Saudi Arabian Airlines', 'Singapore Airlines', 'South African Airways', 'Southwest Airlines', 'Spirit Airlines', 
            'SriLankan Airlines', 'Swiss International Air Lines', 'TAP Air Portugal', 'Thai Airways', 'Turkish Airlines', 
            'United Airlines', 'US Airways', 'Vietnam Airlines', 'Virgin Atlantic', 'Virgin Australia', 'WestJet', 
            'Wizz Air', 'XiamenAir', 'Air Europa', 'Vueling', 'Ryanair', 'Norwegian', 'Jet2', 'TUI Airways', 
            'Thomas Cook Airlines', 'Condor', 'Eurowings', 'Air Berlin', 'Monarch Airlines', 'Flybe', 'bmi', 
            'Aer Arann', 'CityJet', 'Stobart Air', 'Blue Air', 'Tarom', 'Air Moldova', 'Belavia', 'Ukraine International Airlines', 
            'Aeroflot', 'S7 Airlines', 'Ural Airlines', 'Rossiya Airlines', 'Red Wings Airlines', 'Yamal Airlines', 
            'Nordwind Airlines', 'Azur Air', 'Pobeda', 'S7 Airlines', 'Ural Airlines', 'Rossiya Airlines', 
            'Red Wings Airlines', 'Yamal Airlines', 'Nordwind Airlines', 'Azur Air', 'Pobeda', 'S7 Airlines', 
            'Ural Airlines', 'Rossiya Airlines', 'Red Wings Airlines', 'Yamal Airlines', 'Nordwind Airlines', 
            'Azur Air', 'Pobeda', 'S7 Airlines', 'Ural Airlines', 'Rossiya Airlines', 'Red Wings Airlines', 
            'Yamal Airlines', 'Nordwind Airlines', 'Azur Air', 'Pobeda', 'S7 Airlines', 'Ural Airlines', 
            'Rossiya Airlines', 'Red Wings Airlines', 'Yamal Airlines', 'Nordwind Airlines', 'Azur Air', 'Pobeda'
        ];

        // Global list of airports for autocomplete
        const airportsList = [
            // España
            { code: 'MAD', name: 'Adolfo Suárez Madrid-Barajas', city: 'Madrid', country: 'España' },
            { code: 'BCN', name: 'Barcelona-El Prat', city: 'Barcelona', country: 'España' },
            { code: 'AGP', name: 'Málaga-Costa del Sol', city: 'Málaga', country: 'España' },
            { code: 'PMI', name: 'Palma de Mallorca', city: 'Palma de Mallorca', country: 'España' },
            { code: 'ALC', name: 'Alicante-Elche', city: 'Alicante', country: 'España' },
            { code: 'IBZ', name: 'Ibiza', city: 'Ibiza', country: 'España' },
            { code: 'VLC', name: 'Valencia', city: 'Valencia', country: 'España' },
            { code: 'BIO', name: 'Bilbao', city: 'Bilbao', country: 'España' },
            { code: 'SVQ', name: 'Sevilla', city: 'Sevilla', country: 'España' },
            { code: 'GRX', name: 'Granada', city: 'Granada', country: 'España' },
            
            // Europa
            { code: 'CDG', name: 'Charles de Gaulle', city: 'París', country: 'Francia' },
            { code: 'ORY', name: 'Orly', city: 'París', country: 'Francia' },
            { code: 'LHR', name: 'Heathrow', city: 'Londres', country: 'Reino Unido' },
            { code: 'LGW', name: 'Gatwick', city: 'Londres', country: 'Reino Unido' },
            { code: 'STN', name: 'Stansted', city: 'Londres', country: 'Reino Unido' },
            { code: 'FCO', name: 'Fiumicino', city: 'Roma', country: 'Italia' },
            { code: 'MXP', name: 'Malpensa', city: 'Milán', country: 'Italia' },
            { code: 'AMS', name: 'Schiphol', city: 'Ámsterdam', country: 'Países Bajos' },
            { code: 'FRA', name: 'Frankfurt', city: 'Fráncfort', country: 'Alemania' },
            { code: 'MUC', name: 'Múnich', city: 'Múnich', country: 'Alemania' },
            { code: 'ZRH', name: 'Zúrich', city: 'Zúrich', country: 'Suiza' },
            { code: 'VIE', name: 'Viena-Schwechat', city: 'Viena', country: 'Austria' },
            { code: 'BRU', name: 'Bruselas-Nacional', city: 'Bruselas', country: 'Bélgica' },
            { code: 'CPH', name: 'Copenhague-Kastrup', city: 'Copenhague', country: 'Dinamarca' },
            { code: 'ARN', name: 'Arlanda', city: 'Estocolmo', country: 'Suecia' },
            { code: 'OSL', name: 'Gardermoen', city: 'Oslo', country: 'Noruega' },
            { code: 'HEL', name: 'Helsinki-Vantaa', city: 'Helsinki', country: 'Finlandia' },
            { code: 'WAW', name: 'Chopin', city: 'Varsovia', country: 'Polonia' },
            { code: 'PRG', name: 'Václav Havel', city: 'Praga', country: 'República Checa' },
            { code: 'BUD', name: 'Ferenc Liszt', city: 'Budapest', country: 'Hungría' },
            { code: 'ATH', name: 'Eleftherios Venizelos', city: 'Atenas', country: 'Grecia' },
            { code: 'IST', name: 'Istanbul', city: 'Estambul', country: 'Turquía' },
            { code: 'DUB', name: 'Dublín', city: 'Dublín', country: 'Irlanda' },
            { code: 'LIS', name: 'Humberto Delgado', city: 'Lisboa', country: 'Portugal' },
            { code: 'OPO', name: 'Francisco Sá Carneiro', city: 'Oporto', country: 'Portugal' },
            
            // América del Norte
            { code: 'JFK', name: 'John F. Kennedy', city: 'Nueva York', country: 'Estados Unidos' },
            { code: 'LAX', name: 'Los Ángeles International', city: 'Los Ángeles', country: 'Estados Unidos' },
            { code: 'ORD', name: 'O\'Hare', city: 'Chicago', country: 'Estados Unidos' },
            { code: 'ATL', name: 'Hartsfield-Jackson', city: 'Atlanta', country: 'Estados Unidos' },
            { code: 'DFW', name: 'Dallas/Fort Worth', city: 'Dallas', country: 'Estados Unidos' },
            { code: 'DEN', name: 'Denver International', city: 'Denver', country: 'Estados Unidos' },
            { code: 'SFO', name: 'San Francisco International', city: 'San Francisco', country: 'Estados Unidos' },
            { code: 'LAS', name: 'McCarran International', city: 'Las Vegas', country: 'Estados Unidos' },
            { code: 'MIA', name: 'Miami International', city: 'Miami', country: 'Estados Unidos' },
            { code: 'BOS', name: 'Logan International', city: 'Boston', country: 'Estados Unidos' },
            { code: 'YYZ', name: 'Pearson', city: 'Toronto', country: 'Canadá' },
            { code: 'YVR', name: 'Vancouver International', city: 'Vancouver', country: 'Canadá' },
            { code: 'YUL', name: 'Montreal-Trudeau', city: 'Montreal', country: 'Canadá' },
            { code: 'MEX', name: 'Benito Juárez', city: 'Ciudad de México', country: 'México' },
            { code: 'CUN', name: 'Cancún International', city: 'Cancún', country: 'México' },
            { code: 'GDL', name: 'Miguel Hidalgo', city: 'Guadalajara', country: 'México' },
            
            // América del Sur
            { code: 'GRU', name: 'Guarulhos', city: 'São Paulo', country: 'Brasil' },
            { code: 'GIG', name: 'Galeão', city: 'Río de Janeiro', country: 'Brasil' },
            { code: 'EZE', name: 'Ministro Pistarini', city: 'Buenos Aires', country: 'Argentina' },
            { code: 'AEP', name: 'Jorge Newbery', city: 'Buenos Aires', country: 'Argentina' },
            { code: 'SCL', name: 'Arturo Merino Benítez', city: 'Santiago', country: 'Chile' },
            { code: 'LIM', name: 'Jorge Chávez', city: 'Lima', country: 'Perú' },
            { code: 'BOG', name: 'El Dorado', city: 'Bogotá', country: 'Colombia' },
            { code: 'MDE', name: 'José María Córdova', city: 'Medellín', country: 'Colombia' },
            { code: 'UIO', name: 'Mariscal Sucre', city: 'Quito', country: 'Ecuador' },
            { code: 'GYE', name: 'José Joaquín de Olmedo', city: 'Guayaquil', country: 'Ecuador' },
            { code: 'CCS', name: 'Simón Bolívar', city: 'Caracas', country: 'Venezuela' },
            { code: 'ASU', name: 'Silvio Pettirossi', city: 'Asunción', country: 'Paraguay' },
            { code: 'MVD', name: 'Carrasco', city: 'Montevideo', country: 'Uruguay' },
            
            // Asia
            { code: 'NRT', name: 'Narita', city: 'Tokio', country: 'Japón' },
            { code: 'HND', name: 'Haneda', city: 'Tokio', country: 'Japón' },
            { code: 'KIX', name: 'Kansai', city: 'Osaka', country: 'Japón' },
            { code: 'ICN', name: 'Incheon', city: 'Seúl', country: 'Corea del Sur' },
            { code: 'PEK', name: 'Capital', city: 'Pekín', country: 'China' },
            { code: 'PVG', name: 'Pudong', city: 'Shanghái', country: 'China' },
            { code: 'CAN', name: 'Baiyun', city: 'Cantón', country: 'China' },
            { code: 'HKG', name: 'Hong Kong International', city: 'Hong Kong', country: 'China' },
            { code: 'SIN', name: 'Changi', city: 'Singapur', country: 'Singapur' },
            { code: 'BKK', name: 'Suvarnabhumi', city: 'Bangkok', country: 'Tailandia' },
            { code: 'KUL', name: 'Kuala Lumpur International', city: 'Kuala Lumpur', country: 'Malasia' },
            { code: 'DEL', name: 'Indira Gandhi', city: 'Nueva Delhi', country: 'India' },
            { code: 'BOM', name: 'Chhatrapati Shivaji', city: 'Mumbai', country: 'India' },
            { code: 'BLR', name: 'Kempegowda', city: 'Bangalore', country: 'India' },
            { code: 'MAA', name: 'Chennai', city: 'Chennai', country: 'India' },
            { code: 'HYD', name: 'Rajiv Gandhi', city: 'Hyderabad', country: 'India' },
            { code: 'CCU', name: 'Netaji Subhas Chandra Bose', city: 'Calcuta', country: 'India' },
            { code: 'DXB', name: 'Dubai International', city: 'Dubái', country: 'Emiratos Árabes Unidos' },
            { code: 'AUH', name: 'Abu Dhabi International', city: 'Abu Dhabi', country: 'Emiratos Árabes Unidos' },
            { code: 'DOH', name: 'Hamad International', city: 'Doha', country: 'Qatar' },
            { code: 'RUH', name: 'King Khalid', city: 'Riad', country: 'Arabia Saudita' },
            { code: 'JED', name: 'King Abdulaziz', city: 'Yeda', country: 'Arabia Saudita' },
            { code: 'CAI', name: 'Cairo International', city: 'El Cairo', country: 'Egipto' },
            { code: 'JNB', name: 'O.R. Tambo', city: 'Johannesburgo', country: 'Sudáfrica' },
            { code: 'CPT', name: 'Cape Town International', city: 'Ciudad del Cabo', country: 'Sudáfrica' },
            
            // Oceanía
            { code: 'SYD', name: 'Kingsford Smith', city: 'Sídney', country: 'Australia' },
            { code: 'MEL', name: 'Tullamarine', city: 'Melbourne', country: 'Australia' },
            { code: 'BNE', name: 'Brisbane', city: 'Brisbane', country: 'Australia' },
            { code: 'PER', name: 'Perth', city: 'Perth', country: 'Australia' },
            { code: 'ADL', name: 'Adelaide', city: 'Adelaida', country: 'Australia' },
            { code: 'AKL', name: 'Auckland', city: 'Auckland', country: 'Nueva Zelanda' },
            { code: 'WLG', name: 'Wellington', city: 'Wellington', country: 'Nueva Zelanda' },
            { code: 'CHC', name: 'Christchurch', city: 'Christchurch', country: 'Nueva Zelanda' }
        ];

        // Initialize drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing editor...');
            
            // Check if we need to restore editor state from preview
            const editorStateBackup = sessionStorage.getItem('editor_state_backup');
            if (editorStateBackup) {
                try {
                    const editorState = JSON.parse(editorStateBackup);
                    const timeDiff = Date.now() - editorState.timestamp;
                    
                    // Only restore if the backup is less than 1 hour old
                    if (timeDiff < 3600000) {
                        console.log('Restoring editor state from preview backup');
                        restoreEditorState(editorState);
                        // Clear the backup after restoring
                        sessionStorage.removeItem('editor_state_backup');
                        return; // Skip normal initialization
                    } else {
                        // Clear old backup
                        sessionStorage.removeItem('editor_state_backup');
                    }
                } catch (error) {
                    console.error('Error restoring editor state:', error);
                    sessionStorage.removeItem('editor_state_backup');
                }
            }
            
            // Clean up corrupted data first
            cleanupCorruptedData();
            
            initializeDragAndDrop();
            setDefaultStartDate();
            makeExistingItemsClickable();
            
            // Add event listener for date input to update automatically
            const startDateInput = document.getElementById('startDate');
            startDateInput.addEventListener('change', function() {
                updateItineraryDatesSilently();
                autoSave();
            });
            
            // Add event listener for trip title to update automatically
            const tripTitleInput = document.getElementById('tripTitle');
            if (tripTitleInput) {
                tripTitleInput.addEventListener('input', function() {
                    updateTripTitleInRealTime();
                    // Debounce auto-save to avoid too frequent saves
                    clearTimeout(window.tripTitleSaveTimeout);
                    window.tripTitleSaveTimeout = setTimeout(() => {
                        autoSave();
                        // Show subtle notification for auto-save
                        showNotification('Guardado Automático', 'Cambios guardados automáticamente', 2000);
                    }, 1000);
                });
                
                // Also save on blur (when user finishes editing)
                tripTitleInput.addEventListener('blur', function() {
                    autoSave();
                });
            }
            
            // Check if we're editing a saved trip
            const urlParams = new URLSearchParams(window.location.search);
            const tripId = urlParams.get('trip');
            const mode = urlParams.get('mode');
            
            console.log('Editor loaded with tripId:', tripId, 'mode:', mode);
            
            if (tripId && (mode === 'edit' || mode === 'new')) {
                if (mode === 'edit') {
                    loadSavedTrip(tripId);
                } else {
                    // For new trips, set up the trip ID and show name modal
                    console.log('Setting up new trip with ID:', tripId);
                    // Update URL to include mode=edit for consistency
                    const newUrl = `${window.location.pathname}?trip=${tripId}&mode=edit`;
                    window.history.replaceState({}, '', newUrl);
                    showTripNameModal();
                }
            } else {
                // For legacy URLs or no parameters, create a new trip
                createNewTrip();
            }
            
            // Update save status after initialization
            setTimeout(() => {
                updateSaveStatus();
                
                // Check if we have a trip ID and verify it's saved
                const urlParams = new URLSearchParams(window.location.search);
                const tripId = urlParams.get('trip');
                if (tripId) {
                    const savedTrips = JSON.parse(localStorage.getItem('viantryp_trips') || '[]');
                    const trip = savedTrips.find(t => t.id == tripId);
                    if (trip) {
                        console.log('Trip found in storage:', trip.title);
                        console.log('Trip data verification:', {
                            title: trip.title,
                            itemsCount: Object.keys(trip.itemsData || {}).length,
                            startDate: trip.startDate,
                            hasItemsData: !!trip.itemsData
                        });
                    } else {
                        console.log('Trip not found in storage, will be saved on first change');
                    }
                }
                
                // Verify current state
                console.log('Current editor state:', {
                    tripTitle: document.getElementById('tripTitle')?.value,
                    startDate: startDate,
                    itemsDataCount: Object.keys(itemsData).length,
                    dayCounter: dayCounter,
                    itemCounter: itemCounter
                });
                
                // Double-check data loading after a longer delay
                setTimeout(() => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const tripId = urlParams.get('trip');
                    if (tripId) {
                        const savedTrips = JSON.parse(localStorage.getItem('viantryp_trips') || '[]');
                        const trip = savedTrips.find(t => t.id == tripId);
                        if (trip && (!document.getElementById('tripTitle')?.value || Object.keys(itemsData).length === 0)) {
                            console.log('Data still missing after delay, forcing reload...');
                            loadSavedTrip(tripId);
                        }
                    }
                }, 3000);
            }, 1000);
            
            // Set up auto-save interval
            setInterval(autoSave, 30000); // Auto-save every 30 seconds
            
            // Auto-save when page is about to unload
            window.beforeUnloadHandler = function(e) {
                // Show confirmation dialog if there are unsaved changes
                if (hasUnsavedChanges()) {
                    e.preventDefault();
                    e.returnValue = 'Tienes cambios sin guardar. ¿Estás seguro de que quieres salir?';
                    return e.returnValue;
                }
            };
            
            window.addEventListener('beforeunload', window.beforeUnloadHandler);
            

            
            // Auto-save when page loses focus (user switches tabs or windows)
            window.addEventListener('blur', function() {
                autoSave();
            });
            
            // Auto-save when user navigates away
            window.addEventListener('pagehide', function() {
                autoSave();
            });
            
            // Clean up editor state backup when leaving the page (but not when going to preview)
            window.addEventListener('beforeunload', function(e) {
                // Only clean up if we're not going to preview
                const isGoingToPreview = e.target.location && e.target.location.href.includes('viantryp_preview.html');
                if (!isGoingToPreview) {
                    sessionStorage.removeItem('editor_state_backup');
                }
            });
        });

        function setDefaultStartDate() {
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = formattedDate;
            updateItineraryDatesSilently();
        }

        function updateItineraryDatesSilently() {
            const startDateInput = document.getElementById('startDate').value;
            if (!startDateInput) {
                return;
            }

            startDate = new Date(startDateInput + 'T00:00:00');
            const dayContainers = document.querySelectorAll('.day-container');
            
            dayContainers.forEach((container, index) => {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + index);
                
                const dateElement = container.querySelector('.day-date');
                const formattedDate = formatDate(currentDate);
                dateElement.textContent = formattedDate;
                dateElement.setAttribute('data-date', currentDate.toISOString().split('T')[0]);
            });
            
            // Sort items in all days after updating dates
            dayContainers.forEach(container => {
                sortItemsByTime(container);
            });
            
            // Auto-save after updating dates (silent)
            autoSave();
        }

        function updateItineraryDates() {
            const startDateInput = document.getElementById('startDate').value;
            if (!startDateInput) {
                return;
            }

            startDate = new Date(startDateInput + 'T00:00:00');
            const dayContainers = document.querySelectorAll('.day-container');
            
            dayContainers.forEach((container, index) => {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + index);
                
                const dateElement = container.querySelector('.day-date');
                const formattedDate = formatDate(currentDate);
                dateElement.textContent = formattedDate;
                dateElement.setAttribute('data-date', currentDate.toISOString().split('T')[0]);
            });

            // Sort items in all days after updating dates
            dayContainers.forEach(container => {
                sortItemsByTime(container);
            });

            // Dates updated silently
        }

        function formatDate(date) {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            return date.toLocaleDateString('es-ES', options);
        }

        function addNewDay() {
            dayCounter++;
            const timeline = document.getElementById('timeline');
            
            // Create new day container
            const newDayContainer = document.createElement('div');
            newDayContainer.className = 'day-container';
            newDayContainer.setAttribute('data-day', dayCounter);
            newDayContainer.style.opacity = '0';
            newDayContainer.style.transform = 'translateY(20px)';
            
            // Calculate the date for the new day
            let dayDate = 'Selecciona fecha de inicio';
            if (startDate) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + (dayCounter - 1));
                dayDate = formatDate(currentDate);
            }
            
            newDayContainer.innerHTML = `
                <div class="day-actions">
                    <button class="day-btn" onclick="deleteDay(this)">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
                <div class="day-header">
                    <div class="day-title">Día ${dayCounter}</div>
                    <div class="day-date" data-date="">${dayDate}</div>
                </div>
                <div class="day-items">
                    <div style="text-align: center; padding: 2rem; color: #666; font-style: italic;">
                        <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 1rem; display: block; color: var(--primary-blue);"></i>
                        Arrastra elementos aquí para personalizar este día
                    </div>
                </div>
            `;
            
            timeline.appendChild(newDayContainer);
            
            // Make the new day container droppable
            newDayContainer.addEventListener('dragover', handleDragOver);
            newDayContainer.addEventListener('drop', handleDrop);
            newDayContainer.addEventListener('dragenter', handleDragEnter);
            newDayContainer.addEventListener('dragleave', handleDragLeave);
            
            // Add entrance animation
            setTimeout(() => {
                newDayContainer.style.opacity = '1';
                newDayContainer.style.transform = 'translateY(0)';
            }, 100);
            
            // Scroll to the new day
            newDayContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Sort items in all days after adding new day
            const allDayContainers = document.querySelectorAll('.day-container');
            allDayContainers.forEach(container => {
                sortItemsByTime(container);
            });
            
            // Auto-save after adding new day (silent)
            autoSave();
        }

        function deleteDay(button) {
            const dayContainer = button.closest('.day-container');
            const dayNumber = dayContainer.getAttribute('data-day');
            
            // Don't allow deleting if it's the only day
            const totalDays = document.querySelectorAll('.day-container').length;
            if (totalDays <= 1) {
                return;
            }
            
            if (confirm(`¿Estás seguro de que quieres eliminar el Día ${dayNumber} y todos sus elementos?`)) {
                // Delete all items in this day from itemsData
                const items = dayContainer.querySelectorAll('.timeline-item[data-item-id]');
                items.forEach(item => {
                    const itemId = item.getAttribute('data-item-id');
                    delete itemsData[itemId];
                });
                
                // Remove with animation
                dayContainer.style.opacity = '0';
                dayContainer.style.transform = 'translateX(-50px) scale(0.95)';
                
                setTimeout(() => {
                    dayContainer.remove();
                    renumberDays();
                    updateItineraryDatesSilently(); // Recalculate dates
                    
                    // Sort items in all remaining days
                    const remainingDayContainers = document.querySelectorAll('.day-container');
                    remainingDayContainers.forEach(container => {
                        sortItemsByTime(container);
                    });
                }, 300);
                
                // Auto-save after deleting day (silent)
                autoSave();
            }
        }

        function renumberDays() {
            const dayContainers = document.querySelectorAll('.day-container');
            dayContainers.forEach((container, index) => {
                const dayNumber = index + 1;
                container.setAttribute('data-day', dayNumber);
                container.querySelector('.day-title').textContent = `Día ${dayNumber}`;
            });
            dayCounter = dayContainers.length;
        }

        function initializeDragAndDrop() {
            // Make elements draggable
            document.querySelectorAll('.draggable-element').forEach(element => {
                element.addEventListener('dragstart', handleDragStart);
                element.addEventListener('dragend', handleDragEnd);
                
                // Add click functionality for summary and total elements
                if (element.dataset.type === 'summary') {
                    element.addEventListener('click', handleSummaryClick);
                }
                if (element.dataset.type === 'total') {
                    element.addEventListener('click', handleTotalClick);
                }
            });

            // Make day containers droppable
            document.querySelectorAll('.day-container').forEach(container => {
                container.addEventListener('dragover', handleDragOver);
                container.addEventListener('drop', handleDrop);
                container.addEventListener('dragenter', handleDragEnter);
                container.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleSummaryClick(e) {
            e.preventDefault();
            
            // Check if there's already a summary at the top
            const timeline = document.getElementById('timeline');
            const existingSummary = timeline.querySelector('.timeline-item.summary');
            
            if (existingSummary) {
                // If summary already exists, remove it
                existingSummary.remove();
                // Remove from itemsData
                const existingId = existingSummary.getAttribute('data-item-id');
                if (existingId && itemsData[existingId]) {
                    delete itemsData[existingId];
                }
                autoSave();
                return;
            }
            
            // Create new summary element
            const newItem = createTimelineItem('summary', 'Resumen de Itinerario', 0);
            
            // Insert at the beginning of the timeline (before first day)
            timeline.insertBefore(newItem, timeline.firstChild);
            
            // Add entrance animation
            newItem.style.opacity = '0';
            newItem.style.transform = 'translateX(50px)';
            setTimeout(() => {
                newItem.style.opacity = '1';
                newItem.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto-save after adding new item (silent)
            autoSave();
            
            // Update the summary content
            updateAllSummaries();
        }

        function handleTotalClick(e) {
            e.preventDefault();
            
            // Check if there's already a total element
            const timeline = document.getElementById('timeline');
            const existingTotal = timeline.querySelector('.timeline-item.total');
            
            if (existingTotal) {
                // If total already exists, remove it
                existingTotal.remove();
                // Remove from itemsData
                const existingId = existingTotal.getAttribute('data-item-id');
                if (existingId && itemsData[existingId]) {
                    delete itemsData[existingId];
                }
                autoSave();
                return;
            }
            
            // Create total element directly (will be positioned based on checkbox in edit form)
            const newItem = createTimelineItem('total', 'Valor Total del Viaje', -1);
            
            // Check if there's already a total
            if (existingTotal) {
                existingTotal.remove();
            }
            
            // Place at the end initially (will be repositioned when saved)
            timeline.appendChild(newItem);
            
            // Add entrance animation
            newItem.style.opacity = '0';
            newItem.style.transform = 'translateX(50px)';
            setTimeout(() => {
                newItem.style.opacity = '1';
                newItem.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto-save after adding new item (silent)
            autoSave();
            
            // Update summary if it exists
            updateAllSummaries();
            
            // Automatically open edit modal for the new item
            setTimeout(() => {
                const editButton = newItem.querySelector('.item-btn');
                if (editButton) {
                    editItem(editButton);
                }
            }, 300);
        }

        function handleDragStart(e) {
            draggedElement = e.target;
            e.target.style.opacity = '0.5';
            e.target.style.transform = 'rotate(5deg) scale(1.05)';
            
            e.dataTransfer.setData('text/plain', JSON.stringify({
                type: e.target.dataset.type,
                text: e.target.querySelector('strong').textContent
            }));
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            e.target.style.transform = '';
            draggedElement = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const dayContainer = e.currentTarget;
            const dayItems = dayContainer.querySelector('.day-items');
            const dayNumber = parseInt(dayContainer.getAttribute('data-day'));
            
            // Remove placeholder if exists
            const placeholder = dayItems.querySelector('[style*="text-align: center"]');
            if (placeholder) placeholder.remove();
            
            // Create new timeline item
            const newItem = createTimelineItem(data.type, data.text, dayNumber);
            
            // Special handling for summary element - position at top
            if (data.type === 'summary') {
                // Find the timeline container
                const timeline = document.getElementById('timeline');
                
                // Check if there's already a summary at the top
                const existingSummary = timeline.querySelector('.timeline-item.summary');
                if (existingSummary) {
                    // Replace existing summary
                    existingSummary.remove();
                }
                
                // Insert at the beginning of the timeline (before first day)
                timeline.insertBefore(newItem, timeline.firstChild);
                
                // Update the day to 0 for summary (special case)
                itemsData[newItem.getAttribute('data-item-id')].day = 0;
            } else if (data.type === 'total') {
                // Special handling for total element - position based on checkbox
                const timeline = document.getElementById('timeline');
                
                // Check if there's already a total
                const existingTotal = timeline.querySelector('.timeline-item.total');
                if (existingTotal) {
                    // Replace existing total
                    existingTotal.remove();
                }
                
                // Default to placing at the beginning (after summary) unless checkbox is checked
                // The actual position will be determined when the user saves the form
                // For now, place it at the end and let the save function handle positioning
                timeline.appendChild(newItem);
                
                // Update the day to -1 for total (special case)
                itemsData[newItem.getAttribute('data-item-id')].day = -1;
            } else {
                // Normal element - add to day container
                dayItems.appendChild(newItem);
            }
            
            // Add entrance animation
            newItem.style.opacity = '0';
            newItem.style.transform = 'translateX(50px)';
            setTimeout(() => {
                newItem.style.opacity = '1';
                newItem.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto-save after adding new item (silent)
            autoSave();
            
            // Sort items by time within the day
            sortItemsByTime(dayContainer);
            
            // Update summary if it exists
            updateAllSummaries();
            
            // Show notification about automatic date assignment for elements with date fields
            if (data.type !== 'summary' && data.type !== 'total' && data.type !== 'note') {
                const dayDate = getDateForDay(dayNumber);
                if (dayDate) {
                    let message = '';
                    if (data.type === 'flight') {
                        message = `Fecha de salida automáticamente asignada al Día ${dayNumber}. Completa la fecha de llegada.`;
                    } else if (data.type === 'hotel') {
                        message = `Fecha de check-in automáticamente asignada al Día ${dayNumber}. Completa la fecha de check-out.`;
                    } else if (data.type === 'transport') {
                        message = `Fecha de salida automáticamente asignada al Día ${dayNumber}. Completa la fecha de llegada.`;
                    }
                    
                    if (message) {
                        showNotification('Fecha Asignada', message);
                    }
                }
            }
            
            // Automatically open edit modal for the new item (except summary)
            if (data.type !== 'summary') {
                setTimeout(() => {
                    const editButton = newItem.querySelector('.item-btn');
                    if (editButton) {
                        editItem(editButton);
                    }
                }, 300);
            }
        }

        // Function to get the date for a specific day
        function getDateForDay(dayNumber) {
            const startDate = document.getElementById('startDate')?.value;
            if (!startDate || dayNumber <= 0) return null;
            
            const startDateObj = new Date(startDate + 'T00:00:00');
            const dayDate = new Date(startDateObj);
            dayDate.setDate(startDateObj.getDate() + (dayNumber - 1));
            
            return dayDate.toISOString().split('T')[0]; // Return YYYY-MM-DD format
        }

        // Function to get time value for sorting (returns minutes since midnight)
        function getTimeValueForSorting(itemData) {
            if (!itemData) return 0;
            
            // For flights and transport, use departure time
            if (itemData.departureDateTime) {
                const departureTime = new Date(itemData.departureDateTime);
                return departureTime.getHours() * 60 + departureTime.getMinutes();
            }
            
            // For hotels, use check-in time
            if (itemData.checkin) {
                const [hours, minutes] = itemData.checkin.split(':').map(Number);
                return hours * 60 + minutes;
            }
            
            // For activities, use start time
            if (itemData.startTime) {
                const [hours, minutes] = itemData.startTime.split(':').map(Number);
                return hours * 60 + minutes;
            }
            
            // Default to 0 (midnight) for items without time
            return 0;
        }

        // Function to sort items within a day by time
        function sortItemsByTime(dayContainer) {
            const dayItems = dayContainer.querySelector('.day-items');
            if (!dayItems) return;
            
            const items = Array.from(dayItems.querySelectorAll('.timeline-item'));
            if (items.length <= 1) return; // No need to sort if 0 or 1 items
            
            // Get the day number
            const dayNumber = parseInt(dayContainer.getAttribute('data-day'));
            
            // Sort items by their time values
            items.sort((a, b) => {
                const itemIdA = a.getAttribute('data-item-id');
                const itemIdB = b.getAttribute('data-item-id');
                const itemDataA = itemsData[itemIdA];
                const itemDataB = itemsData[itemIdB];
                
                const timeA = getTimeValueForSorting(itemDataA);
                const timeB = getTimeValueForSorting(itemDataB);
                
                return timeA - timeB; // Sort from earliest to latest
            });
            
            // Re-append items in sorted order
            items.forEach(item => {
                dayItems.appendChild(item);
            });
        }

        function createTimelineItem(type, text, dayNumber = 1) {
            itemCounter++;
            const item = document.createElement('div');
            item.className = `timeline-item ${type}`;
            item.setAttribute('data-item-id', itemCounter);
            item.style.transition = 'all 0.3s ease';
            
            const iconMap = {
                flight: 'fa-plane',
                hotel: 'fa-bed',
                activity: 'fa-map-marker-alt',
                transport: 'fa-car',
                note: 'fa-sticky-note',
                summary: 'fa-clipboard-list',
                total: 'fa-dollar-sign'
            };
            
            const defaultDescriptions = {
                flight: 'Seleccionar aeropuertos de origen y destino',
                hotel: 'Añadir fechas de check-in/out y tipo de habitación',
                activity: 'Describir la actividad y horarios',
                transport: 'Seleccionar tipo de transporte, origen y destino',
                note: 'Añadir información importante',
                summary: 'Resumen automático del itinerario',
                total: 'Agregar precio total del viaje'
            };
            
            // Get the date for this day
            const dayDate = getDateForDay(dayNumber);
            
            // Initialize data for new item
            itemsData[itemCounter] = {
                type: type,
                title: type === 'hotel' ? '' : text, // Empty title for new hotels
                description: defaultDescriptions[type],
                day: dayNumber
            };
            
            // Automatically set start date for elements that have date fields
            if (dayDate && type !== 'summary' && type !== 'total' && type !== 'note') {
                if (type === 'flight') {
                    // For flights, set only departure date to the day date and time to 12:00
                    itemsData[itemCounter].departureDateTime = dayDate + 'T12:00';
                    // Leave arrival date empty for user to fill
                } else if (type === 'hotel') {
                    // For hotels, set only check-in date to the day date
                    itemsData[itemCounter].checkinDate = dayDate;
                    // Leave check-out date empty for user to fill
                    console.log('Hotel check-in date assigned:', { dayDate, dayNumber, itemId: itemCounter });
                } else if (type === 'transport') {
                    // For transport, set only departure date to the day date and time to 10:00
                    itemsData[itemCounter].departureDateTime = dayDate + 'T10:00';
                    // Leave arrival date empty for user to fill
                }
                // Note: Activities don't have a specific date field, they inherit from the day placement
            }
            
            if (type === 'summary') {
                // Special handling for summary element
                const summaryContent = generateItinerarySummary();
                item.innerHTML = `
                    <i class="fas ${iconMap[type]} element-icon ${type}"></i>
                    <div class="item-info">
                        <div class="item-title">${text}</div>
                        <div class="item-description">${summaryContent}</div>
                    </div>
                    <div class="item-actions">
                        <button class="summary-update-btn" onclick="updateSummary(${itemCounter})">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                        <button class="item-btn" onclick="deleteItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            } else if (type === 'total') {
                // Special handling for total element
                item.innerHTML = `
                    <i class="fas ${iconMap[type]} element-icon ${type}"></i>
                    <div class="item-info">
                        <div class="item-title">${text}</div>
                        <div class="item-description">${defaultDescriptions[type]}</div>
                    </div>
                    <div class="item-actions">
                        <button class="item-btn" onclick="editItem(this)">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="item-btn" onclick="deleteItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            } else {
                item.innerHTML = `
                    <i class="fas ${iconMap[type]} element-icon ${type}"></i>
                    <div class="item-info">
                        <div class="item-title">${type === 'hotel' ? 'Alojamiento' : text}</div>
                        <div class="item-description">${defaultDescriptions[type]}</div>
                    </div>
                    <div class="item-actions">
                        <button class="item-btn" onclick="editItem(this)">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="item-btn" onclick="deleteItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }
            
            // Make the entire item clickable
            item.addEventListener('click', function(e) {
                // Don't trigger if clicking on action buttons
                if (!e.target.closest('.item-actions')) {
                    editItem(this.querySelector('.item-btn'));
                }
            });
            
            return item;
        }

        function generateItinerarySummary() {
            const tripTitle = document.getElementById('tripTitle').value.trim() || 'Mi Viaje';
            const startDate = document.getElementById('startDate').value;
            const dayContainers = document.querySelectorAll('.day-container');
            
            let summary = `<strong>${tripTitle}</strong><br>`;
            
            if (startDate) {
                const startDateObj = new Date(startDate);
                const endDateObj = new Date(startDate);
                endDateObj.setDate(startDateObj.getDate() + dayContainers.length - 1);
                
                const formatDate = (date) => {
                    return date.toLocaleDateString('es-ES', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric' 
                    });
                };
                
                summary += `<strong>Duración:</strong> ${dayContainers.length} días (${formatDate(startDateObj)} - ${formatDate(endDateObj)})<br><br>`;
            }
            
            // Group items by day
            const itemsByDay = {};
            
            // Initialize days
            for (let i = 1; i <= dayContainers.length; i++) {
                itemsByDay[i] = [];
            }
            
            // Group items by their day
            Object.values(itemsData).forEach(item => {
                if (item && item.type && item.type !== 'summary' && item.day && item.day > 0) {
                    if (!itemsByDay[item.day]) {
                        itemsByDay[item.day] = [];
                    }
                    itemsByDay[item.day].push(item);
                }
            });
            
            // Generate day-by-day summary
            Object.keys(itemsByDay).forEach(dayNumber => {
                const dayItems = itemsByDay[dayNumber];
                if (dayItems.length > 0) {
                    const dayDate = new Date(startDate);
                    dayDate.setDate(dayDate.getDate() + parseInt(dayNumber) - 1);
                    
                    const formatDayDate = (date) => {
                        return date.toLocaleDateString('es-ES', { 
                            weekday: 'long',
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric' 
                        });
                    };
                    
                    summary += `<strong>Día ${dayNumber} - ${formatDayDate(dayDate)}</strong><br>`;
                    
                    dayItems.forEach(item => {
                        let itemTitle = item.title || 'Sin título';
                        
                        // Special formatting for different item types
                        if (item.type === 'flight') {
                            // Keep the flight title as is (already formatted as "Vuelo desde X hacia Y")
                            itemTitle = itemTitle;
                        } else if (item.type === 'hotel') {
                            // Use hotel name/title, remove nights info if present
                            itemTitle = itemTitle.replace(/\s*\(\d+\s*noche?s?\)/i, '').trim();
                        } else {
                            // For other types, use their title as is
                            itemTitle = itemTitle;
                        }
                        
                        summary += `• ${itemTitle}<br>`;
                    });
                    
                    summary += '<br>';
                }
            });
            
            // If no items found
            if (Object.values(itemsByDay).every(day => day.length === 0)) {
                summary += '<em>Sin elementos agregados aún</em>';
            }
            
            // Add total price if exists
            const totalItems = Object.values(itemsData).filter(item => item && item.type === 'total');
            if (totalItems.length > 0) {
                const totalItem = totalItems[0];
                if (totalItem.totalPrice && totalItem.currency) {
                    const price = parseFloat(totalItem.totalPrice);
                    if (!isNaN(price)) {
                        const currencySymbols = {
                            'USD': '$',
                            'EUR': '€',
                            'CLP': '$',
                            'ARS': '$',
                            'PEN': 'S/',
                            'COP': '$',
                            'MXN': '$'
                        };
                        const symbol = currencySymbols[totalItem.currency] || totalItem.currency;
                        const formattedPrice = `${symbol}${price.toLocaleString('es-ES', { 
                            minimumFractionDigits: 2, 
                            maximumFractionDigits: 2,
                            useGrouping: true
                        })}`;
                        summary += `<br><br><strong>💰 Valor Total del Viaje:</strong> ${formattedPrice} ${totalItem.currency}`;
                    }
                }
            }
            
            return summary;
        }

        function updateSummary(itemId) {
            const item = document.querySelector(`[data-item-id="${itemId}"]`);
            if (item && item.classList.contains('summary')) {
                const summaryContent = generateItinerarySummary();
                const descriptionElement = item.querySelector('.item-description');
                if (descriptionElement) {
                    descriptionElement.innerHTML = summaryContent;
                }
                
                // Update the data
                if (itemsData[itemId]) {
                    itemsData[itemId].description = summaryContent;
                }
                
                // Auto-save (silent)
                autoSave();
            }
        }

        function updateTransportIcon(itemId) {
            const item = document.querySelector(`[data-item-id="${itemId}"]`);
            if (item && item.classList.contains('transport')) {
                const itemData = itemsData[itemId];
                if (itemData && itemData.transportType) {
                    const iconElement = item.querySelector('.element-icon');
                    if (iconElement) {
                        const transportIcons = {
                            'Tren': 'fa-train',
                            'Autobús': 'fa-bus',
                            'Barco': 'fa-ship',
                            'Crucero': 'fa-ship',
                            'Taxi': 'fa-taxi',
                            'Van Privada': 'fa-shuttle-van',
                            'Otros': 'fa-car'
                        };
                        const newIcon = transportIcons[itemData.transportType] || 'fa-car';
                        iconElement.className = `fas ${newIcon} element-icon transport`;
                    }
                }
            }
        }


        
        function updateAllSummaries() {
            // Find all summary elements and update them
            const summaryElements = document.querySelectorAll('.timeline-item.summary');
            summaryElements.forEach(summaryElement => {
                const itemId = summaryElement.getAttribute('data-item-id');
                if (itemId) {
                    updateSummary(itemId);
                }
            });
        }
        


        function editItem(button) {
            const item = button.closest('.timeline-item');
            const itemId = item.getAttribute('data-item-id');
            const itemData = itemsData[itemId];
            
            currentEditingItem = { element: item, id: itemId, data: itemData };
            
            const modal = document.getElementById('editModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            let formHTML = '';
            
            if (itemData.type === 'flight') {
                modalTitle.innerHTML = '<i class="fas fa-plane"></i> Editar Vuelo';
                formHTML = `
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Aeropuerto de Origen *</label>
                            <input type="text" class="form-control" id="originAirportInput" value="${itemData.originAirport || ''}" placeholder="Buscar aeropuerto de origen..." autocomplete="off">
                        </div>
                        <div class="form-col">
                            <label class="form-label">Aeropuerto de Destino *</label>
                            <input type="text" class="form-control" id="destinationAirportInput" value="${itemData.destinationAirport || ''}" placeholder="Buscar aeropuerto de destino..." autocomplete="off">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Número de vuelo *</label>
                            <input type="text" class="form-control" id="flightNumber" value="${itemData.flightNumber || ''}" placeholder="Ej: UX1050">
                        </div>
                        <div class="form-col">
                            <label class="form-label">Aerolínea *</label>
                            <input type="text" class="form-control" id="airline" value="${itemData.airline || ''}" placeholder="Escribe para buscar aerolínea..." autocomplete="off">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Fecha y Hora de Salida *</label>
                            <input type="datetime-local" class="form-control" id="departureDateTime" value="${itemData.departureDateTime || ''}">
                        </div>
                        <div class="form-col">
                            <label class="form-label">Fecha y Hora de Llegada *</label>
                            <input type="datetime-local" class="form-control" id="arrivalDateTime" value="${itemData.arrivalDateTime || ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Información adicional</label>
                        <textarea class="form-control" id="flightNotes" rows="3" placeholder="Equipaje, asientos, comidas especiales, etc.">${itemData.notes || ''}</textarea>
                    </div>
                `;
            } else if (itemData.type === 'hotel') {
                modalTitle.innerHTML = '<i class="fas fa-bed"></i> Editar Alojamiento';
                formHTML = `
                    <div class="form-group">
                        <label class="form-label">Nombre del hotel *</label>
                        <input type="text" class="form-control" id="hotelName" value="${itemData.title || ''}" placeholder="Ej: Hotel Le Marais Boutique">
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Fecha de check-in *</label>
                            <input type="date" class="form-control" id="checkinDate" value="${itemData.checkinDate || ''}">
                        </div>
                        <div class="form-col">
                            <label class="form-label">Hora de check-in</label>
                            <input type="time" class="form-control" id="checkin" value="${itemData.checkin || '15:00'}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Fecha de check-out *</label>
                            <input type="date" class="form-control" id="checkoutDate" value="${itemData.checkoutDate || ''}">
                        </div>
                        <div class="form-col">
                            <label class="form-label">Hora de check-out</label>
                            <input type="time" class="form-control" id="checkout" value="${itemData.checkout || '11:00'}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Tipo de habitación</label>
                            <select class="form-control" id="roomType">
                                <option value="Habitación estándar" ${itemData.roomType === 'Habitación estándar' ? 'selected' : ''}>Habitación estándar</option>
                                <option value="Habitación superior" ${itemData.roomType === 'Habitación superior' ? 'selected' : ''}>Habitación superior</option>
                                <option value="Habitación deluxe" ${itemData.roomType === 'Habitación deluxe' ? 'selected' : ''}>Habitación deluxe</option>
                                <option value="Suite" ${itemData.roomType === 'Suite' ? 'selected' : ''}>Suite</option>
                                <option value="Suite presidencial" ${itemData.roomType === 'Suite presidencial' ? 'selected' : ''}>Suite presidencial</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label class="form-label">Tipo de alimentación</label>
                            <select class="form-control" id="mealPlan">
                                <option value="Sin alimentación" ${itemData.mealPlan === 'Sin alimentación' ? 'selected' : ''}>Sin alimentación</option>
                                <option value="Solo desayuno" ${itemData.mealPlan === 'Solo desayuno' ? 'selected' : ''}>Solo desayuno</option>
                                <option value="Media pensión" ${itemData.mealPlan === 'Media pensión' ? 'selected' : ''}>Media pensión</option>
                                <option value="Pensión completa" ${itemData.mealPlan === 'Pensión completa' ? 'selected' : ''}>Pensión completa</option>
                                <option value="Todo incluido" ${itemData.mealPlan === 'Todo incluido' ? 'selected' : ''}>Todo incluido</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Información adicional</label>
                        <textarea class="form-control" id="hotelNotes" rows="3" placeholder="Servicios especiales, ubicación, contacto, etc.">${itemData.notes || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Imágenes del hotel (máximo 2)</label>
                        <div class="image-upload-container">
                            <div class="image-upload-box" onclick="document.getElementById('hotelImage1').click()">
                                <input type="file" id="hotelImage1" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'hotelImage1Preview', 'hotelImage1Box')">
                                <div class="image-upload-icon">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <div class="image-upload-text">Hacer clic para agregar imagen</div>
                                <img id="hotelImage1Preview" class="image-preview" style="display: none;">
                                <button type="button" class="remove-image" onclick="removeImage('hotelImage1', 'hotelImage1Preview', 'hotelImage1Box')">×</button>
                            </div>
                            <div class="image-upload-box" onclick="document.getElementById('hotelImage2').click()">
                                <input type="file" id="hotelImage2" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'hotelImage2Preview', 'hotelImage2Box')">
                                <div class="image-upload-icon">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <div class="image-upload-text">Hacer clic para agregar imagen</div>
                                <img id="hotelImage2Preview" class="image-preview" style="display: none;">
                                <button type="button" class="remove-image" onclick="removeImage('hotelImage2', 'hotelImage2Preview', 'hotelImage2Box')">×</button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (itemData.type === 'activity') {
                modalTitle.innerHTML = '<i class="fas fa-map-marker-alt"></i> Editar Actividad';
                formHTML = `
                    <div class="form-group">
                        <label class="form-label">Nombre de la actividad *</label>
                        <input type="text" class="form-control" id="activityTitle" value="${itemData.title || ''}" placeholder="Ej: Torre Eiffel y Crucero por el Sena">
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Hora de inicio *</label>
                            <input type="time" class="form-control" id="startTime" value="${itemData.startTime || ''}">
                        </div>
                        <div class="form-col">
                            <label class="form-label">Hora de fin *</label>
                            <input type="time" class="form-control" id="endTime" value="${itemData.endTime || ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descripción *</label>
                        <textarea class="form-control" id="activityDescription" rows="4" placeholder="Describe la actividad, qué incluye, punto de encuentro, etc.">${itemData.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ubicación *</label>
                        <input type="text" class="form-control" id="location" value="${itemData.location || ''}" placeholder="Dirección o punto de encuentro">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Imágenes de la actividad (máximo 2)</label>
                        <div class="image-upload-container">
                            <div class="image-upload-box" onclick="document.getElementById('activityImage1').click()">
                                <input type="file" id="activityImage1" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'activityImage1Preview', 'activityImage1Box')">
                                <div class="image-upload-icon">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <div class="image-upload-text">Hacer clic para agregar imagen</div>
                                <img id="activityImage1Preview" class="image-preview" style="display: none;">
                                <button type="button" class="remove-image" onclick="removeImage('activityImage1', 'activityImage1Preview', 'activityImage1Box')">×</button>
                            </div>
                            <div class="image-upload-box" onclick="document.getElementById('activityImage2').click()">
                                <input type="file" id="activityImage2" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'activityImage2Preview', 'activityImage2Box')">
                                <div class="image-upload-icon">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <div class="image-upload-text">Hacer clic para agregar imagen</div>
                                <img id="activityImage2Preview" class="image-preview" style="display: none;">
                                <button type="button" class="remove-image" onclick="removeImage('activityImage2', 'activityImage2Preview', 'activityImage2Box')">×</button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (itemData.type === 'transport') {
                modalTitle.innerHTML = '<i class="fas fa-car"></i> Editar Traslado';
                formHTML = `
                    <div class="form-group">
                        <label class="form-label">Tipo de transporte *</label>
                        <select class="form-control" id="transportType">
                            <option value="">Seleccionar tipo de transporte</option>
                            <option value="Tren" ${itemData.transportType === 'Tren' ? 'selected' : ''}>Tren</option>
                            <option value="Autobús" ${itemData.transportType === 'Autobús' ? 'selected' : ''}>Autobús</option>
                            <option value="Barco" ${itemData.transportType === 'Barco' ? 'selected' : ''}>Barco</option>
                            <option value="Crucero" ${itemData.transportType === 'Crucero' ? 'selected' : ''}>Crucero</option>
                            <option value="Taxi" ${itemData.transportType === 'Taxi' ? 'selected' : ''}>Taxi</option>
                            <option value="Van Privada" ${itemData.transportType === 'Van Privada' ? 'selected' : ''}>Van Privada</option>
                            <option value="Otros" ${itemData.transportType === 'Otros' ? 'selected' : ''}>Otros</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Lugar de origen *</label>
                            <input type="text" class="form-control" id="originLocation" value="${itemData.originLocation || ''}" placeholder="Estación, terminal, puerto de origen">
                        </div>
                        <div class="form-col">
                            <label class="form-label">Lugar de destino *</label>
                            <input type="text" class="form-control" id="destinationLocation" value="${itemData.destinationLocation || ''}" placeholder="Estación, terminal, puerto de destino">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Fecha y Hora de Salida *</label>
                            <input type="datetime-local" class="form-control" id="departureDateTime" value="${itemData.departureDateTime || ''}">
                        </div>
                        <div class="form-col">
                            <label class="form-label">Fecha y Hora de Llegada *</label>
                            <input type="datetime-local" class="form-control" id="arrivalDateTime" value="${itemData.arrivalDateTime || ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Información adicional</label>
                        <textarea class="form-control" id="transportNotes" rows="3" placeholder="Número de asiento, compañía, instrucciones especiales, etc.">${itemData.notes || ''}</textarea>
                    </div>
                `;
            } else if (itemData.type === 'note') {
                modalTitle.innerHTML = '<i class="fas fa-sticky-note"></i> Editar Nota';
                formHTML = `
                    <div class="form-group">
                        <label class="form-label">Título de la nota *</label>
                        <input type="text" class="form-control" id="noteTitle" value="${itemData.title || ''}" placeholder="Ej: Información importante" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contenido *</label>
                        <textarea class="form-control" id="noteContent" rows="6" placeholder="Escribe aquí la información que quieres compartir con el cliente..." required>${itemData.content || itemData.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de nota</label>
                        <select class="form-control" id="noteType">
                            <option value="info" ${itemData.noteType === 'info' ? 'selected' : ''}>Información general</option>
                            <option value="warning" ${itemData.noteType === 'warning' ? 'selected' : ''}>Advertencia importante</option>
                            <option value="tip" ${itemData.noteType === 'tip' ? 'selected' : ''}>Consejo útil</option>
                            <option value="contact" ${itemData.noteType === 'contact' ? 'selected' : ''}>Información de contacto</option>
                        </select>
                    </div>
                `;
            } else if (itemData.type === 'total') {
                modalTitle.innerHTML = '<i class="fas fa-dollar-sign"></i> Editar Valor Total';
                formHTML = `
                    <div class="form-group">
                        <label class="form-label">Precio total del viaje *</label>
                        <input type="number" class="form-control" id="totalPrice" value="${itemData.totalPrice || ''}" placeholder="0" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Moneda *</label>
                        <select class="form-control" id="currency" required>
                            <option value="">Seleccionar moneda</option>
                            <option value="USD" ${itemData.currency === 'USD' ? 'selected' : ''}>USD - Dólar Estadounidense</option>
                            <option value="EUR" ${itemData.currency === 'EUR' ? 'selected' : ''}>EUR - Euro</option>
                            <option value="CLP" ${itemData.currency === 'CLP' ? 'selected' : ''}>CLP - Peso Chileno</option>
                            <option value="ARS" ${itemData.currency === 'ARS' ? 'selected' : ''}>ARS - Peso Argentino</option>
                            <option value="PEN" ${itemData.currency === 'PEN' ? 'selected' : ''}>PEN - Sol Peruano</option>
                            <option value="COP" ${itemData.currency === 'COP' ? 'selected' : ''}>COP - Peso Colombiano</option>
                            <option value="MXN" ${itemData.currency === 'MXN' ? 'selected' : ''}>MXN - Peso Mexicano</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="placeAtEnd" ${itemData.placeAtEnd ? 'checked' : ''}>
                            <span class="checkmark"></span>
                            Colocar al final del itinerario
                        </label>
                        <small class="form-text">Si no se marca, se colocará al inicio (después del resumen)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Desglose del precio (opcional)</label>
                        <textarea class="form-control" id="priceBreakdown" rows="4" placeholder="Ej: Vuelos: $500, Hoteles: $800, Actividades: $300, Transporte: $200">${itemData.priceBreakdown || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Información adicional</label>
                        <textarea class="form-control" id="totalNotes" rows="3" placeholder="Condiciones de pago, impuestos incluidos, etc.">${itemData.notes || ''}</textarea>
                    </div>
                `;
            }
            
            modalBody.innerHTML = formHTML;
            modal.classList.add('show');
            
            // Setup airline and airport autocomplete if it's a flight
            if (itemData.type === 'flight') {
                setTimeout(() => {
                    setupAirlineAutocomplete();
                    setupAirportAutocomplete('originAirportInput', 'originAirportAutocomplete');
                    setupAirportAutocomplete('destinationAirportInput', 'destinationAirportAutocomplete');
                }, 100);
            }
            
            // Add event listeners to clear error styles when user starts typing
            setTimeout(() => {
                const modal = document.getElementById('editModal');
                if (modal) {
                    const inputs = modal.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        input.addEventListener('input', clearFieldError);
                        input.addEventListener('change', clearFieldError);
                    });
                    

                }
            }, 100);
            
            // Load existing images if any
            if (itemData.images && itemData.images.length > 0) {
                if (itemData.type === 'hotel') {
                    itemData.images.forEach((image, index) => {
                        const imageInput = document.getElementById(`hotelImage${index + 1}`);
                        const preview = document.getElementById(`hotelImage${index + 1}Preview`);
                        const box = imageInput.closest('.image-upload-box');
                        
                        if (imageInput && preview && box) {
                            imageInput.dataset.fileName = image.fileName;
                            imageInput.dataset.originalName = image.name;
                            imageInput.dataset.blobUrl = image.blobUrl;
                            imageInput.dataset.base64Data = image.base64Data;
                            imageInput.dataset.size = image.size;
                            imageInput.dataset.type = image.type;
                            
                            preview.src = image.blobUrl;
                            preview.style.display = 'block';
                            box.classList.add('has-image');
                            box.querySelector('.image-upload-text').style.display = 'none';
                            box.querySelector('.image-upload-icon').style.display = 'none';
                        }
                    });
                } else if (itemData.type === 'activity') {
                    itemData.images.forEach((image, index) => {
                        const imageInput = document.getElementById(`activityImage${index + 1}`);
                        const preview = document.getElementById(`activityImage${index + 1}Preview`);
                        const box = imageInput.closest('.image-upload-box');
                        
                        if (imageInput && preview && box) {
                            imageInput.dataset.fileName = image.fileName;
                            imageInput.dataset.originalName = image.name;
                            imageInput.dataset.blobUrl = image.blobUrl;
                            imageInput.dataset.base64Data = image.base64Data;
                            imageInput.dataset.size = image.size;
                            imageInput.dataset.type = image.type;
                            
                            preview.src = image.blobUrl;
                            preview.style.display = 'block';
                            box.classList.add('has-image');
                            box.querySelector('.image-upload-text').style.display = 'none';
                            box.querySelector('.image-upload-icon').style.display = 'none';
                        }
                    });
                }
            }
        }

        function closeModal() {
            const modal = document.getElementById('editModal');
            modal.classList.remove('show');
            
            // Only clean up blob URLs for unsaved changes, not for existing images
            const imageInputs = modal.querySelectorAll('input[type="file"]');
            imageInputs.forEach(input => {
                // Only clean up if there's a blob URL but no file selected AND no existing image data
                if (input.dataset.blobUrl && !input.files[0] && !input.dataset.base64Data) {
                    URL.revokeObjectURL(input.dataset.blobUrl);
                    delete input.dataset.blobUrl;
                }
            });
            
            currentEditingItem = null;
        }

        // Function to validate if item date matches the day it's placed in
        function validateItemDate(itemDate, itemDay) {
            if (!itemDate || !itemDay) return true; // Skip validation if no date or day
            
            const startDate = document.getElementById('startDate')?.value;
            if (!startDate) return true; // Skip if no start date set
            
            // For debugging
            console.log('Validating date:', { itemDate, itemDay, startDate });
            
            const itemDateObj = new Date(itemDate);
            const startDateObj = new Date(startDate + 'T00:00:00');
            const expectedDateObj = new Date(startDateObj);
            expectedDateObj.setDate(startDateObj.getDate() + (itemDay - 1));
            
            // Compare only the date part (ignore time)
            const itemDateOnly = new Date(itemDateObj.getFullYear(), itemDateObj.getMonth(), itemDateObj.getDate());
            const expectedDateOnly = new Date(expectedDateObj.getFullYear(), expectedDateObj.getMonth(), expectedDateObj.getDate());
            
            const isValid = itemDateOnly.getTime() === expectedDateOnly.getTime();
            
            // For debugging
            console.log('Date validation result:', {
                itemDateOnly: itemDateOnly.toISOString().split('T')[0],
                expectedDateOnly: expectedDateOnly.toISOString().split('T')[0],
                isValid
            });
            
            return isValid;
        }

        // Function to validate hotel dates (more flexible than regular date validation)
        function validateHotelDate(checkinDate, itemDay) {
            if (!checkinDate || !itemDay) return true; // Skip validation if no date or day
            
            const startDate = document.getElementById('startDate')?.value;
            if (!startDate) return true; // Skip if no start date set
            
            // For debugging
            console.log('Validating hotel date:', { checkinDate, itemDay, startDate });
            
            try {
                // Convert dates to YYYY-MM-DD format for comparison
                const checkinDateStr = checkinDate.split('T')[0]; // Remove time part if present
                const startDateObj = new Date(startDate + 'T00:00:00');
                const expectedDateObj = new Date(startDateObj);
                expectedDateObj.setDate(startDateObj.getDate() + (itemDay - 1));
                const expectedDateStr = expectedDateObj.toISOString().split('T')[0];
                
                const isValid = checkinDateStr === expectedDateStr;
                
                // For debugging
                console.log('Hotel date validation result:', {
                    checkinDateStr,
                    expectedDateStr,
                    isValid
                });
                
                return isValid;
            } catch (error) {
                console.error('Error in hotel date validation:', error);
                // If there's an error, assume the date is valid to avoid false warnings
                return true;
            }
        }



        // Function to validate required fields for each element type
        function validateRequiredFields(data) {
            const errors = [];
            
            // Clear previous error styles
            clearErrorStyles();
            
            if (data.type === 'flight') {
                const originAirport = document.getElementById('originAirportInput')?.value?.trim();
                const destinationAirport = document.getElementById('destinationAirportInput')?.value?.trim();
                const flightNumber = document.getElementById('flightNumber')?.value?.trim();
                const airline = document.getElementById('airline')?.value?.trim();
                const departureDateTime = document.getElementById('departureDateTime')?.value;
                const arrivalDateTime = document.getElementById('arrivalDateTime')?.value;
                
                if (!originAirport) {
                    errors.push('Aeropuerto de origen');
                    markFieldAsError('originAirportInput');
                }
                if (!destinationAirport) {
                    errors.push('Aeropuerto de destino');
                    markFieldAsError('destinationAirportInput');
                }
                if (!flightNumber) {
                    errors.push('Número de vuelo');
                    markFieldAsError('flightNumber');
                }
                if (!airline) {
                    errors.push('Aerolínea');
                    markFieldAsError('airline');
                }
                if (!departureDateTime) {
                    errors.push('Fecha y hora de salida');
                    markFieldAsError('departureDateTime');
                }
                if (!arrivalDateTime) {
                    errors.push('Fecha y hora de llegada');
                    markFieldAsError('arrivalDateTime');
                }
                

                
            } else if (data.type === 'hotel') {
                const hotelName = document.getElementById('hotelName')?.value?.trim();
                const checkinDate = document.getElementById('checkinDate')?.value;
                const checkoutDate = document.getElementById('checkoutDate')?.value;
                
                if (!hotelName) {
                    errors.push('Nombre del hotel');
                    markFieldAsError('hotelName');
                }
                if (!checkinDate) {
                    errors.push('Fecha de check-in');
                    markFieldAsError('checkinDate');
                }
                if (!checkoutDate) {
                    errors.push('Fecha de check-out');
                    markFieldAsError('checkoutDate');
                }
                

                
            } else if (data.type === 'activity') {
                const activityTitle = document.getElementById('activityTitle')?.value?.trim();
                const startTime = document.getElementById('startTime')?.value;
                const endTime = document.getElementById('endTime')?.value;
                const activityDescription = document.getElementById('activityDescription')?.value?.trim();
                const location = document.getElementById('location')?.value?.trim();
                
                if (!activityTitle) {
                    errors.push('Nombre de la actividad');
                    markFieldAsError('activityTitle');
                }
                if (!startTime) {
                    errors.push('Hora de inicio');
                    markFieldAsError('startTime');
                }
                if (!endTime) {
                    errors.push('Hora de fin');
                    markFieldAsError('endTime');
                }
                if (!activityDescription) {
                    errors.push('Descripción');
                    markFieldAsError('activityDescription');
                }
                if (!location) {
                    errors.push('Ubicación');
                    markFieldAsError('location');
                }
                

                
            } else if (data.type === 'transport') {
                const transportType = document.getElementById('transportType')?.value;
                const originLocation = document.getElementById('originLocation')?.value?.trim();
                const destinationLocation = document.getElementById('destinationLocation')?.value?.trim();
                const departureDateTime = document.getElementById('departureDateTime')?.value;
                const arrivalDateTime = document.getElementById('arrivalDateTime')?.value;
                
                if (!transportType) {
                    errors.push('Tipo de transporte');
                    markFieldAsError('transportType');
                }
                if (!originLocation) {
                    errors.push('Lugar de origen');
                    markFieldAsError('originLocation');
                }
                if (!destinationLocation) {
                    errors.push('Lugar de destino');
                    markFieldAsError('destinationLocation');
                }
                if (!departureDateTime) {
                    errors.push('Fecha y hora de salida');
                    markFieldAsError('departureDateTime');
                }
                if (!arrivalDateTime) {
                    errors.push('Fecha y hora de llegada');
                    markFieldAsError('arrivalDateTime');
                }
                

                
            } else if (data.type === 'note') {
                const noteTitle = document.getElementById('noteTitle')?.value?.trim();
                const noteContent = document.getElementById('noteContent')?.value?.trim();
                
                if (!noteTitle) {
                    errors.push('Título de la nota');
                    markFieldAsError('noteTitle');
                }
                if (!noteContent) {
                    errors.push('Contenido');
                    markFieldAsError('noteContent');
                }
                
            } else if (data.type === 'total') {
                const totalPrice = document.getElementById('totalPrice')?.value?.trim();
                const currency = document.getElementById('currency')?.value;
                
                if (!totalPrice) {
                    errors.push('Precio total del viaje');
                    markFieldAsError('totalPrice');
                }
                if (!currency) {
                    errors.push('Moneda');
                    markFieldAsError('currency');
                }
            }
            
            return errors;
        }
        
        // Function to mark a field as having an error
        function markFieldAsError(fieldId) {
            const field = document.getElementById(fieldId);
            const label = field?.previousElementSibling;
            
            if (field) {
                field.classList.add('error');
            }
            if (label && label.classList.contains('form-label')) {
                label.classList.add('error');
            }
        }
        
        // Function to clear all error styles
        function clearErrorStyles() {
            const modal = document.getElementById('editModal');
            if (modal) {
                const errorFields = modal.querySelectorAll('.form-control.error');
                const errorLabels = modal.querySelectorAll('.form-label.error');
                
                errorFields.forEach(field => field.classList.remove('error'));
                errorLabels.forEach(label => label.classList.remove('error'));
            }
        }
        
        // Function to clear error style from a specific field
        function clearFieldError(event) {
            const field = event.target;
            const label = field.previousElementSibling;
            
            field.classList.remove('error');
            if (label && label.classList.contains('form-label')) {
                label.classList.remove('error');
            }
        }





        function saveChanges() {
            if (!currentEditingItem) return;
            
            const { element, id, data } = currentEditingItem;
            const titleElement = element.querySelector('.item-title');
            const descElement = element.querySelector('.item-description');
            
            // Validate required fields first
            const validationErrors = validateRequiredFields(data);
            if (validationErrors.length > 0) {
                const errorMessage = `Por favor completa los siguientes campos obligatorios:\n\n${validationErrors.join('\n')}`;
                alert(errorMessage);
                return; // Don't close the modal
            }
            
            let newTitle = '';
            let newDescription = '';
            let dateWarning = false;
            
            if (data.type === 'flight') {
                const originAirport = document.getElementById('originAirportInput').value;
                const destinationAirport = document.getElementById('destinationAirportInput').value;
                const flightNumber = document.getElementById('flightNumber').value;
                const airline = document.getElementById('airline').value;
                const departureDateTime = document.getElementById('departureDateTime').value;
                const arrivalDateTime = document.getElementById('arrivalDateTime').value;
                const notes = document.getElementById('flightNotes').value;
                
                // Extract city names from airport data attributes or fallback to parsing
                let originCity = document.getElementById('originAirportInput').getAttribute('data-airport-city');
                let destinationCity = document.getElementById('destinationAirportInput').getAttribute('data-airport-city');
                
                // If we don't have the city from data attributes, try to parse from the airport string
                if (!originCity && originAirport) {
                    if (originAirport.includes(' - ')) {
                        const parts = originAirport.split(' - ')[1];
                        if (parts) {
                            originCity = parts.split(',')[0].trim();
                        }
                    } else {
                        // Try to extract code and get city from our database
                        const originCode = originAirport.split(' ')[0];
                        originCity = getCityFromAirportCode(originCode);
                    }
                }
                
                if (!destinationCity && destinationAirport) {
                    if (destinationAirport.includes(' - ')) {
                        const parts = destinationAirport.split(' - ')[1];
                        if (parts) {
                            destinationCity = parts.split(',')[0].trim();
                        }
                    } else {
                        // Try to extract code and get city from our database
                        const destinationCode = destinationAirport.split(' ')[0];
                        destinationCity = getCityFromAirportCode(destinationCode);
                    }
                }
                
                // Validate departure date matches the day
                if (departureDateTime && !validateItemDate(departureDateTime, data.day)) {
                    dateWarning = true;
                }
                
                // Generate title automatically using city names
                newTitle = `Vuelo desde ${originCity} hacia ${destinationCity}`;
                
                // Format dates for description
                let departureText = '';
                let arrivalText = '';
                
                if (departureDateTime) {
                    departureText = formatFlightDateTime(departureDateTime);
                }
                
                if (arrivalDateTime) {
                    arrivalText = formatFlightDateTime(arrivalDateTime);
                }
                
                // Check if arrival is on a different day
                let dayDifferenceText = '';
                if (departureDateTime && arrivalDateTime) {
                    const departureDate = new Date(departureDateTime);
                    const arrivalDate = new Date(arrivalDateTime);
                    
                    // Calculate day difference
                    const departureDay = new Date(departureDate.getFullYear(), departureDate.getMonth(), departureDate.getDate());
                    const arrivalDay = new Date(arrivalDate.getFullYear(), arrivalDate.getMonth(), arrivalDate.getDate());
                    const dayDiff = Math.round((arrivalDay - departureDay) / (1000 * 60 * 60 * 24));
                    
                    if (dayDiff > 0) {
                        dayDifferenceText = ` (+${dayDiff} día${dayDiff > 1 ? 's' : ''})`;
                    }
                }
                
                newDescription = `${flightNumber} - ${airline} | Salida: ${departureText} - Llegada: ${arrivalText}${dayDifferenceText}`;
                
                // Update data
                itemsData[id] = {
                    ...itemsData[id],
                    title: newTitle,
                    originAirport,
                    destinationAirport,
                    originCity: document.getElementById('originAirportInput').getAttribute('data-airport-city') || originCity,
                    destinationCity: document.getElementById('destinationAirportInput').getAttribute('data-airport-city') || destinationCity,
                    flightNumber,
                    airline,
                    departureDateTime,
                    arrivalDateTime,
                    notes
                };
                
                // Generate trip title from flights
                generateTripTitleFromFlights();
                
            } else if (data.type === 'hotel') {
                const hotelName = document.getElementById('hotelName').value;
                const checkinDate = document.getElementById('checkinDate').value;
                const checkin = document.getElementById('checkin').value;
                const checkoutDate = document.getElementById('checkoutDate').value;
                const checkout = document.getElementById('checkout').value;
                const roomType = document.getElementById('roomType').value;
                const mealPlan = document.getElementById('mealPlan').value;
                const notes = document.getElementById('hotelNotes').value;
                
                // Calculate stay duration
                let stayDuration = '';
                if (checkinDate && checkoutDate) {
                    const checkinDateObj = new Date(checkinDate);
                    const checkoutDateObj = new Date(checkoutDate);
                    
                    // Calculate difference in days
                    const timeDiff = checkoutDateObj.getTime() - checkinDateObj.getTime();
                    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                    
                    if (daysDiff > 0) {
                        stayDuration = `${daysDiff} noche${daysDiff > 1 ? 's' : ''}`;
                    } else if (daysDiff === 0) {
                        stayDuration = '1 noche';
                    }
                }
                
                // Validate check-in date matches the day (more flexible for hotels)
                console.log('About to validate hotel check-in date:', { checkinDate, day: data.day });
                if (checkinDate && !validateHotelDate(checkinDate, data.day)) {
                    dateWarning = true;
                    console.log('Hotel date validation failed - will show warning');
                }
                
                newTitle = hotelName;
                newDescription = `${stayDuration ? stayDuration + ' | ' : ''}Check-in: ${checkin} | ${roomType} | ${mealPlan}`;
                
                // Handle hotel images
                const hotelImages = [];
                const hotelImage1 = document.getElementById('hotelImage1');
                const hotelImage2 = document.getElementById('hotelImage2');
                
                if (hotelImage1.files[0] && hotelImage1.dataset.blobUrl) {
                    hotelImages.push({
                        name: hotelImage1.dataset.originalName,
                        fileName: hotelImage1.dataset.fileName,
                        blobUrl: hotelImage1.dataset.blobUrl,
                        base64Data: hotelImage1.dataset.base64Data,
                        size: hotelImage1.files[0].size,
                        type: hotelImage1.files[0].type
                    });
                } else if (hotelImage1.dataset.base64Data) {
                    // Preserve existing image
                    hotelImages.push({
                        name: hotelImage1.dataset.originalName,
                        fileName: hotelImage1.dataset.fileName,
                        blobUrl: hotelImage1.dataset.blobUrl,
                        base64Data: hotelImage1.dataset.base64Data,
                        size: hotelImage1.dataset.size || 0,
                        type: hotelImage1.dataset.type || 'image/jpeg'
                    });
                }
                
                if (hotelImage2.files[0] && hotelImage2.dataset.blobUrl) {
                    hotelImages.push({
                        name: hotelImage2.dataset.originalName,
                        fileName: hotelImage2.dataset.fileName,
                        blobUrl: hotelImage2.dataset.blobUrl,
                        base64Data: hotelImage2.dataset.base64Data,
                        size: hotelImage2.files[0].size,
                        type: hotelImage2.files[0].type
                    });
                } else if (hotelImage2.dataset.base64Data) {
                    // Preserve existing image
                    hotelImages.push({
                        name: hotelImage2.dataset.originalName,
                        fileName: hotelImage2.dataset.fileName,
                        blobUrl: hotelImage2.dataset.blobUrl,
                        base64Data: hotelImage2.dataset.base64Data,
                        size: hotelImage2.dataset.size || 0,
                        type: hotelImage2.dataset.type || 'image/jpeg'
                    });
                }
                
                // Update data
                itemsData[id] = {
                    ...itemsData[id],
                    title: hotelName,
                    checkinDate,
                    checkin,
                    checkoutDate,
                    checkout,
                    roomType,
                    mealPlan,
                    notes,
                    images: hotelImages
                };
                
            } else if (data.type === 'activity') {
                const activityTitle = document.getElementById('activityTitle').value;
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;
                const description = document.getElementById('activityDescription').value;
                const location = document.getElementById('location').value;
                
                // For activities, we'll validate based on the day placement
                // Activities don't have a specific date field, so we validate based on placement
                const startDate = document.getElementById('startDate')?.value;
                if (startDate) {
                    const startDateObj = new Date(startDate + 'T00:00:00');
                    const expectedDateObj = new Date(startDateObj);
                    expectedDateObj.setDate(startDateObj.getDate() + (data.day - 1));
                    
                    // This is a simplified validation - in a real scenario you might want to add a date field to activities
                    // For now, we'll assume the activity is correctly placed based on the day
                }
                
                newTitle = activityTitle;
                newDescription = `${startTime} - ${endTime} | ${description}`;
                
                // Handle activity images
                const activityImages = [];
                const activityImage1 = document.getElementById('activityImage1');
                const activityImage2 = document.getElementById('activityImage2');
                
                // Check for new images or existing images
                if (activityImage1.files[0] && activityImage1.dataset.blobUrl) {
                    activityImages.push({
                        name: activityImage1.dataset.originalName,
                        fileName: activityImage1.dataset.fileName,
                        blobUrl: activityImage1.dataset.blobUrl,
                        base64Data: activityImage1.dataset.base64Data,
                        size: activityImage1.files[0].size,
                        type: activityImage1.files[0].type
                    });
                } else if (activityImage1.dataset.base64Data) {
                    // Preserve existing image
                    activityImages.push({
                        name: activityImage1.dataset.originalName,
                        fileName: activityImage1.dataset.fileName,
                        blobUrl: activityImage1.dataset.blobUrl,
                        base64Data: activityImage1.dataset.base64Data,
                        size: activityImage1.dataset.size || 0,
                        type: activityImage1.dataset.type || 'image/jpeg'
                    });
                }
                
                if (activityImage2.files[0] && activityImage2.dataset.blobUrl) {
                    activityImages.push({
                        name: activityImage2.dataset.originalName,
                        fileName: activityImage2.dataset.fileName,
                        blobUrl: activityImage2.dataset.blobUrl,
                        base64Data: activityImage2.dataset.base64Data,
                        size: activityImage2.files[0].size,
                        type: activityImage2.files[0].type
                    });
                } else if (activityImage2.dataset.base64Data) {
                    // Preserve existing image
                    activityImages.push({
                        name: activityImage2.dataset.originalName,
                        fileName: activityImage2.dataset.fileName,
                        blobUrl: activityImage2.dataset.blobUrl,
                        base64Data: activityImage2.dataset.base64Data,
                        size: activityImage2.dataset.size || 0,
                        type: activityImage2.dataset.type || 'image/jpeg'
                    });
                }
                
                // Update data
                itemsData[id] = {
                    ...itemsData[id],
                    title: activityTitle,
                    startTime,
                    endTime,
                    description,
                    location,
                    images: activityImages
                };
                
            } else if (data.type === 'transport') {
                const transportType = document.getElementById('transportType').value;
                const originLocation = document.getElementById('originLocation').value;
                const destinationLocation = document.getElementById('destinationLocation').value;
                const departureDateTime = document.getElementById('departureDateTime').value;
                const arrivalDateTime = document.getElementById('arrivalDateTime').value;
                const notes = document.getElementById('transportNotes').value;
                
                // Validate departure date matches the day
                if (departureDateTime && !validateItemDate(departureDateTime, data.day)) {
                    dateWarning = true;
                }
                
                // Generate title automatically
                newTitle = `${transportType} desde ${originLocation} hasta ${destinationLocation}`;
                
                // Format dates for description
                let departureText = '';
                let arrivalText = '';
                
                if (departureDateTime) {
                    departureText = formatFlightDateTime(departureDateTime);
                }
                
                if (arrivalDateTime) {
                    arrivalText = formatFlightDateTime(arrivalDateTime);
                }
                
                // Check if arrival is on a different day
                let dayDifferenceText = '';
                if (departureDateTime && arrivalDateTime) {
                    const departureDate = new Date(departureDateTime);
                    const arrivalDate = new Date(arrivalDateTime);
                    
                    // Calculate day difference
                    const departureDay = new Date(departureDate.getFullYear(), departureDate.getMonth(), departureDate.getDate());
                    const arrivalDay = new Date(arrivalDate.getFullYear(), arrivalDate.getMonth(), arrivalDate.getDate());
                    const dayDiff = Math.round((arrivalDay - departureDay) / (1000 * 60 * 60 * 24));
                    
                    if (dayDiff > 0) {
                        dayDifferenceText = ` (+${dayDiff} día${dayDiff > 1 ? 's' : ''})`;
                    }
                }
                
                newDescription = `Salida: ${departureText} - Llegada: ${arrivalText}${dayDifferenceText}`;
                
                // Update data
                itemsData[id] = {
                    ...itemsData[id],
                    title: newTitle,
                    transportType,
                    originLocation,
                    destinationLocation,
                    departureDateTime,
                    arrivalDateTime,
                    notes
                };
                
                // Update transport icon based on type
                updateTransportIcon(id);
                
            } else if (data.type === 'note') {
                const noteTitle = document.getElementById('noteTitle').value;
                const noteContent = document.getElementById('noteContent').value;
                const noteType = document.getElementById('noteType').value;
                
                newTitle = noteTitle;
                newDescription = noteContent.length > 80 ? noteContent.substring(0, 80) + '...' : noteContent;
                
                // Update data
                itemsData[id] = {
                    ...itemsData[id],
                    title: noteTitle,
                    content: noteContent,
                    noteType
                };
            } else if (data.type === 'total') {
                const totalPrice = document.getElementById('totalPrice').value;
                const currency = document.getElementById('currency').value;
                const placeAtEnd = document.getElementById('placeAtEnd').checked;
                const priceBreakdown = document.getElementById('priceBreakdown').value;
                const notes = document.getElementById('totalNotes').value;
                
                // Format price for display with thousands separator
                let formattedPrice = '';
                if (totalPrice) {
                    const price = parseFloat(totalPrice);
                    if (!isNaN(price)) {
                        const currencySymbols = {
                            'USD': '$',
                            'EUR': '€',
                            'CLP': '$',
                            'ARS': '$',
                            'PEN': 'S/',
                            'COP': '$',
                            'MXN': '$'
                        };
                        const symbol = currencySymbols[currency] || currency;
                        // Use Spanish locale for thousands separator (points)
                        formattedPrice = `${symbol}${price.toLocaleString('es-ES', { 
                            minimumFractionDigits: 2, 
                            maximumFractionDigits: 2,
                            useGrouping: true
                        })}`;
                    }
                }
                
                newTitle = `Valor Total del Viaje`;
                newDescription = formattedPrice ? `${formattedPrice} ${currency}` : 'Precio por definir';
                
                // Update data
                itemsData[id] = {
                    ...itemsData[id],
                    title: newTitle,
                    totalPrice: totalPrice,
                    currency: currency,
                    placeAtEnd: placeAtEnd,
                    priceBreakdown: priceBreakdown,
                    notes: notes
                };
                
                // Handle positioning based on checkbox
                const timeline = document.getElementById('timeline');
                const totalElement = document.querySelector(`[data-item-id="${id}"]`);
                
                if (totalElement) {
                    // Remove from current position
                    totalElement.remove();
                    
                    if (placeAtEnd) {
                        // Place at the end of the timeline
                        timeline.appendChild(totalElement);
                        itemsData[id].day = -1;
                    } else {
                        // Place at the beginning (after summary)
                        const summaryElement = timeline.querySelector('.timeline-item.summary');
                        if (summaryElement) {
                            timeline.insertBefore(totalElement, summaryElement.nextSibling);
                        } else {
                            timeline.insertBefore(totalElement, timeline.firstChild);
                        }
                        itemsData[id].day = 0;
                    }
                }
            }
            
            // Update UI
            titleElement.textContent = newTitle;
            descElement.textContent = newDescription;
            
            // Add update animation
            element.style.background = 'rgba(46, 204, 113, 0.1)';
            element.style.transform = 'scale(1.02)';
            setTimeout(() => {
                element.style.background = '';
                element.style.transform = '';
            }, 1000);
            
            closeModal();
            
            // Show date warning if needed
            if (dateWarning) {
                const startDate = document.getElementById('startDate')?.value;
                if (startDate) {
                    const startDateObj = new Date(startDate + 'T00:00:00');
                    const expectedDateObj = new Date(startDateObj);
                    expectedDateObj.setDate(startDateObj.getDate() + (data.day - 1));
                    const expectedDate = expectedDateObj.toLocaleDateString('es-ES', { 
                        weekday: 'long',
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric' 
                    });
                    
                    alert(`⚠️ Advertencia: La fecha del elemento no coincide con el día ${data.day} del itinerario (${expectedDate}). Considera mover el elemento al día correcto o ajustar la fecha.`);
                }
            }
            

            
            // Changes saved successfully
            
            // Auto-save after editing with a slight delay to ensure UI updates
            setTimeout(() => {
                autoSave();
                
                // Sort items by time within the day if this is a regular item (not summary/total)
                if (data.day > 0) {
                    const dayContainer = document.querySelector(`[data-day="${data.day}"]`);
                    if (dayContainer) {
                        sortItemsByTime(dayContainer);
                    }
                }
                
                // Update summary if it exists
                updateAllSummaries();
            }, 500);
        }

        function deleteItem(button) {
            const item = button.closest('.timeline-item');
            const itemId = item.getAttribute('data-item-id');
            
            if (confirm('¿Estás seguro de que quieres eliminar este elemento?')) {
                item.style.transform = 'translateX(50px)';
                item.style.opacity = '0';
                setTimeout(() => {
                    item.remove();
                    delete itemsData[itemId];
                    
                    // Check if day is empty and add placeholder
                    const dayItems = item.closest('.day-items');
                    if (dayItems.children.length === 0) {
                        dayItems.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: #666; font-style: italic;">
                                <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 1rem; display: block; color: var(--primary-blue);"></i>
                                Arrastra elementos aquí para personalizar este día
                            </div>
                        `;
                    }
                }, 300);
                
                // Auto-save after deletion (silent)
                autoSave();
                
                // Update summary if it exists
                updateAllSummaries();
            }
        }

        function downloadPDF() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            // Show loading state
            button.innerHTML = '<div class="loading"></div> Generando PDF...';
            button.disabled = true;
            
            try {
                // Get itinerary data
                const itineraryTitle = document.getElementById('tripTitle').value.trim() || 'Mi Viaje';
                const startDate = document.getElementById('startDate').value;
                const dayContainers = document.querySelectorAll('.day-container');
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set up fonts and colors
                doc.setFont('helvetica');
                
                // Header
                doc.setFillColor(30, 42, 56); // Primary dark
                doc.rect(0, 0, 210, 40, 'F');
                
                // Logo and title
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('VIAINTRYP', 20, 25);
                
                doc.setFontSize(16);
                doc.setFont('helvetica', 'normal');
                doc.text('Editor de Itinerarios', 20, 35);
                
                // Itinerary title
                doc.setTextColor(74, 144, 226); // Primary blue
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(itineraryTitle, 20, 60);
                
                // Trip dates
                if (startDate) {
                    const startDateObj = new Date(startDate);
                    const endDateObj = new Date(startDate);
                    endDateObj.setDate(startDateObj.getDate() + dayContainers.length - 1);
                    
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Fecha de inicio: ${formatDateForPDF(startDateObj)}`, 20, 75);
                    doc.text(`Fecha de fin: ${formatDateForPDF(endDateObj)}`, 20, 85);
                    doc.text(`Duración: ${dayContainers.length} días`, 20, 95);
                }
                
                // Separator
                doc.setDrawColor(74, 144, 226);
                doc.setLineWidth(0.5);
                doc.line(20, 105, 190, 105);
                
                // Process each day
                let yPosition = 120; // Initialize yPosition
                dayContainers.forEach((dayContainer, dayIndex) => {
                    const dayNumber = dayIndex + 1;
                    const dayDate = dayContainer.querySelector('.day-date').textContent;
                    const dayItems = dayContainer.querySelectorAll('.timeline-item');
                    
                    // Add space between days (except first day)
                    if (dayIndex > 0) {
                        yPosition += 20;
                    }
                    
                    // Day header
                    doc.setFillColor(245, 247, 250); // Light gray
                    doc.rect(20, yPosition - 5, 170, 20, 'F');
                    
                    doc.setTextColor(30, 42, 56);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`DÍA ${dayNumber}`, 25, yPosition + 5);
                    
                    doc.setTextColor(74, 144, 226);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text(dayDate, 25, yPosition + 15);
                    
                    yPosition += 30;
                    
                    // Day items
                    if (dayItems.length > 0) {
                        dayItems.forEach(item => {
                            const itemId = item.getAttribute('data-item-id');
                            const itemData = itemsData[itemId] || {};
                            const itemType = item.className.includes('flight') ? 'flight' :
                                           item.className.includes('hotel') ? 'hotel' :
                                           item.className.includes('activity') ? 'activity' :
                                           item.className.includes('transport') ? 'transport' : 'note';
                            
                            const itemTitle = item.querySelector('.item-title').textContent;
                            
                            // Type labels
                            const typeLabels = {
                                flight: 'VUELO',
                                hotel: 'ALOJAMIENTO',
                                activity: 'ACTIVIDAD',
                                transport: 'TRANSPORTE',
                                note: 'NOTA'
                            };
                            
                            const colorMap = {
                                flight: [74, 144, 226],    // Blue
                                hotel: [255, 107, 107],    // Coral
                                activity: [46, 204, 113],  // Mint
                                transport: [155, 89, 182], // Purple
                                note: [243, 156, 18]       // Orange
                            };
                            
                            // Item header
                            doc.setFillColor(...colorMap[itemType]);
                            doc.rect(20, yPosition - 3, 170, 12, 'F');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'bold');
                            doc.text(typeLabels[itemType], 25, yPosition + 5);
                            
                            yPosition += 15;
                            
                            // Item content box
                            doc.setFillColor(255, 255, 255);
                            doc.rect(20, yPosition - 3, 170, 1, 'F');
                            
                            // Item title
                            doc.setTextColor(30, 42, 56);
                            doc.setFontSize(14);
                            doc.setFont('helvetica', 'bold');
                            doc.text(itemTitle, 25, yPosition + 8);
                            
                            yPosition += 20;
                            
                            // Detailed information based on item type
                            let detailY = yPosition;
                            
                            if (itemType === 'flight') {
                                if (itemData.flightNumber) {
                                    doc.setTextColor(100, 100, 100);
                                    doc.setFontSize(10);
                                    doc.setFont('helvetica', 'normal');
                                    doc.text(`Número de vuelo: ${itemData.flightNumber}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.airline) {
                                    doc.text(`Aerolínea: ${itemData.airline}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.departure) {
                                    doc.text(`Salida: ${itemData.departure}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.arrival) {
                                    doc.text(`Llegada: ${itemData.arrival}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.notes) {
                                    doc.text(`Notas: ${itemData.notes}`, 25, detailY);
                                    detailY += 8;
                                }
                            } else if (itemType === 'hotel') {
                                if (itemData.checkin) {
                                    doc.setTextColor(100, 100, 100);
                                    doc.setFontSize(10);
                                    doc.setFont('helvetica', 'normal');
                                    doc.text(`Check-in: ${itemData.checkin}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.checkout) {
                                    doc.text(`Check-out: ${itemData.checkout}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.roomType) {
                                    doc.text(`Tipo de habitación: ${itemData.roomType}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.mealPlan) {
                                    doc.text(`Plan de comidas: ${itemData.mealPlan}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.notes) {
                                    doc.text(`Notas: ${itemData.notes}`, 25, detailY);
                                    detailY += 8;
                                }
                            } else if (itemType === 'activity') {
                                if (itemData.startTime) {
                                    doc.setTextColor(100, 100, 100);
                                    doc.setFontSize(10);
                                    doc.setFont('helvetica', 'normal');
                                    doc.text(`Hora de inicio: ${itemData.startTime}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.endTime) {
                                    doc.text(`Hora de fin: ${itemData.endTime}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.description) {
                                    doc.text(`Descripción: ${itemData.description}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.location) {
                                    doc.text(`Ubicación: ${itemData.location}`, 25, detailY);
                                    detailY += 8;
                                }
                            } else if (itemType === 'transport') {
                                if (itemData.pickupTime) {
                                    doc.setTextColor(100, 100, 100);
                                    doc.setFontSize(10);
                                    doc.setFont('helvetica', 'normal');
                                    doc.text(`Hora de recogida: ${itemData.pickupTime}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.duration) {
                                    doc.text(`Duración: ${itemData.duration}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.pickupLocation) {
                                    doc.text(`Punto de recogida: ${itemData.pickupLocation}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.destination) {
                                    doc.text(`Destino: ${itemData.destination}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.notes) {
                                    doc.text(`Notas: ${itemData.notes}`, 25, detailY);
                                    detailY += 8;
                                }
                            } else if (itemType === 'note') {
                                if (itemData.content) {
                                    doc.setTextColor(100, 100, 100);
                                    doc.setFontSize(10);
                                    doc.setFont('helvetica', 'normal');
                                    doc.text(`Contenido: ${itemData.content}`, 25, detailY);
                                    detailY += 8;
                                }
                                if (itemData.noteType) {
                                    const noteTypeLabels = {
                                        info: 'Información general',
                                        warning: 'Advertencia importante',
                                        tip: 'Consejo útil',
                                        contact: 'Información de contacto'
                                    };
                                    doc.text(`Tipo: ${noteTypeLabels[itemData.noteType] || itemData.noteType}`, 25, detailY);
                                    detailY += 8;
                                }
                            }
                            
                            yPosition = detailY + 15;
                            
                            // Check if we need a new page within the same day
                            if (yPosition > 250) {
                                doc.addPage();
                                yPosition = 30;
                            }
                        });
                    } else {
                        // Empty day message
                        doc.setTextColor(150, 150, 150);
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'italic');
                        doc.text('No hay actividades programadas para este día', 25, yPosition + 10);
                        yPosition += 25;
                    }
                });
                
                // Footer removed - no footer in PDF
                
                // Save the PDF
                const fileName = `itinerario_${itineraryTitle.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                // Reset button
            setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-check"></i> PDF Generado';
                button.style.background = 'var(--mint)';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                    button.disabled = false;
                }, 2000);
                }, 500);
                
                // PDF generated successfully
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                button.innerHTML = originalText;
                button.disabled = false;
                // Error generating PDF
            }
        }
        
        function formatDateForPDF(date) {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            return date.toLocaleDateString('es-ES', options);
        }
        
        function handleImageUpload(input, previewId, boxId) {
            const file = input.files[0];
            const preview = document.getElementById(previewId);
            const box = input.closest('.image-upload-box');
            
            if (file) {
                // Validate file size (max 5MB)
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (file.size > maxSize) {
                    input.value = '';
                    return;
                }
                
                // Validate file type
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    input.value = '';
                    return;
                }
                
                // Generate unique filename
                const timestamp = Date.now();
                const randomId = Math.random().toString(36).substring(2, 15);
                const fileExtension = file.name.split('.').pop();
                const fileName = `img_${timestamp}_${randomId}.${fileExtension}`;
                
                // Store file info for later use
                input.dataset.fileName = fileName;
                input.dataset.originalName = file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Store the base64 data for PDF export
                    const base64Data = e.target.result;
                    input.dataset.base64Data = base64Data;
                    
                    // Create blob URL for preview
                    const blob = new Blob([file], { type: file.type });
                    const blobUrl = URL.createObjectURL(blob);
                    
                    preview.src = blobUrl;
                    preview.style.display = 'block';
                    box.classList.add('has-image');
                    box.querySelector('.image-upload-text').style.display = 'none';
                    box.querySelector('.image-upload-icon').style.display = 'none';
                    
                    // Store the blob URL for later use
                    input.dataset.blobUrl = blobUrl;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeImage(inputId, previewId, boxId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const box = input.closest('.image-upload-box');
            
            // Clean up blob URL if it exists
            if (input.dataset.blobUrl) {
                URL.revokeObjectURL(input.dataset.blobUrl);
                delete input.dataset.blobUrl;
            }
            
            // Clear file data
            delete input.dataset.fileName;
            delete input.dataset.originalName;
            delete input.dataset.base64Data;
            
            input.value = '';
            preview.style.display = 'none';
            box.classList.remove('has-image');
            box.querySelector('.image-upload-text').style.display = 'block';
            box.querySelector('.image-upload-icon').style.display = 'block';
        }
        
        function makeExistingItemsClickable() {
            document.querySelectorAll('.timeline-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // Don't trigger if clicking on action buttons
                    if (!e.target.closest('.item-actions')) {
                        editItem(this.querySelector('.item-btn'));
                    }
                });
            });
        }
        
        function closePDFPreview() {
            document.getElementById('pdfPreviewModal').classList.remove('show');
        }

        // Trip Name Modal Functions
        function showTripNameModal() {
            const modal = document.getElementById('tripNameModal');
            const input = document.getElementById('newTripName');
            
            modal.classList.add('show');
            input.focus();
            
            // Clear any previous errors
            hideTripNameError();
        }

        function closeTripNameModal() {
            const modal = document.getElementById('tripNameModal');
            const input = document.getElementById('newTripName');
            
            modal.classList.remove('show');
            input.value = '';
            hideTripNameError();
            
            // If user cancels, redirect to index
            window.location.href = 'viantryp_index.html';
        }

        function createTripWithName() {
            console.log('createTripWithName called');
            const tripName = document.getElementById('newTripName').value.trim();
            
            console.log('Trip name:', tripName);
            
            if (!tripName) {
                showTripNameError();
                return;
            }
            
            // Get the current trip ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const tripId = urlParams.get('trip');
            
            if (!tripId) {
                return;
            }
            
            // Set the trip title
            const tripTitleInput = document.getElementById('tripTitle');
            if (tripTitleInput) {
                tripTitleInput.value = tripName;
            }
            
            // Update page title
            updateTripTitleInRealTime();
            
            // Force save the trip immediately
            console.log('Creating trip with name:', tripName, 'ID:', tripId);
            
            // Save the trip data immediately
            try {
                const startDate = document.getElementById('startDate')?.value;
                const dayContainers = document.querySelectorAll('.day-container');
                
                // Calculate end date
                let endDate = '';
                if (startDate && dayContainers.length > 0) {
                    const startDateObj = new Date(startDate + 'T00:00:00');
                    const endDateObj = new Date(startDate + 'T00:00:00');
                    endDateObj.setDate(startDateObj.getDate() + dayContainers.length - 1);
                    endDate = endDateObj.toISOString().split('T')[0];
                }
                
                // Format dates
                const formatDate = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString + 'T00:00:00');
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                };
                
                const startDateFormatted = formatDate(startDate);
                const endDateFormatted = formatDate(endDate);
                const dateRange = startDateFormatted && endDateFormatted ? `${startDateFormatted} - ${endDateFormatted}` : 'Sin fecha';
                
                // Get existing trips
                let existingTrips = JSON.parse(localStorage.getItem('viantryp_trips') || '[]');
                
                // Create new trip
                const newTrip = {
                    id: parseInt(tripId),
                    title: tripName,
                    dates: dateRange,
                    duration: `${dayContainers.length} días`,
                    status: 'draft',
                    startDate: startDate,
                    endDate: endDate,
                    itemsData: JSON.parse(JSON.stringify(itemsData)),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Add to existing trips
                existingTrips.push(newTrip);
                
                // Save to localStorage
                localStorage.setItem('viantryp_trips', JSON.stringify(existingTrips));
                
                // Also save backup
                localStorage.setItem(`viantryp_trip_backup_${tripId}`, JSON.stringify({
                    trip: newTrip,
                    timestamp: new Date().toISOString()
                }));
                
                console.log('Trip saved successfully:', newTrip);
                
                // Update save status
                updateSaveStatus();
                
                // Close the modal first, then show notification
                const modal = document.getElementById('tripNameModal');
                if (modal) {
                    modal.classList.remove('show');
                }
                
                // Trip created successfully
                
            } catch (error) {
                console.error('Error creating trip:', error);
            }
        }

        function handleTripNameKeyPress(event) {
            if (event.key === 'Enter') {
                createTripWithName();
            }
        }

        function showTripNameError() {
            const errorDiv = document.getElementById('tripNameError');
            const input = document.getElementById('newTripName');
            
            errorDiv.style.display = 'block';
            input.classList.add('error');
            input.focus();
        }

        function hideTripNameError() {
            const errorDiv = document.getElementById('tripNameError');
            const input = document.getElementById('newTripName');
            
            errorDiv.style.display = 'none';
            input.classList.remove('error');
        }

        // Save Changes Modal Functions
        let pendingExitAction = null;

        function showSaveChangesModal(exitAction) {
            pendingExitAction = exitAction;
            
            // Generate changes summary
            const changesSummary = generateChangesSummary();
            document.getElementById('changesSummary').innerHTML = changesSummary;
            
            // Show modal
            const modal = document.getElementById('saveChangesModal');
            modal.classList.add('show');
        }

        function closeSaveChangesModal() {
            const modal = document.getElementById('saveChangesModal');
            modal.classList.remove('show');
            pendingExitAction = null;
        }



        function generateChangesSummary() {
            const tripTitle = document.getElementById('tripTitle')?.value?.trim() || 'Mi Viaje';
            const startDate = document.getElementById('startDate')?.value;
            const itemsCount = Object.keys(itemsData).length;
            const dayContainers = document.querySelectorAll('.day-container');
            
            let summary = `<div style="margin-bottom: 0.5rem;"><strong>Título:</strong> ${tripTitle}</div>`;
            
            if (startDate) {
                const formattedDate = new Date(startDate).toLocaleDateString('es-ES');
                summary += `<div style="margin-bottom: 0.5rem;"><strong>Fecha de inicio:</strong> ${formattedDate}</div>`;
            }
            
            summary += `<div style="margin-bottom: 0.5rem;"><strong>Días:</strong> ${dayContainers.length}</div>`;
            summary += `<div style="margin-bottom: 0.5rem;"><strong>Elementos:</strong> ${itemsCount}</div>`;
            
            if (itemsCount > 0) {
                const itemTypes = {};
                Object.values(itemsData).forEach(item => {
                    if (item && item.type) {
                        itemTypes[item.type] = (itemTypes[item.type] || 0) + 1;
                    }
                });
                
                const typeLabels = {
                    flight: 'Vuelos',
                    hotel: 'Hoteles',
                    activity: 'Actividades',
                    transport: 'Transportes',
                    note: 'Notas'
                };
                
                const typeSummary = Object.entries(itemTypes)
                    .map(([type, count]) => `${typeLabels[type] || type}: ${count}`)
                    .join(', ');
                
                summary += `<div><strong>Tipos:</strong> ${typeSummary}</div>`;
            }
            
            return summary;
        }

        function saveAndExit() {
            // Save changes with manual save for better reliability
            const saveSuccess = manualSave();
            
            // Close modal immediately
            closeSaveChangesModal();
            
            // Disable beforeunload temporarily to avoid browser dialog
            window.removeEventListener('beforeunload', window.beforeUnloadHandler);
            
            // Show success message if save was successful
            if (saveSuccess) {
                showNotification('Viaje Guardado', 'Tu itinerario se ha guardado y puedes continuar trabajando desde donde lo dejaste.');
            }
            
            // Execute pending exit action immediately (go to index)
            if (pendingExitAction) {
                pendingExitAction();
            } else {
                // Fallback: go to index directly
                window.location.href = 'viantryp_index.html';
            }
        }

        function exitWithoutSaving() {
            // Close modal immediately
            closeSaveChangesModal();
            
            // Disable beforeunload temporarily to avoid browser dialog
            window.removeEventListener('beforeunload', window.beforeUnloadHandler);
            
            // Execute pending exit action immediately
            if (pendingExitAction) {
                pendingExitAction();
            } else {
                // Fallback: go to index directly
                window.location.href = 'viantryp_index.html';
            }
        }

        function hasUnsavedChanges() {
            const tripTitle = document.getElementById('tripTitle')?.value?.trim();
            const hasItems = Object.keys(itemsData).length > 0;
            const hasCustomTitle = tripTitle && tripTitle !== 'Mi Viaje';
            
            // Also check if there are any recent changes that haven't been auto-saved
            const lastAutoSave = sessionStorage.getItem('last_auto_save');
            const hasRecentChanges = lastAutoSave && (Date.now() - parseInt(lastAutoSave)) < 30000; // 30 seconds
            
            return hasItems || hasCustomTitle || hasRecentChanges;
        }

        function confirmExit(exitAction) {
            // Always save before exiting to ensure data persistence
            const tripTitle = document.getElementById('tripTitle')?.value?.trim();
            const hasItems = Object.keys(itemsData).length > 0;
            
            // Save if there's any content (title or items)
            if ((tripTitle && tripTitle !== 'Mi Viaje') || hasItems) {
                console.log('Saving before exit...');
                const saveSuccess = manualSave();
                
                if (saveSuccess) {
                    showNotification('Viaje Guardado', 'Tu itinerario se ha guardado automáticamente antes de salir.');
                }
            }
            
            if (hasUnsavedChanges()) {
                showSaveChangesModal(exitAction);
            } else {
                // Disable beforeunload temporarily to avoid browser dialog
                window.removeEventListener('beforeunload', window.beforeUnloadHandler);
                
                // Execute exit action immediately
                exitAction();
            }
        }


        
        function downloadPDFFromPreview() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            // Show loading state
            button.innerHTML = '<div class="loading"></div> Generando PDF...';
            button.disabled = true;
            
            closePDFPreview();
            
            // Trigger the download after a short delay to ensure modal is closed
            setTimeout(() => {
                try {
                    // Get itinerary data
                    const itineraryTitle = document.getElementById('tripTitle').value.trim() || 'Mi Viaje';
                    const startDate = document.getElementById('startDate').value;
                    const dayContainers = document.querySelectorAll('.day-container');
                    
                    // Create PDF
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Set up fonts and colors
                    doc.setFont('helvetica');
                    
                    // Header
                    doc.setFillColor(30, 42, 56); // Primary dark
                    doc.rect(0, 0, 210, 40, 'F');
                    
                    // Logo and title
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(24);
                    doc.setFont('helvetica', 'bold');
                    doc.text('VIAINTRYP', 20, 25);
                    
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Editor de Itinerarios', 20, 35);
                    
                    // Itinerary title
                    doc.setTextColor(74, 144, 226); // Primary blue
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text(itineraryTitle, 20, 60);
                    
                    // Trip dates
                    if (startDate) {
                        const startDateObj = new Date(startDate);
                        const endDateObj = new Date(startDate);
                        endDateObj.setDate(startDateObj.getDate() + dayContainers.length - 1);
                        
                        doc.setTextColor(100, 100, 100);
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Fecha de inicio: ${formatDateForPDF(startDateObj)}`, 20, 75);
                        doc.text(`Fecha de fin: ${formatDateForPDF(endDateObj)}`, 20, 85);
                        doc.text(`Duración: ${dayContainers.length} días`, 20, 95);
                    }
                    
                    // Separator
                    doc.setDrawColor(74, 144, 226);
                    doc.setLineWidth(0.5);
                    doc.line(20, 105, 190, 105);
                    
                    // Process each day
                    let yPosition = 120; // Initialize yPosition
                    dayContainers.forEach((dayContainer, dayIndex) => {
                        const dayNumber = dayIndex + 1;
                        const dayDate = dayContainer.querySelector('.day-date').textContent;
                        const dayItems = dayContainer.querySelectorAll('.timeline-item');
                        
                        // Add space between days (except first day)
                        if (dayIndex > 0) {
                            yPosition += 20;
                        }
                        
                        // Day header
                        doc.setFillColor(245, 247, 250); // Light gray
                        doc.rect(20, yPosition - 5, 170, 20, 'F');
                        
                        doc.setTextColor(30, 42, 56);
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`DÍA ${dayNumber}`, 25, yPosition + 5);
                        
                        doc.setTextColor(74, 144, 226);
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'normal');
                        doc.text(dayDate, 25, yPosition + 15);
                        
                        yPosition += 30;
                        
                        // Day items
                        if (dayItems.length > 0) {
                            dayItems.forEach(item => {
                                const itemId = item.getAttribute('data-item-id');
                                const itemData = itemsData[itemId] || {};
                                const itemType = item.className.includes('flight') ? 'flight' :
                                               item.className.includes('hotel') ? 'hotel' :
                                               item.className.includes('activity') ? 'activity' :
                                               item.className.includes('transport') ? 'transport' : 'note';
                                
                                const itemTitle = item.querySelector('.item-title').textContent;
                                
                                // Type labels
                                const typeLabels = {
                                    flight: 'VUELO',
                                    hotel: 'ALOJAMIENTO',
                                    activity: 'ACTIVIDAD',
                                    transport: 'TRANSPORTE',
                                    note: 'NOTA'
                                };
                                
                                const colorMap = {
                                    flight: [74, 144, 226],    // Blue
                                    hotel: [255, 107, 107],    // Coral
                                    activity: [46, 204, 113],  // Mint
                                    transport: [155, 89, 182], // Purple
                                    note: [243, 156, 18]       // Orange
                                };
                                
                                // Item header
                                doc.setFillColor(...colorMap[itemType]);
                                doc.rect(20, yPosition - 3, 170, 12, 'F');
                                
                                doc.setTextColor(255, 255, 255);
                                doc.setFontSize(10);
                                doc.setFont('helvetica', 'bold');
                                doc.text(typeLabels[itemType], 25, yPosition + 5);
                                
                                yPosition += 15;
                                
                                // Item content box
                                doc.setFillColor(255, 255, 255);
                                doc.rect(20, yPosition - 3, 170, 1, 'F');
                                
                                // Item title
                                doc.setTextColor(30, 42, 56);
                                doc.setFontSize(14);
                                doc.setFont('helvetica', 'bold');
                                doc.text(itemTitle, 25, yPosition + 8);
                                
                                yPosition += 20;
                                
                                // Detailed information based on item type
                                let detailY = yPosition;
                                
                                if (itemType === 'flight') {
                                    if (itemData.flightNumber) {
                                        doc.setTextColor(100, 100, 100);
                                        doc.setFontSize(10);
                                        doc.setFont('helvetica', 'normal');
                                        doc.text(`Número de vuelo: ${itemData.flightNumber}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.airline) {
                                        doc.text(`Aerolínea: ${itemData.airline}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.departure) {
                                        doc.text(`Salida: ${itemData.departure}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.arrival) {
                                        doc.text(`Llegada: ${itemData.arrival}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.notes) {
                                        doc.text(`Notas: ${itemData.notes}`, 25, detailY);
                                        detailY += 8;
                                    }
                                } else if (itemType === 'hotel') {
                                    if (itemData.checkin) {
                                        doc.setTextColor(100, 100, 100);
                                        doc.setFontSize(10);
                                        doc.setFont('helvetica', 'normal');
                                        doc.text(`Check-in: ${itemData.checkin}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.checkout) {
                                        doc.text(`Check-out: ${itemData.checkout}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.roomType) {
                                        doc.text(`Tipo de habitación: ${itemData.roomType}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.mealPlan) {
                                        doc.text(`Plan de comidas: ${itemData.mealPlan}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.notes) {
                                        doc.text(`Notas: ${itemData.notes}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.images && itemData.images.length > 0) {
                                        doc.text(`Imágenes adjuntas: ${itemData.images.length}`, 25, detailY);
                                        detailY += 8;
                                        
                                        // Add images to PDF with better layout
                                        const maxImagesPerRow = 3;
                                        const imgWidth = 50;
                                        const imgHeight = 35;
                                        const imgSpacing = 60;
                                        
                                        itemData.images.forEach((image, imgIndex) => {
                                            try {
                                                const row = Math.floor(imgIndex / maxImagesPerRow);
                                                const col = imgIndex % maxImagesPerRow;
                                                const imgX = 25 + (col * imgSpacing);
                                                const imgY = detailY + (row * (imgHeight + 15));
                                                
                                                // Add image border
                                                doc.setDrawColor(200, 200, 200);
                                                doc.setLineWidth(0.5);
                                                doc.rect(imgX - 1, imgY - 1, imgWidth + 2, imgHeight + 2, 'S');
                                                
                                                // Add image to PDF using base64 data
                                                if (image.base64Data) {
                                                    // Determine image format from base64 data
                                                    let imageFormat = 'JPEG';
                                                    if (image.base64Data.startsWith('data:image/png')) {
                                                        imageFormat = 'PNG';
                                                    } else if (image.base64Data.startsWith('data:image/gif')) {
                                                        imageFormat = 'GIF';
                                                    } else if (image.base64Data.startsWith('data:image/webp')) {
                                                        imageFormat = 'WEBP';
                                                    }
                                                    
                                                    // Extract base64 data without the data URL prefix
                                                    const base64Data = image.base64Data.split(',')[1];
                                                    
                                                    doc.addImage(base64Data, imageFormat, imgX, imgY, imgWidth, imgHeight);
                                                }
                                                
                                                // Add image name below
                                                doc.setTextColor(100, 100, 100);
                                                doc.setFontSize(8);
                                                doc.setFont('helvetica', 'normal');
                                                const shortName = image.name.length > 12 ? image.name.substring(0, 12) + '...' : image.name;
                                                doc.text(shortName, imgX, imgY + imgHeight + 5);
                                                
                                                // Update detailY for next content
                                                if (imgIndex === itemData.images.length - 1) {
                                                    const totalRows = Math.floor((itemData.images.length - 1) / maxImagesPerRow) + 1;
                                                    detailY += (totalRows * (imgHeight + 15)) + 5;
                                                }
                                            } catch (error) {
                                                console.error('Error adding image to PDF:', error);
                                                doc.text(`Error al cargar imagen ${imgIndex + 1}`, 25, detailY);
                                                detailY += 8;
                                            }
                                        });
                                    }
                                } else if (itemType === 'activity') {
                                    if (itemData.startTime) {
                                        doc.setTextColor(100, 100, 100);
                                        doc.setFontSize(10);
                                        doc.setFont('helvetica', 'normal');
                                        doc.text(`Hora de inicio: ${itemData.startTime}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.endTime) {
                                        doc.text(`Hora de fin: ${itemData.endTime}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.description) {
                                        doc.text(`Descripción: ${itemData.description}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.location) {
                                        doc.text(`Ubicación: ${itemData.location}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.images && itemData.images.length > 0) {
                                        doc.text(`Imágenes adjuntas: ${itemData.images.length}`, 25, detailY);
                                        detailY += 8;
                                        
                                        // Add images to PDF with better layout
                                        const maxImagesPerRow = 3;
                                        const imgWidth = 50;
                                        const imgHeight = 35;
                                        const imgSpacing = 60;
                                        
                                        itemData.images.forEach((image, imgIndex) => {
                                            try {
                                                const row = Math.floor(imgIndex / maxImagesPerRow);
                                                const col = imgIndex % maxImagesPerRow;
                                                const imgX = 25 + (col * imgSpacing);
                                                const imgY = detailY + (row * (imgHeight + 15));
                                                
                                                // Add image border
                                                doc.setDrawColor(200, 200, 200);
                                                doc.setLineWidth(0.5);
                                                doc.rect(imgX - 1, imgY - 1, imgWidth + 2, imgHeight + 2, 'S');
                                                
                                                // Add image to PDF using base64 data
                                                if (image.base64Data) {
                                                    // Determine image format from base64 data
                                                    let imageFormat = 'JPEG';
                                                    if (image.base64Data.startsWith('data:image/png')) {
                                                        imageFormat = 'PNG';
                                                    } else if (image.base64Data.startsWith('data:image/gif')) {
                                                        imageFormat = 'GIF';
                                                    } else if (image.base64Data.startsWith('data:image/webp')) {
                                                        imageFormat = 'WEBP';
                                                    }
                                                    
                                                    // Extract base64 data without the data URL prefix
                                                    const base64Data = image.base64Data.split(',')[1];
                                                    
                                                    doc.addImage(base64Data, imageFormat, imgX, imgY, imgWidth, imgHeight);
                                                }
                                                
                                                // Add image name below
                                                doc.setTextColor(100, 100, 100);
                                                doc.setFontSize(8);
                                                doc.setFont('helvetica', 'normal');
                                                const shortName = image.name.length > 12 ? image.name.substring(0, 12) + '...' : image.name;
                                                doc.text(shortName, imgX, imgY + imgHeight + 5);
                                                
                                                // Update detailY for next content
                                                if (imgIndex === itemData.images.length - 1) {
                                                    const totalRows = Math.floor((itemData.images.length - 1) / maxImagesPerRow) + 1;
                                                    detailY += (totalRows * (imgHeight + 15)) + 5;
                                                }
                                            } catch (error) {
                                                console.error('Error adding image to PDF:', error);
                                                doc.text(`Error al cargar imagen ${imgIndex + 1}`, 25, detailY);
                                                detailY += 8;
                                            }
                                        });
                                    }
                                } else if (itemType === 'transport') {
                                    if (itemData.pickupTime) {
                                        doc.setTextColor(100, 100, 100);
                                        doc.setFontSize(10);
                                        doc.setFont('helvetica', 'normal');
                                        doc.text(`Hora de recogida: ${itemData.pickupTime}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.duration) {
                                        doc.text(`Duración: ${itemData.duration}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.pickupLocation) {
                                        doc.text(`Punto de recogida: ${itemData.pickupLocation}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.destination) {
                                        doc.text(`Destino: ${itemData.destination}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.notes) {
                                        doc.text(`Notas: ${itemData.notes}`, 25, detailY);
                                        detailY += 8;
                                    }
                                } else if (itemType === 'note') {
                                    if (itemData.content) {
                                        doc.setTextColor(100, 100, 100);
                                        doc.setFontSize(10);
                                        doc.setFont('helvetica', 'normal');
                                        doc.text(`Contenido: ${itemData.content}`, 25, detailY);
                                        detailY += 8;
                                    }
                                    if (itemData.noteType) {
                                        const noteTypeLabels = {
                                            info: 'Información general',
                                            warning: 'Advertencia importante',
                                            tip: 'Consejo útil',
                                            contact: 'Información de contacto'
                                        };
                                        doc.text(`Tipo: ${noteTypeLabels[itemData.noteType] || itemData.noteType}`, 25, detailY);
                                        detailY += 8;
                                    }
                                }
                                
                                yPosition = detailY + 15;
                                
                                // Check if we need a new page within the same day
                                if (yPosition > 250) {
                                    doc.addPage();
                                    yPosition = 30;
                                }
                            });
                        } else {
                            // Empty day message
                            doc.setTextColor(150, 150, 150);
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'italic');
                            doc.text('No hay actividades programadas para este día', 25, yPosition + 10);
                            yPosition += 25;
                        }
                    });
                    
                    // Save the PDF
                    const fileName = `itinerario_${itineraryTitle.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    
                    // Reset button
                    setTimeout(() => {
                        button.innerHTML = '<i class="fas fa-check"></i> PDF Generado';
                        button.style.background = 'var(--mint)';
                        
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.style.background = '';
                            button.disabled = false;
                        }, 2000);
                    }, 500);
                    
                    showNotification('¡PDF generado!', 'El itinerario se ha descargado correctamente');
                    
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }, 300);
        }

        function restoreEditorState(editorState) {
            console.log('Restoring editor state:', editorState);
            
            // Restore global variables
            itemsData = editorState.itemsData || {};
            itemCounter = editorState.itemCounter || 0;
            dayCounter = editorState.dayCounter || 1;
            currentEditingItem = editorState.currentEditingItem || null;
            
            // Restore trip title
            const tripTitleInput = document.getElementById('tripTitle');
            if (tripTitleInput && editorState.tripTitle) {
                tripTitleInput.value = editorState.tripTitle;
            }
            
            // Restore start date
            const startDateInput = document.getElementById('startDate');
            if (startDateInput && editorState.startDate) {
                startDateInput.value = editorState.startDate;
                startDate = new Date(editorState.startDate + 'T00:00:00');
            }
            
            // Clear existing timeline
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            
            // Recreate day containers and items
            if (editorState.itemsData) {
                // Group items by day
                const itemsByDay = {};
                Object.values(editorState.itemsData).forEach(item => {
                    if (item && item.day !== undefined) {
                        if (!itemsByDay[item.day]) {
                            itemsByDay[item.day] = [];
                        }
                        itemsByDay[item.day].push(item);
                    }
                });
                
                // Create day containers
                const dayNumbers = Object.keys(itemsByDay).filter(day => day > 0).sort((a, b) => parseInt(a) - parseInt(b));
                dayCounter = Math.max(1, dayNumbers.length);
                
                dayNumbers.forEach(dayNumber => {
                    createDayContainer(parseInt(dayNumber));
                });
                
                // If no days with items, create at least one day
                if (dayNumbers.length === 0) {
                    createDayContainer(1);
                }
                
                // Add items to their respective days
                Object.values(editorState.itemsData).forEach(item => {
                    if (item && item.type) {
                        if (item.day === 0) {
                            // Summary item - add to top of timeline
                            const summaryItem = createTimelineItemFromData(item);
                            timeline.insertBefore(summaryItem, timeline.firstChild);
                        } else if (item.day === -1) {
                            // Total item - add to end of timeline
                            const totalItem = createTimelineItemFromData(item);
                            timeline.appendChild(totalItem);
                        } else if (item.day > 0) {
                            // Regular item - add to day container
                            const dayContainer = document.querySelector(`[data-day="${item.day}"]`);
                            if (dayContainer) {
                                const dayItems = dayContainer.querySelector('.day-items');
                                const timelineItem = createTimelineItemFromData(item);
                                dayItems.appendChild(timelineItem);
                                
                                // Remove placeholder if exists
                                const placeholder = dayItems.querySelector('[style*="text-align: center"]');
                                if (placeholder) placeholder.remove();
                            }
                        }
                    }
                });
                
                // Update dates for all days
                updateItineraryDatesSilently();
                
                // Sort items in all days
                document.querySelectorAll('.day-container').forEach(container => {
                    sortItemsByTime(container);
                });
                
                // Update summaries if they exist
                updateAllSummaries();
            }
            
            // Initialize drag and drop for restored elements
            initializeDragAndDrop();
            makeExistingItemsClickable();
            
            // Update save status
            setTimeout(() => {
                updateSaveStatus();
            }, 500);
            
            // Show notification that state was restored
            showNotification('Estado Restaurado', 'Tu itinerario se ha restaurado exactamente como estaba antes de la vista previa.');
            
            console.log('Editor state restored successfully');
        }
        
        function createDayContainer(dayNumber) {
            const timeline = document.getElementById('timeline');
            
            const dayContainer = document.createElement('div');
            dayContainer.className = 'day-container';
            dayContainer.setAttribute('data-day', dayNumber);
            
            // Calculate the date for this day
            let dayDate = 'Selecciona fecha de inicio';
            if (startDate) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + (dayNumber - 1));
                dayDate = formatDate(currentDate);
            }
            
            dayContainer.innerHTML = `
                <div class="day-actions">
                    <button class="day-btn" onclick="deleteDay(this)">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
                <div class="day-header">
                    <div class="day-title">Día ${dayNumber}</div>
                    <div class="day-date" data-date="">${dayDate}</div>
                </div>
                <div class="day-items">
                    <div style="text-align: center; padding: 2rem; color: #666; font-style: italic;">
                        <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 1rem; display: block; color: var(--primary-blue);"></i>
                        Arrastra elementos aquí para personalizar este día
                    </div>
                </div>
            `;
            
            timeline.appendChild(dayContainer);
            
            // Make the day container droppable
            dayContainer.addEventListener('dragover', handleDragOver);
            dayContainer.addEventListener('drop', handleDrop);
            dayContainer.addEventListener('dragenter', handleDragEnter);
            dayContainer.addEventListener('dragleave', handleDragLeave);
        }
        
        function createTimelineItemFromData(itemData) {
            const item = document.createElement('div');
            item.className = `timeline-item ${itemData.type}`;
            item.setAttribute('data-item-id', itemData.id || itemData.itemId);
            item.style.transition = 'all 0.3s ease';
            
            const iconMap = {
                flight: 'fa-plane',
                hotel: 'fa-bed',
                activity: 'fa-map-marker-alt',
                transport: 'fa-car',
                note: 'fa-sticky-note',
                summary: 'fa-clipboard-list',
                total: 'fa-dollar-sign'
            };
            
            if (itemData.type === 'summary') {
                item.innerHTML = `
                    <i class="fas ${iconMap[itemData.type]} element-icon ${itemData.type}"></i>
                    <div class="item-info">
                        <div class="item-title">${itemData.title || 'Resumen de Itinerario'}</div>
                        <div class="item-description">${itemData.description || ''}</div>
                    </div>
                    <div class="item-actions">
                        <button class="summary-update-btn" onclick="updateSummary(${itemData.id || itemData.itemId})">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                        <button class="item-btn" onclick="deleteItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            } else if (itemData.type === 'total') {
                item.innerHTML = `
                    <i class="fas ${iconMap[itemData.type]} element-icon ${itemData.type}"></i>
                    <div class="item-info">
                        <div class="item-title">${itemData.title || 'Valor Total del Viaje'}</div>
                        <div class="item-description">${itemData.description || ''}</div>
                    </div>
                    <div class="item-actions">
                        <button class="item-btn" onclick="editItem(this)">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="item-btn" onclick="deleteItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            } else {
                item.innerHTML = `
                    <i class="fas ${iconMap[itemData.type]} element-icon ${itemData.type}"></i>
                    <div class="item-info">
                        <div class="item-title">${itemData.title || 'Sin título'}</div>
                        <div class="item-description">${itemData.description || ''}</div>
                    </div>
                    <div class="item-actions">
                        <button class="item-btn" onclick="editItem(this)">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="item-btn" onclick="deleteItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }
            
            // Make the entire item clickable
            item.addEventListener('click', function(e) {
                // Don't trigger if clicking on action buttons
                if (!e.target.closest('.item-actions')) {
                    editItem(this.querySelector('.item-btn'));
                }
            });
            
            return item;
        }

        function previewItinerary() {
            // Save complete editor state before opening preview
            const editorState = {
                tripTitle: document.getElementById('tripTitle').value.trim() || 'Mi Viaje',
                startDate: document.getElementById('startDate').value,
                itemsData: JSON.parse(JSON.stringify(itemsData)), // Deep copy
                itemCounter: itemCounter,
                dayCounter: dayCounter,
                currentEditingItem: currentEditingItem,
                timestamp: Date.now()
            };
            
            // Save editor state to sessionStorage
            sessionStorage.setItem('editor_state_backup', JSON.stringify(editorState));
            
            // Get current trip data
            const tripTitle = document.getElementById('tripTitle').value.trim() || 'Mi Viaje';
            const startDate = document.getElementById('startDate').value;
            const dayContainers = document.querySelectorAll('.day-container');
            
            // Calculate end date
            let endDate = '';
            if (startDate && dayContainers.length > 0) {
                const startDateObj = new Date(startDate + 'T00:00:00');
                const endDateObj = new Date(startDate + 'T00:00:00');
                endDateObj.setDate(startDateObj.getDate() + dayContainers.length - 1);
                endDate = endDateObj.toISOString().split('T')[0];
            }
            
            // Create trip data in the format expected by preview
            const tripData = {
                id: 'temp_' + Date.now(),
                title: tripTitle,
                startDate: startDate,
                endDate: endDate,
                itemsData: JSON.parse(JSON.stringify(itemsData)), // Deep copy
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Save to sessionStorage for temporary preview
            sessionStorage.setItem('temp_trip_preview', JSON.stringify(tripData));
            
            // Open preview in new tab
            const previewUrl = `viantryp_preview.html?trip=${tripData.id}&mode=preview`;
            window.open(previewUrl, '_blank');
        }

        function showNotification(title, message, duration = 4000) {
            const notification = document.getElementById('notification');
            const notificationTitle = notification.querySelector('.notification-title');
            const notificationMessage = document.getElementById('notificationMessage');
            
            if (!notification || !notificationTitle || !notificationMessage) {
                console.error('Notification elements not found');
                return;
            }
            
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            // Ensure the notification is visible before adding the show class
            notification.style.display = 'flex';
            
            // Force a reflow to ensure the display change takes effect
            notification.offsetHeight;
            
            notification.classList.add('show');
            
            // Auto hide after specified duration (default 4 seconds)
            setTimeout(() => {
                hideNotification();
            }, duration);
            
            // Log for debugging
            console.log('Notification shown:', title, message);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            
            if (!notification) {
                console.error('Notification element not found');
                return;
            }
            
            notification.classList.remove('show');
            
            // Wait for animation to complete, then hide the element completely
            setTimeout(() => {
                notification.style.display = 'none';
            }, 500); // Match the transition duration from CSS
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('editModal');
            const pdfPreviewModal = document.getElementById('pdfPreviewModal');
            const tripNameModal = document.getElementById('tripNameModal');
            
            if (e.target === modal) {
                closeModal();
            }
            
            if (e.target === pdfPreviewModal) {
                closePDFPreview();
            }
            
            if (e.target === tripNameModal) {
                closeTripNameModal();
            }
            
            if (e.target === saveChangesModal) {
                closeSaveChangesModal();
            }
            

        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const tripNameModal = document.getElementById('tripNameModal');
                const editModal = document.getElementById('editModal');
                const pdfPreviewModal = document.getElementById('pdfPreviewModal');
                const saveChangesModal = document.getElementById('saveChangesModal');
                
                if (tripNameModal.classList.contains('show')) {
                    closeTripNameModal();
                } else if (editModal.classList.contains('show')) {
                    closeModal();
                } else if (pdfPreviewModal.classList.contains('show')) {
                    closePDFPreview();
                                } else if (saveChangesModal.classList.contains('show')) {
                    closeSaveChangesModal();
                }
            }
        });

        // Auto-save functions
        function createNewTrip() {
            const urlParams = new URLSearchParams(window.location.search);
            const tripId = urlParams.get('trip');
            
            if (!tripId) {
                // Show the trip name modal instead of creating automatically
                showTripNameModal();
            }
        }

        function autoSave() {
            try {
                const tripTitle = document.getElementById('tripTitle')?.value?.trim() || 'Mi Viaje';
                const startDate = document.getElementById('startDate')?.value;
                const dayContainers = document.querySelectorAll('.day-container');
                
                // Calculate end date
                let endDate = '';
                if (startDate && dayContainers.length > 0) {
                    const startDateObj = new Date(startDate + 'T00:00:00');
                    const endDateObj = new Date(startDate + 'T00:00:00');
                    endDateObj.setDate(startDateObj.getDate() + dayContainers.length - 1);
                    endDate = endDateObj.toISOString().split('T')[0];
                }
                
                // Format dates
                const formatDate = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString + 'T00:00:00');
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                };
                
                const startDateFormatted = formatDate(startDate);
                const endDateFormatted = formatDate(endDate);
                const dateRange = startDateFormatted && endDateFormatted ? `${startDateFormatted} - ${endDateFormatted}` : 'Sin fecha';
                
                // Get trip ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const tripId = urlParams.get('trip');
                
                if (tripId) {
                    // Get existing trips
                    let existingTrips = JSON.parse(localStorage.getItem('viantryp_trips') || '[]');
                    
                    // Find existing trip or create new one
                    let tripIndex = existingTrips.findIndex(t => t.id == tripId);
                    
                    if (tripIndex === -1) {
                        // Create new trip
                        const newTrip = {
                            id: parseInt(tripId),
                            title: tripTitle,
                            dates: dateRange,
                            duration: `${dayContainers.length} días`,
                            status: 'draft',
                            startDate: startDate,
                            endDate: endDate,
                            itemsData: JSON.parse(JSON.stringify(itemsData)), // Deep copy to ensure data integrity
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        existingTrips.push(newTrip);
                        tripIndex = existingTrips.length - 1;
                    } else {
                        // Update existing trip
                        existingTrips[tripIndex] = {
                            ...existingTrips[tripIndex],
                            title: tripTitle,
                            dates: dateRange,
                            duration: `${dayContainers.length} días`,
                            startDate: startDate,
                            endDate: endDate,
                            itemsData: JSON.parse(JSON.stringify(itemsData)), // Deep copy to ensure data integrity
                            updatedAt: new Date().toISOString()
                        };
                    }
                    
                    // Save to localStorage with error handling (silent)
                    try {
                        localStorage.setItem('viantryp_trips', JSON.stringify(existingTrips));
                        
                        // Also save a backup copy
                        localStorage.setItem(`viantryp_trip_backup_${tripId}`, JSON.stringify({
                            trip: existingTrips[tripIndex],
                            timestamp: new Date().toISOString()
                        }));
                        
                        // Record the timestamp of successful auto-save
                        sessionStorage.setItem('last_auto_save', Date.now().toString());
                        console.log('Auto-save successful for trip:', tripId);
                    } catch (storageError) {
                        console.error('Storage error during auto-save:', storageError);
                        showNotification('Error de guardado', 'No se pudo guardar automáticamente. Intenta guardar manualmente.');
                    }
                }
            } catch (error) {
                console.error('Error in auto-save:', error);
            }
        }

        // Enhanced save function with better error handling
        function manualSave() {
            try {
                const tripTitle = document.getElementById('tripTitle')?.value?.trim() || 'Mi Viaje';
                const startDate = document.getElementById('startDate')?.value;
                const dayContainers = document.querySelectorAll('.day-container');
                
                // Calculate end date
                let endDate = '';
                if (startDate && dayContainers.length > 0) {
                    const startDateObj = new Date(startDate + 'T00:00:00');
                    const endDateObj = new Date(startDate + 'T00:00:00');
                    endDateObj.setDate(startDateObj.getDate() + dayContainers.length - 1);
                    endDate = endDateObj.toISOString().split('T')[0];
                }
                
                // Format dates
                const formatDate = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString + 'T00:00:00');
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                };
                
                const startDateFormatted = formatDate(startDate);
                const endDateFormatted = formatDate(endDate);
                const dateRange = startDateFormatted && endDateFormatted ? `${startDateFormatted} - ${endDateFormatted}` : 'Sin fecha';
                
                // Get trip ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const tripId = urlParams.get('trip');
                
                if (tripId) {
                    // Get existing trips
                    let existingTrips = JSON.parse(localStorage.getItem('viantryp_trips') || '[]');
                    
                    // Find existing trip or create new one
                    let tripIndex = existingTrips.findIndex(t => t.id == tripId);
                    
                    if (tripIndex === -1) {
                        // Create new trip
                        const newTrip = {
                            id: parseInt(tripId),
                            title: tripTitle,
                            dates: dateRange,
                            duration: `${dayContainers.length} días`,
                            status: 'draft',
                            startDate: startDate,
                            endDate: endDate,
                            itemsData: JSON.parse(JSON.stringify(itemsData)), // Deep copy
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        existingTrips.push(newTrip);
                        tripIndex = existingTrips.length - 1;
                    } else {
                        // Update existing trip
                        existingTrips[tripIndex] = {
                            ...existingTrips[tripIndex],
                            title: tripTitle,
                            dates: dateRange,
                            duration: `${dayContainers.length} días`,
                            startDate: startDate,
                            endDate: endDate,
                            itemsData: JSON.parse(JSON.stringify(itemsData)), // Deep copy
                            updatedAt: new Date().toISOString()
                        };
                    }
                    
                    // Save to localStorage with multiple backup strategies
                    try {
                        // Primary save
                        localStorage.setItem('viantryp_trips', JSON.stringify(existingTrips));
                        
                        // Backup save
                        localStorage.setItem(`viantryp_trip_backup_${tripId}`, JSON.stringify({
                            trip: existingTrips[tripIndex],
                            timestamp: new Date().toISOString()
                        }));
                        
                        // Session backup
                        sessionStorage.setItem(`viantryp_trip_session_${tripId}`, JSON.stringify({
                            trip: existingTrips[tripIndex],
                            timestamp: new Date().toISOString()
                        }));
                        
                        // Save successful
                        console.log('Manual save successful for trip:', tripId);
                        
                        // Show success notification
                        showNotification('Guardado Exitoso', 'Tu itinerario se ha guardado correctamente.');
                        
                        return true;
                    } catch (storageError) {
                        console.error('Storage error during manual save:', storageError);
                        // Show error notification
                        showNotification('Error al Guardar', 'Hubo un problema al guardar tu itinerario. Inténtalo de nuevo.');
                        return false;
                    }
                } else {
                    console.error('No trip ID found for saving');
                    showNotification('Error al Guardar', 'No se pudo identificar el viaje para guardar.');
                    return false;
                }
            } catch (error) {
                console.error('Error in manual save:', error);
                showNotification('Error al Guardar', 'Ocurrió un error inesperado al guardar.');
                return false;
            }
        }

        // Function to recover from backup if needed
        function recoverFromBackup(tripId) {
            try {
                // Try session storage first
                const sessionBackup = sessionStorage.getItem(`viantryp_trip_session_${tripId}`);
                if (sessionBackup) {
                    const backupData = JSON.parse(sessionBackup);
                    return backupData.trip;
                }
                
                // Try localStorage backup
                const localBackup = localStorage.getItem(`viantryp_trip_backup_${tripId}`);
                if (localBackup) {
                    const backupData = JSON.parse(localBackup);
                    return backupData.trip;
                }
                
                return null;
            } catch (error) {
                console.error('Error recovering from backup:', error);
                return null;
            }
        }

        // Enhanced load function with backup recovery
        function loadSavedTrip(tripId) {
            try {
                console.log('Loading saved trip with ID:', tripId);
                
                // Show loading notification
                showNotification('Cargando Viaje', 'Restaurando tu itinerario...');
                
                const savedTrips = JSON.parse(localStorage.getItem('viantryp_trips') || '[]');
                let trip = savedTrips.find(t => t.id == tripId);
                
                console.log('Found trip in storage:', trip);
                
                // If trip not found in main storage, try backup
                if (!trip) {
                    trip = recoverFromBackup(tripId);
                    if (trip) {
                        // Data recovered from backup
                    }
                }
                
                if (trip) {
                    console.log('Loading trip data:', trip);
                    
                    // Load trip data
                    if (trip.title) {
                        const tripTitleInput = document.getElementById('tripTitle');
                        if (tripTitleInput) {
                            tripTitleInput.value = trip.title;
                            console.log('Set trip title:', trip.title);
                        }
                    }
                    
                    if (trip.startDate) {
                        const startDateInput = document.getElementById('startDate');
                        if (startDateInput) {
                            startDateInput.value = trip.startDate;
                            // Set the global startDate variable
                            startDate = new Date(trip.startDate + 'T00:00:00');
                            console.log('Set start date:', trip.startDate);
                        }
                    }
                    
                    if (trip.itemsData && Object.keys(trip.itemsData).length > 0) {
                        itemsData = JSON.parse(JSON.stringify(trip.itemsData)); // Deep copy
                        itemCounter = Math.max(...Object.keys(trip.itemsData).map(Number)) + 1;
                        console.log('Loaded items data:', itemsData);
                        console.log('Set item counter to:', itemCounter);
                    } else {
                        itemsData = {};
                        itemCounter = 0;
                        console.log('No items data found, initialized empty');
                    }
                    
                    // Update dates first
                    updateItineraryDatesSilently();
                    
                    // Update page title
                    updateTripTitleInRealTime();
                    
                    // Rebuild timeline if needed
                    if (Object.keys(itemsData).length > 0) {
                        console.log('Rebuilding timeline with items...');
                        rebuildTimeline();
                    } else {
                        console.log('No items to rebuild, keeping default timeline');
                    }
                    
                    // Success notification removed - no longer needed
                    
                    // Auto-save to ensure everything is properly saved
                    setTimeout(() => {
                        autoSave();
                    }, 1000);
                    
                    // Show success notification
                    showNotification('Viaje Cargado', 'Tu itinerario se ha cargado exactamente como lo dejaste.');
                } else {
                    console.log('Trip not found in storage');
                    showNotification('Viaje No Encontrado', 'No se pudo encontrar el viaje guardado.');
                }
            } catch (error) {
                console.error('Error loading saved trip:', error);
            }
        }

        function rebuildTimeline() {
            const timeline = document.getElementById('timeline');
            if (!timeline) {
                console.error('Timeline element not found');
                return;
            }
            
            console.log('Rebuilding timeline...');
            console.log('Current itemsData:', itemsData);
            console.log('Current startDate:', startDate);
            
            timeline.innerHTML = ''; // Clear existing timeline

            let maxDay = 1;
            if (Object.keys(itemsData).length > 0) {
                maxDay = Math.max(...Object.keys(itemsData).map(key => {
                    const item = itemsData[key];
                    return item.day || 1;
                }));
            }
            
            console.log('Max day calculated:', maxDay);

            for (let day = 1; day <= maxDay; day++) {
                const dayContainer = document.createElement('div');
                dayContainer.className = 'day-container';
                dayContainer.setAttribute('data-day', day);
                
                // Calculate the date for this day
                let dayDate = 'Selecciona fecha de inicio';
                if (startDate) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + (day - 1));
                    dayDate = formatDate(currentDate);
                }
                
                dayContainer.innerHTML = `
                    <div class="day-actions">
                        <button class="day-btn" onclick="deleteDay(this)">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                    <div class="day-header">
                        <div class="day-title">Día ${day}</div>
                        <div class="day-date" data-date="">${dayDate}</div>
                    </div>
                    <div class="day-items">
                        <div style="text-align: center; padding: 2rem; color: #666; font-style: italic;">
                            <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 1rem; display: block; color: var(--primary-blue);"></i>
                            Arrastra elementos aquí para personalizar este día
                        </div>
                    </div>
                `;
                timeline.appendChild(dayContainer);
                
                // Make the day container droppable
                dayContainer.addEventListener('dragover', handleDragOver);
                dayContainer.addEventListener('drop', handleDrop);
                dayContainer.addEventListener('dragenter', handleDragEnter);
                dayContainer.addEventListener('dragleave', handleDragLeave);
            }
            
            // Now rebuild the items for each day
            rebuildTimelineItems();
            
            dayCounter = maxDay;
            if (startDate) {
                updateItineraryDatesSilently();
            }
            makeExistingItemsClickable();
            
            console.log('Timeline rebuild completed');
        }

        function rebuildTimelineItems() {
            console.log('Rebuilding timeline items...');
            
            // Group items by day
            const itemsByDay = {};
            const summaryItems = [];
            
            Object.keys(itemsData).forEach(itemKey => {
                const item = itemsData[itemKey];
                if (item && item.type) {
                    if (item.type === 'summary') {
                        // Summary items go to the top
                        summaryItems.push({...item, id: itemKey});
                    } else {
                        let day = item.day || 1;
                        if (!itemsByDay[day]) {
                            itemsByDay[day] = [];
                        }
                        itemsByDay[day].push({...item, id: itemKey});
                    }
                }
            });
            
            console.log('Items grouped by day:', itemsByDay);
            console.log('Summary items:', summaryItems);

            // Handle summary items first - add to top of timeline
            const timeline = document.getElementById('timeline');
            if (summaryItems.length > 0) {
                console.log('Adding summary items to timeline...');
                // Remove existing summary items
                timeline.querySelectorAll('.timeline-item.summary').forEach(summary => summary.remove());
                
                // Add summary items at the top
                summaryItems.forEach(item => {
                    const timelineItem = createTimelineItemFromData(item);
                    timeline.insertBefore(timelineItem, timeline.firstChild);
                });
            }

            // Rebuild items for each day
            Object.keys(itemsByDay).forEach(dayNumber => {
                console.log(`Rebuilding items for day ${dayNumber}:`, itemsByDay[dayNumber]);
                const dayContainer = document.querySelector(`[data-day="${dayNumber}"]`);
                if (dayContainer) {
                    const dayItems = dayContainer.querySelector('.day-items');
                    
                    // Clear placeholder
                    dayItems.innerHTML = '';
                    
                    // Add items for this day
                    itemsByDay[dayNumber].forEach(item => {
                        const timelineItem = createTimelineItemFromData(item);
                        dayItems.appendChild(timelineItem);
                    });
                    
                    // Sort items by time within this day
                    sortItemsByTime(dayContainer);
                } else {
                    console.error(`Day container for day ${dayNumber} not found`);
                }
            });
            
            console.log('Timeline items rebuild completed');
        }

        function createTimelineItemFromData(itemData) {
            console.log('Creating timeline item from data:', itemData);
            
            if (!itemData || !itemData.type) {
                console.error('Invalid item data:', itemData);
                return null;
            }
            
            const item = document.createElement('div');
            item.className = `timeline-item ${itemData.type}`;
            item.setAttribute('data-item-id', itemData.id);
            item.style.transition = 'all 0.3s ease';
            
            const iconMap = {
                flight: 'fa-plane',
                hotel: 'fa-bed',
                activity: 'fa-map-marker-alt',
                transport: 'fa-car',
                note: 'fa-sticky-note',
                summary: 'fa-clipboard-list'
            };
            
            if (itemData.type === 'summary') {
                // Special handling for summary element
                const summaryContent = generateItinerarySummary();
                item.innerHTML = `
                    <i class="fas ${iconMap[itemData.type]} element-icon ${itemData.type}"></i>
                    <div class="item-info">
                        <div class="item-title">${itemData.title || 'Sin título'}</div>
                        <div class="item-description">${summaryContent}</div>
                    </div>
                    <div class="item-actions">
                        <button class="summary-update-btn" onclick="updateSummary(${itemData.id})">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                        <button class="item-btn" onclick="deleteItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            } else {
                item.innerHTML = `
                    <i class="fas ${iconMap[itemData.type]} element-icon ${itemData.type}"></i>
                    <div class="item-info">
                        <div class="item-title">${itemData.title || 'Sin título'}</div>
                        <div class="item-description">${itemData.description || itemData.content || ''}</div>
                    </div>
                    <div class="item-actions">
                        <button class="item-btn" onclick="editItem(this)">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="item-btn" onclick="deleteItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }
            
            // Make the entire item clickable
            item.addEventListener('click', function(e) {
                // Don't trigger if clicking on action buttons
                if (!e.target.closest('.item-actions')) {
                    editItem(this.querySelector('.item-btn'));
                }
            });
            
            console.log('Timeline item created successfully:', item);
            return item;
        }

        function showAutoSaveNotification() {
            // Auto-save is now silent - no notification shown
            // This function is kept for compatibility but does nothing
        }

        function showSavingIndicator() {
            // Saving indicator is now silent - no notification shown
            // This function is kept for compatibility but does nothing
        }

        function updateTripTitleInRealTime() {
            const tripTitle = document.getElementById('tripTitle')?.value?.trim();
            
            // Update page title
            document.title = `Viantryp - ${tripTitle || 'Mi Viaje'}`;
            
            // Update save status indicator
            updateSaveStatus();
        }
        
        function generateTripTitleFromFlights() {
            const flightItems = Object.values(itemsData).filter(item => item.type === 'flight');
            
            if (flightItems.length > 0) {
                const firstFlight = flightItems[0];
                const lastFlight = flightItems[flightItems.length - 1];
                
                if (firstFlight.originCity && lastFlight.destinationCity) {
                    const tripTitleInput = document.getElementById('tripTitle');
                    if (tripTitleInput && !tripTitleInput.value.trim()) {
                        const newTitle = `Viaje desde ${firstFlight.originCity} hacia ${lastFlight.destinationCity}`;
                        tripTitleInput.value = newTitle;
                        updateTripTitleInRealTime();
                    }
                }
            }
        }
        
        function formatFlightDateTime(dateTime) {
            if (!dateTime) return '';
            
            const date = new Date(dateTime);
            const months = [
                'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun',
                'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'
            ];
            
            const day = date.getDate().toString().padStart(2, '0');
            const month = months[date.getMonth()];
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return `${day} ${month} ${hours}:${minutes}`;
        }
        
        function getCityFromAirportCode(code) {
            const airport = airportsList.find(airport => airport.code === code);
            return airport ? airport.city : code;
        }
        
        function calculateFlightDuration(departureDateTime, arrivalDateTime) {
            if (!departureDateTime || !arrivalDateTime) return '';
            
            const departure = new Date(departureDateTime);
            const arrival = new Date(arrivalDateTime);
            const durationMs = arrival - departure;
            
            if (durationMs <= 0) return '';
            
            const hours = Math.floor(durationMs / (1000 * 60 * 60));
            const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }
        
        function updateSaveStatus() {
            const tripTitle = document.getElementById('tripTitle')?.value?.trim();
            const hasItems = Object.keys(itemsData).length > 0;
            const hasCustomTitle = tripTitle && tripTitle !== 'Mi Viaje';
            
            // Update save button state
            const saveButton = document.querySelector('button[onclick="manualSave()"]');
            if (saveButton) {
                if (hasItems || hasCustomTitle) {
                    saveButton.innerHTML = '<i class="fas fa-save"></i> Guardar';
                    saveButton.style.background = 'var(--primary-blue)';
                } else {
                    saveButton.innerHTML = '<i class="fas fa-save"></i> Guardar (vacío)';
                    saveButton.style.background = '#6c757d';
                }
            }
            
            // Check if data is missing and try to reload
            const urlParams = new URLSearchParams(window.location.search);
            const tripId = urlParams.get('trip');
            if (tripId && !hasItems && !hasCustomTitle) {
                console.log('Data seems to be missing, attempting to reload...');
                setTimeout(() => {
                    loadSavedTrip(tripId);
                }, 500);
            }
        }
        
        // Airport autocomplete functions
        function setupAirportAutocomplete(inputId, containerId) {
            const airportInput = document.getElementById(inputId);
            if (!airportInput) return;
            
            // Create autocomplete container
            let autocompleteContainer = document.getElementById(containerId);
            if (!autocompleteContainer) {
                autocompleteContainer = document.createElement('div');
                autocompleteContainer.id = containerId;
                autocompleteContainer.style.cssText = `
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 1px solid #ddd;
                    border-top: none;
                    max-height: 200px;
                    overflow-y: auto;
                    z-index: 1000;
                    display: none;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                `;
                airportInput.parentNode.style.position = 'relative';
                airportInput.parentNode.appendChild(autocompleteContainer);
            }
            
            airportInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length < 2) {
                    autocompleteContainer.style.display = 'none';
                    return;
                }
                
                const matches = airportsList.filter(airport => 
                    airport.code.toLowerCase().includes(query) ||
                    airport.name.toLowerCase().includes(query) ||
                    airport.city.toLowerCase().includes(query) ||
                    airport.country.toLowerCase().includes(query)
                ).slice(0, 8); // Limit to 8 results
                
                if (matches.length > 0) {
                    autocompleteContainer.innerHTML = matches.map(airport => 
                        `<div class="autocomplete-item" onclick="selectAirport('${inputId}', '${airport.code}', '${airport.name}', '${airport.city}', '${airport.country}')">
                            <div style="font-weight: bold; color: #333;">${airport.code} - ${airport.name}</div>
                            <div style="font-size: 0.9em; color: #666;">${airport.city}, ${airport.country}</div>
                        </div>`
                    ).join('');
                    autocompleteContainer.style.display = 'block';
                } else {
                    autocompleteContainer.style.display = 'none';
                }
            });
            
            // Hide autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!airportInput.contains(e.target) && !autocompleteContainer.contains(e.target)) {
                    autocompleteContainer.style.display = 'none';
                }
            });
            
            // Handle keyboard navigation
            airportInput.addEventListener('keydown', function(e) {
                const items = autocompleteContainer.querySelectorAll('.autocomplete-item');
                const currentIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (currentIndex < items.length - 1) {
                        items.forEach(item => item.classList.remove('selected'));
                        items[currentIndex + 1].classList.add('selected');
                    } else if (items.length > 0) {
                        items.forEach(item => item.classList.remove('selected'));
                        items[0].classList.add('selected');
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (currentIndex > 0) {
                        items.forEach(item => item.classList.remove('selected'));
                        items[currentIndex - 1].classList.add('selected');
                    } else if (items.length > 0) {
                        items.forEach(item => item.classList.remove('selected'));
                        items[items.length - 1].classList.add('selected');
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentIndex >= 0) {
                        const item = items[currentIndex];
                        const onclick = item.getAttribute('onclick');
                        if (onclick) {
                            eval(onclick);
                        }
                    }
                } else if (e.key === 'Escape') {
                    autocompleteContainer.style.display = 'none';
                }
            });
        }
        
        function selectAirport(inputId, code, name, city, country) {
            const airportInput = document.getElementById(inputId);
            const autocompleteContainer = document.getElementById(inputId.replace('Input', 'Autocomplete'));
            
            if (airportInput) {
                airportInput.value = `${code} - ${name}`;
                airportInput.setAttribute('data-airport-code', code);
                airportInput.setAttribute('data-airport-city', city);
                airportInput.setAttribute('data-airport-country', country);
                airportInput.focus();
                
                // Trigger title update if both airports are selected
                setTimeout(() => {
                    const originInput = document.getElementById('originAirportInput');
                    const destinationInput = document.getElementById('destinationAirportInput');
                    
                    if (originInput && destinationInput && 
                        originInput.getAttribute('data-airport-city') && 
                        destinationInput.getAttribute('data-airport-city')) {
                        
                        // Update the title preview in real-time
                        const originCity = originInput.getAttribute('data-airport-city');
                        const destinationCity = destinationInput.getAttribute('data-airport-city');
                        const titlePreview = `Vuelo desde ${originCity} hacia ${destinationCity}`;
                        
                        // You could add a preview element here if needed
                        console.log('Título sugerido:', titlePreview);
                    }
                }, 100);
            }
            
            if (autocompleteContainer) {
                autocompleteContainer.style.display = 'none';
            }
        }

        // Airline autocomplete functions
        function setupAirlineAutocomplete() {
            const airlineInput = document.getElementById('airline');
            if (!airlineInput) return;
            
            // Create autocomplete container
            let autocompleteContainer = document.getElementById('airlineAutocomplete');
            if (!autocompleteContainer) {
                autocompleteContainer = document.createElement('div');
                autocompleteContainer.id = 'airlineAutocomplete';
                autocompleteContainer.style.cssText = `
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 1px solid #ddd;
                    border-top: none;
                    max-height: 200px;
                    overflow-y: auto;
                    z-index: 1000;
                    display: none;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                `;
                airlineInput.parentNode.style.position = 'relative';
                airlineInput.parentNode.appendChild(autocompleteContainer);
            }
            
            airlineInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length < 2) {
                    autocompleteContainer.style.display = 'none';
                    return;
                }
                
                const matches = airlinesList.filter(airline => 
                    airline.toLowerCase().includes(query)
                ).slice(0, 10); // Limit to 10 results
                
                if (matches.length > 0) {
                    autocompleteContainer.innerHTML = matches.map(airline => 
                        `<div class="autocomplete-item" onclick="selectAirline('${airline}')">${airline}</div>`
                    ).join('');
                    autocompleteContainer.style.display = 'block';
                } else {
                    autocompleteContainer.style.display = 'none';
                }
            });
            
            // Hide autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!airlineInput.contains(e.target) && !autocompleteContainer.contains(e.target)) {
                    autocompleteContainer.style.display = 'none';
                }
            });
            
            // Handle keyboard navigation
            airlineInput.addEventListener('keydown', function(e) {
                const items = autocompleteContainer.querySelectorAll('.autocomplete-item');
                const currentIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (currentIndex < items.length - 1) {
                        items.forEach(item => item.classList.remove('selected'));
                        items[currentIndex + 1].classList.add('selected');
                    } else if (items.length > 0) {
                        items.forEach(item => item.classList.remove('selected'));
                        items[0].classList.add('selected');
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (currentIndex > 0) {
                        items.forEach(item => item.classList.remove('selected'));
                        items[currentIndex - 1].classList.add('selected');
                    } else if (items.length > 0) {
                        items.forEach(item => item.classList.remove('selected'));
                        items[items.length - 1].classList.add('selected');
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentIndex >= 0) {
                        selectAirline(items[currentIndex].textContent);
                    }
                } else if (e.key === 'Escape') {
                    autocompleteContainer.style.display = 'none';
                }
            });
        }
        
        function selectAirline(airline) {
            const airlineInput = document.getElementById('airline');
            const autocompleteContainer = document.getElementById('airlineAutocomplete');
            
            if (airlineInput) {
                airlineInput.value = airline;
                airlineInput.focus();
            }
            
            if (autocompleteContainer) {
                autocompleteContainer.style.display = 'none';
            }
        }

        function cleanupCorruptedData() {
            try {
                console.log('Starting data cleanup...');
                
                // Clean up localStorage
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('viantryp_')) {
                        try {
                            const data = localStorage.getItem(key);
                            if (data) {
                                JSON.parse(data); // Test if it's valid JSON
                            }
                        } catch (error) {
                            console.warn('Removing corrupted data:', key);
                            localStorage.removeItem(key);
                        }
                    }
                });
                
                // Clean up sessionStorage
                const sessionKeys = Object.keys(sessionStorage);
                sessionKeys.forEach(key => {
                    if (key.startsWith('viantryp_')) {
                        try {
                            const data = sessionStorage.getItem(key);
                            if (data) {
                                JSON.parse(data); // Test if it's valid JSON
                            }
                        } catch (error) {
                            console.warn('Removing corrupted session data:', key);
                            sessionStorage.removeItem(key);
                        }
                    }
                });
                
                // Remove duplicate trips and fix corrupted trip data
                try {
                    const savedTrips = JSON.parse(localStorage.getItem('viantryp_trips') || '[]');
                    if (savedTrips.length > 0) {
                        const uniqueTrips = [];
                        const seenIds = new Set();
                        
                        savedTrips.forEach(trip => {
                            if (trip && trip.id && !seenIds.has(trip.id)) {
                                // Fix corrupted trip data
                                const fixedTrip = {
                                    id: trip.id,
                                    title: trip.title || 'Viaje sin título',
                                    dates: trip.dates || 'Sin fecha',
                                    duration: trip.duration || 'Sin duración',
                                    status: trip.status || 'draft',
                                    startDate: trip.startDate || '',
                                    endDate: trip.endDate || '',
                                    itemsData: trip.itemsData || {},
                                    createdAt: trip.createdAt || new Date().toISOString(),
                                    updatedAt: trip.updatedAt || new Date().toISOString()
                                };
                                
                                seenIds.add(trip.id);
                                uniqueTrips.push(fixedTrip);
                            }
                        });
                        
                        if (uniqueTrips.length !== savedTrips.length) {
                            console.log('Removed duplicate trips:', savedTrips.length - uniqueTrips.length);
                            localStorage.setItem('viantryp_trips', JSON.stringify(uniqueTrips));
                        }
                        
                        console.log('Data cleanup completed. Total trips:', uniqueTrips.length);
                    }
                } catch (error) {
                    console.error('Error removing duplicates:', error);
                }
            } catch (error) {
                console.error('Error during data cleanup:', error);
            }
        }
    </script>
</body>
</html>